<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Criar Produto - Admin</title>

  <link rel="stylesheet" href="../public/css/style(OFC).css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="product-form.css">
  <script src="../public/js/config.js"></script>
  <style>
    /* CATEGORY SELECTOR STYLES */
    .category-selector-wrapper {
      position: relative;
      width: 100%;
    }

    .category-selector {
      width: 100%;
      position: relative;
    }

    .selected-category {
      padding: 14px 15px;
      background: rgba(11, 0, 21, 0.8);
      border: 1px solid rgba(124, 58, 237, 0.3);
      border-radius: 10px;
      color: #fff;
      font-size: 15px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
      min-height: 50px;
    }

    .selected-category:hover {
      border-color: #DF38FF;
    }

    .selected-category .placeholder {
      color: #666;
    }

    .selected-category .category-display {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .category-icon-small {
      font-size: 16px;
    }

    .category-dropdown {
      position: absolute;
      top: calc(100% + 5px);
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #1a002b, #0b0015);
      border: 1px solid rgba(124, 58, 237, 0.3);
      border-radius: 10px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      max-height: 400px;
      overflow-y: auto;
      display: none;
    }

    .category-dropdown.show {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .category-option {
      padding: 12px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 1px solid rgba(124, 58, 237, 0.1);
    }

    .category-option:hover {
      background: rgba(124, 58, 237, 0.1);
    }

    .category-option:last-child {
      border-bottom: none;
    }

    .category-option.create-category {
      background: linear-gradient(135deg, rgba(223, 56, 255, 0.1), rgba(124, 58, 237, 0.1));
      border-left: 3px solid #DF38FF;
    }

    .category-option-content {
      display: flex;
      align-items: center;
      gap: 12px;
      color: #fff;
    }

    .category-option i {
      color: #DF38FF;
    }

    .category-name {
      font-weight: 500;
    }

    .category-path {
      font-size: 12px;
      color: #aaa;
      margin-left: 10px;
    }

    .category-add-btn {
      background: rgba(124, 58, 237, 0.2);
      border: none;
      border-radius: 6px;
      width: 30px;
      height: 30px;
      color: #C084FC;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .category-add-btn:hover {
      background: rgba(124, 58, 237, 0.4);
      transform: scale(1.1);
    }

    /* Subcategorias */
    .subcategory {
      padding-left: 30px;
      position: relative;
    }

    .subcategory::before {
      content: '‚Ü≥';
      position: absolute;
      left: 15px;
      color: #7C3AED;
      font-weight: bold;
    }

    .loading-categories {
      padding: 20px;
      text-align: center;
      color: #aaa;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .no-categories {
      padding: 20px;
      text-align: center;
      color: #aaa;
    }

    /* Category Preview */
    .category-preview {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(124, 58, 237, 0.1);
      padding: 8px 12px;
      border-radius: 6px;
      margin-top: 8px;
      border: 1px solid rgba(124, 58, 237, 0.2);
    }

    .category-preview i {
      color: inherit;
    }

    .clear-category {
      margin-left: auto;
      background: transparent;
      border: none;
      color: #f44336;
      cursor: pointer;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.3s ease;
    }

    .clear-category:hover {
      background: rgba(244, 67, 54, 0.1);
    }

    /* Category Actions */
    .category-actions-container {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .btn-manage-categories {
      padding: 8px 15px;
      background: transparent;
      border: 1px solid rgba(124, 58, 237, 0.3);
      color: #C084FC;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-manage-categories:hover {
      background: rgba(124, 58, 237, 0.1);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>
  <div class="admin-wrapper">
    <!-- Sidebar simplificada -->
    <aside
      style="width: 70px; background: #0b0015; border-right: 1px solid rgba(124, 58, 237, 0.2); padding: 20px 0; display: flex; flex-direction: column; align-items: center; gap: 30px; position: fixed; height: 100vh; z-index: 100;">
      <a href="dashboard.html" style="color: #C084FC; font-size: 20px;">
        <i class="fas fa-tachometer-alt"></i>
      </a>
      <a href="products.html" style="color: #C084FC; font-size: 20px;">
        <i class="fas fa-cube"></i>
      </a>
      <a href="product-form.html" style="color: #DF38FF; font-size: 20px;">
        <i class="fas fa-plus-circle"></i>
      </a>
      <a href="categories.html" style="color: #C084FC; font-size: 20px;">
        <i class="fas fa-tags"></i>
      </a>
    </aside>

    <!-- Main Content -->
    <main class="admin-main" style="margin-left: 70px; padding: 30px; width: calc(100% - 70px);">

      <div class="form-container">
        <!-- Tabs -->
        <div class="form-tabs">
          <button class="tab-button active" data-tab="basic">
            <i class="fas fa-info-circle"></i>
            Informa√ß√µes B√°sicas
          </button>
          <button class="tab-button" data-tab="images">
            <i class="fas fa-images"></i>
            Imagens
          </button>
          <button class="tab-button" data-tab="variants">
            <i class="fas fa-palette"></i>
            Variantes
          </button>
          <button class="tab-button" data-tab="details">
            <i class="fas fa-align-left"></i>
            Detalhes
          </button>
          <button class="tab-button" data-tab="seo">
            <i class="fas fa-search"></i>
            SEO
          </button>
        </div>

        <!-- Tab Contents -->
        <form id="productForm" enctype="multipart/form-data">
          <!-- TAB 1: Informa√ß√µes B√°sicas -->
          <div class="tab-content active" id="basicTab">
            <div class="form-grid">
              <div class="form-group">
                <label class="label-required">Nome do Produto</label>
                <input type="text" class="form-control" id="productName" placeholder="Ex: Cr√¢nio T-Rex 3D" required>
                <div class="form-help">Nome completo do produto, como aparecer√° na loja</div>
              </div>

              <div class="form-group">
                <label class="label-required">Categoria</label>
                <div class="category-selector-wrapper">
                  <div class="category-selector" id="categorySelector">
                    <div class="selected-category" id="selectedCategory">
                      <span class="placeholder">Selecione uma categoria</span>
                      <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="category-dropdown" id="categoryDropdown">
                      <div class="category-option create-category" onclick="openCategoryForm()">
                        <div class="category-option-content">
                          <i class="fas fa-plus-circle"></i>
                          <span>Crie sua categoria</span>
                        </div>
                        <button class="category-add-btn" onclick="event.stopPropagation(); openCategoryForm();">
                          <i class="fas fa-plus"></i>
                        </button>
                      </div>
                      <div class="categories-list" id="categoriesList">
                        <!-- Categorias ser√£o carregadas aqui -->
                        <div class="loading-categories">
                          <i class="fas fa-spinner fa-spin"></i>
                          <span>Carregando categorias...</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <input type="hidden" id="categoryId" name="categoryId">
                </div>
                <div class="category-actions-container">
                  <button type="button" class="btn-manage-categories" onclick="openCategoryManager()">
                    <i class="fas fa-external-link-alt"></i>
                    Gerenciar Categorias
                  </button>
                  <button type="button" class="btn-manage-categories" onclick="clearCategorySelection()"
                    id="clearCategoryBtn" style="display: none;">
                    <i class="fas fa-times"></i>
                    Limpar Sele√ß√£o
                  </button>
                </div>
              </div>

              <div class="form-group">
                <label>SKU (C√≥digo do Produto)</label>
                <input type="text" class="form-control" id="productSku" placeholder="Ex: PROD-001">
                <div class="form-help">C√≥digo √∫nico para controle de estoque</div>
              </div>

              <div class="form-group">
                <label class="label-required">Pre√ßo</label>
                <div style="display: flex; gap: 10px;">
                  <input type="number" class="form-control" id="productPrice" placeholder="120.00" step="0.01" required
                    style="flex: 1;">
                  <select class="form-control" id="productCurrency" style="width: 100px;">
                    <option>R$</option>
                    <option>US$</option>
                    <option>‚Ç¨</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label>Pre√ßo Promocional</label>
                <input type="number" class="form-control" id="productPromoPrice" placeholder="150.00" step="0.01">
                <div class="form-help">Pre√ßo original para mostrar o desconto</div>
              </div>

              <div class="form-group">
                <label class="label-required">Estoque</label>
                <input type="number" class="form-control" id="productStock" placeholder="12" min="0" required>
                <div class="form-help">Quantidade dispon√≠vel em estoque</div>
              </div>
            </div>

            <div class="form-group">
              <label>Descri√ß√£o Curta</label>
              <textarea class="form-control" id="productShortDesc"
                placeholder="Breve descri√ß√£o do produto, mostrada nas listagens" maxlength="200"></textarea>
              <div class="form-help" style="text-align: right;">M√°ximo: 200 caracteres</div>
            </div>
          </div>

          <!-- TAB 2: Imagens -->
          <div class="tab-content" id="imagesTab">
            <div class="form-group">
              <label class="label-required">Imagem Principal</label>
              <div class="file-upload" id="mainImageUpload">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Clique para fazer upload da imagem principal</p>
                <small>Recomendado: 1200x1200px, JPG ou PNG, m√°ximo 5MB</small>
              </div>
              <div id="mainImagePreview" style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px;"></div>
            </div>

            <div class="form-group">
              <label>Galeria de Imagens</label>
              <div class="file-upload" id="galleryUpload">
                <i class="fas fa-images"></i>
                <p>Clique ou arraste para adicionar imagens √† galeria</p>
                <small>Voc√™ pode selecionar m√∫ltiplas imagens</small>
              </div>
              <div id="imagePreview" class="image-gallery"
                style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px;"></div>
            </div>
          </div>

          <!-- TAB 3: Variantes -->
          <div class="tab-content" id="variantsTab">
            <div class="variants-section">
              <h3><i class="fas fa-palette"></i> Op√ß√µes de Personaliza√ß√£o</h3>

              <!-- Tamanhos -->
              <div class="form-group">
                <label>Tamanhos Dispon√≠veis</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                  <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" class="size-checkbox" data-size="Pequeno">
                    <span>Pequeno (15cm)</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" class="size-checkbox" data-size="M√©dio" checked>
                    <span>M√©dio (25cm)</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" class="size-checkbox" data-size="Grande">
                    <span>Grande (35cm)</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" class="size-checkbox" data-size="Gigante">
                    <span>Gigante (50cm)</span>
                  </label>
                </div>
              </div>

              <!-- Cores -->
              <div class="form-group">
                <label>Cores do Filamento</label>
                <div class="color-picker" style="display: flex; gap: 10px; flex-wrap: wrap;">
                  <div class="color-option selected"
                    style="background: #8B7355; width: 30px; height: 30px; border-radius: 50%; cursor: pointer;"
                    title="Marrom Pedra"></div>
                  <div class="color-option"
                    style="background: #A0522D; width: 30px; height: 30px; border-radius: 50%; cursor: pointer;"
                    title="Terra Queimada"></div>
                  <div class="color-option"
                    style="background: #808080; width: 30px; height: 30px; border-radius: 50%; cursor: pointer;"
                    title="Cinza Fosco"></div>
                  <div class="color-option"
                    style="background: #2F4F4F; width: 30px; height: 30px; border-radius: 50%; cursor: pointer;"
                    title="Verde Escuro"></div>
                  <div class="color-option"
                    style="background: #000000; width: 30px; height: 30px; border-radius: 50%; cursor: pointer;"
                    title="Preto Profundo"></div>
                </div>
                <input type="hidden" id="selectedColor" value="Marrom Pedra">
              </div>

              <!-- Pre√ßos por variante -->
              <div class="form-group">
                <label>Pre√ßos por Tamanho</label>
                <div style="background: rgba(26, 0, 43, 0.5); border-radius: 10px; padding: 20px;">
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                      <label style="display: block; margin-bottom: 8px; font-size: 13px;">Pequeno</label>
                      <input type="number" class="form-control size-price" data-size="Pequeno" placeholder="80.00"
                        step="0.01">
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 8px; font-size: 13px;">M√©dio</label>
                      <input type="number" class="form-control size-price" data-size="M√©dio" placeholder="120.00"
                        step="0.01">
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 8px; font-size: 13px;">Grande</label>
                      <input type="number" class="form-control size-price" data-size="Grande" placeholder="180.00"
                        step="0.01">
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 8px; font-size: 13px;">Gigante</label>
                      <input type="number" class="form-control size-price" data-size="Gigante" placeholder="250.00"
                        step="0.01">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <button type="button" class="btn-add-variant" id="addVariantBtn">
              <i class="fas fa-plus"></i>
              Adicionar Outra Op√ß√£o (Material, Textura, etc.)
            </button>
          </div>

          <!-- TAB 4: Detalhes -->
          <div class="tab-content" id="detailsTab">
            <div class="form-group">
              <label class="label-required">Descri√ß√£o Detalhada</label>
              <div class="rich-text-editor">
                <div class="editor-toolbar">
                  <button type="button" class="editor-btn" data-command="bold">
                    <i class="fas fa-bold"></i>
                  </button>
                  <button type="button" class="editor-btn" data-command="italic">
                    <i class="fas fa-italic"></i>
                  </button>
                  <button type="button" class="editor-btn" data-command="underline">
                    <i class="fas fa-underline"></i>
                  </button>
                  <div style="width: 1px; background: rgba(124, 58, 237, 0.2); margin: 0 5px;"></div>
                  <button type="button" class="editor-btn" data-command="insertUnorderedList">
                    <i class="fas fa-list-ul"></i>
                  </button>
                  <button type="button" class="editor-btn" data-command="insertOrderedList">
                    <i class="fas fa-list-ol"></i>
                  </button>
                </div>
                <div class="editor-content" id="productDescription" contenteditable="true"></div>
              </div>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label>Especifica√ß√µes T√©cnicas</label>
                <div style="background: rgba(26, 0, 43, 0.5); border-radius: 10px; padding: 20px;">
                  <div id="specifications">
                    <!-- Especifica√ß√µes ser√£o adicionadas aqui -->
                  </div>
                  <button type="button" id="addSpecBtn"
                    style="margin-top: 10px; padding: 8px 15px; background: rgba(124, 58, 237, 0.1); border: 1px dashed rgba(124, 58, 237, 0.3); color: #C084FC; border-radius: 6px; width: 100%; cursor: pointer;">
                    <i class="fas fa-plus"></i> Adicionar Especifica√ß√£o
                  </button>
                </div>
              </div>

              <div class="form-group">
                <label>Informa√ß√µes de Envio</label>
                <div style="background: rgba(26, 0, 43, 0.5); border-radius: 10px; padding: 20px;">
                  <div style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                      <input type="checkbox" id="isPhysical" checked>
                      <span>Produto f√≠sico (requer envio)</span>
                    </label>
                  </div>
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                      <label style="display: block; margin-bottom: 8px; font-size: 13px;">Peso (kg)</label>
                      <input type="number" class="form-control" id="productWeight" placeholder="0.45" step="0.01">
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 8px; font-size: 13px;">Dimens√µes (cm)</label>
                      <input type="text" class="form-control" id="productDimensions" placeholder="25x18x15">
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 8px; font-size: 13px;">Tempo de Produ√ß√£o</label>
                      <input type="text" class="form-control" id="productionTime" placeholder="3-5 dias">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="toggle-switch" style="margin-top: 20px;">
              <label class="switch">
                <input type="checkbox" id="productActive" checked>
                <span class="slider"></span>
              </label>
              <span>Dispon√≠vel para venda</span>
            </div>

            <div class="toggle-switch">
              <label class="switch">
                <input type="checkbox" id="productFeatured">
                <span class="slider"></span>
              </label>
              <span>Destacar como produto em destaque</span>
            </div>

            <div class="toggle-switch">
              <label class="switch">
                <input type="checkbox" id="allowReviews" checked>
                <span class="slider"></span>
              </label>
              <span>Permitir avalia√ß√µes do produto</span>
            </div>
          </div>

          <!-- TAB 5: SEO -->
          <div class="tab-content" id="seoTab">
            <div class="form-group">
              <label>T√≠tulo SEO</label>
              <input type="text" class="form-control" id="seoTitle"
                placeholder="Cr√¢nio T-Rex 3D - Universo Paralelo Store">
              <div class="form-help">T√≠tulo que aparecer√° nos resultados de busca (recomendado: 50-60 caracteres)</div>
            </div>

            <div class="form-group">
              <label>Meta Descri√ß√£o</label>
              <textarea class="form-control" id="seoDescription" placeholder="Descri√ß√£o para os mecanismos de busca"
                rows="3"></textarea>
              <div class="form-help">Descri√ß√£o que aparecer√° nos resultados de busca (recomendado: 150-160 caracteres)
              </div>
            </div>

            <div class="form-group">
              <label>URL Amig√°vel (Slug)</label>
              <input type="text" class="form-control" id="productSlug" placeholder="cranio-t-rex-3d">
              <div class="form-help">URL limpa para o produto (ex: seu-site.com/produtos/cranio-t-rex-3d)</div>
            </div>

            <div class="form-group">
              <label>Palavras-chave</label>
              <input type="text" class="form-control" id="productKeywords"
                placeholder="escultura 3d, t-rex, dinossauro, decora√ß√£o, impress√£o 3d">
              <div class="form-help">Separe por v√≠rgulas as palavras-chave relevantes</div>
            </div>

            <div class="seo-preview">
              <h4>Pr√©-visualiza√ß√£o do Resultado de Busca</h4>
              <div class="preview-item">
                <div class="preview-title" id="previewTitle">Cr√¢nio T-Rex 3D - Universo Paralelo Store</div>
                <div class="preview-url" id="previewUrl">https://universoparalelo.com/produtos/cranio-t-rex-3d</div>
                <div class="preview-description" id="previewDescription">Esta impressionante r√©plica do cr√¢nio do T-Rex
                  √© perfeita para apaixonados por paleontologia e decora√ß√£o √∫nica.</div>
              </div>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <a href="products.html" class="btn-cancel">
              <i class="fas fa-times"></i>
              Cancelar
            </a>
            <button type="button" class="btn-save" id="saveDraftBtn">
              <i class="far fa-save"></i>
              Salvar Rascunho
            </button>
            <button type="submit" class="btn-save" id="submitBtn">
              <i class="fas fa-rocket"></i>
              Publicar Produto
            </button>
          </div>
        </form>
      </div>
    </main>
  </div>

  <script>
    // ============================================
    // ===== CONFIGURA√á√ÉO DA API =====
    // ============================================
    const IS_LOCALHOST = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const API_BASE_URL = IS_LOCALHOST ? 'http://localhost:5000/api' : 'https://upuniversestorege.onrender.com/api';

    console.log('üöÄ API Base URL:', API_BASE_URL);

    // ============================================
    // ===== API CLIENT =====
    // ============================================
    window.ProductAPI = {
      API_BASE_URL: API_BASE_URL,

      async request(endpoint, options = {}, timeout = 30000) {
        const url = endpoint.startsWith('http') ? endpoint : `${API_BASE_URL}${endpoint}`;
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);

        try {
          console.log(`üì° ${options.method || 'GET'} ${url}`);
          const response = await fetch(url, {
            ...options,
            signal: controller.signal
          });
          clearTimeout(timeoutId);

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
          }

          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            return await response.json();
          }
          return await response.text();
        } catch (error) {
          clearTimeout(timeoutId);
          console.error(`‚ùå Erro na requisi√ß√£o ${url}:`, error);
          throw error;
        }
      },

      // ===== CATEGORIAS =====
      async getAllCategories() {
        try {
          const data = await this.request('/categories');
          return data.categories || [];
        } catch (error) {
          console.error('‚ùå Erro ao buscar categorias:', error);
          return [];
        }
      },

      // ===== PRODUTOS =====
      async getProductById(id) {
        try {
          const data = await this.request(`/products/${id}`);
          return data.product || null;
        } catch (error) {
          console.error(`‚ùå Erro ao buscar produto ${id}:`, error);
          return null;
        }
      },

      async createProduct(formData) {
        try {
          console.log('üì§ Criando produto...');
          const result = await this.request('/products', {
            method: 'POST',
            body: formData
          });
          return result;
        } catch (error) {
          console.error('‚ùå Erro ao criar produto:', error);
          return { success: false, error: error.message };
        }
      },

      async updateProduct(id, formData) {
        try {
          console.log(`üì§ Atualizando produto ${id}...`);
          const result = await this.request(`/products/${id}`, {
            method: 'PUT',
            body: formData
          });
          return result;
        } catch (error) {
          console.error(`‚ùå Erro ao atualizar produto ${id}:`, error);
          return { success: false, error: error.message };
        }
      },

      async deleteProduct(id) {
        try {
          const result = await this.request(`/products/${id}`, {
            method: 'DELETE'
          });
          return result;
        } catch (error) {
          console.error(`‚ùå Erro ao deletar produto ${id}:`, error);
          return { success: false, error: error.message };
        }
      },

      async getAllProducts(filters = {}) {
        try {
          const params = new URLSearchParams();
          if (filters.category) params.append('category', filters.category);
          if (filters.category_id) params.append('category_id', filters.category_id);
          if (filters.status) params.append('status', filters.status);
          if (filters.featured) params.append('featured', filters.featured);
          if (filters.search) params.append('search', filters.search);
          if (filters.limit) params.append('limit', filters.limit);

          const query = params.toString() ? `?${params.toString()}` : '';
          const data = await this.request(`/products${query}`);
          return data.products || [];
        } catch (error) {
          console.error('‚ùå Erro ao buscar produtos:', error);
          return [];
        }
      }
    };

    // ============================================
    // ===== FUN√á√ïES DE NOTIFICA√á√ÉO =====
    // ============================================
    function showNotification(message, type = 'info') {
      console.log(`üì¢ [${type}]: ${message}`);

      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #1a002b, #0b0015);
        border: 2px solid ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#7C3AED'};
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 15px;
        z-index: 10000;
        animation: slideIn 0.3s ease;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        max-width: 400px;
      `;

      const icon = type === 'success' ? 'check-circle' :
        type === 'error' ? 'exclamation-circle' :
          type === 'warning' ? 'exclamation-triangle' : 'info-circle';

      notification.innerHTML = `
        <i class="fas fa-${icon}" style="color: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#7C3AED'}; font-size: 20px;"></i>
        <span>${message}</span>
      `;

      document.body.appendChild(notification);
      setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    // ============================================
    // ===== CATEGORY SELECTOR FUNCTIONS =====
    // ============================================
    let allCategories = [];

    async function loadCategories() {
      try {
        console.log("üì• Carregando categorias...");
        allCategories = await ProductAPI.getAllCategories();
        console.log(`‚úÖ ${allCategories.length} categorias carregadas`);
        renderCategories();
      } catch (error) {
        console.error("‚ùå Erro ao carregar categorias:", error);
        showNotification('Erro ao carregar categorias', 'error');
      }
    }

    function renderCategories() {
      const categoriesList = document.getElementById('categoriesList');
      if (!categoriesList) return;

      if (allCategories.length === 0) {
        categoriesList.innerHTML = `
          <div class="no-categories">
            <i class="fas fa-tags"></i>
            <p>Nenhuma categoria criada</p>
          </div>
        `;
        return;
      }

      let html = '';
      const mainCategories = allCategories.filter(cat => !cat.parent_id);
      const subCategories = allCategories.filter(cat => cat.parent_id);

      mainCategories.forEach(category => {
        html += createCategoryItem(category);

        const categorySubCategories = subCategories.filter(sub => sub.parent_id == category.id);
        categorySubCategories.forEach(subCategory => {
          html += createCategoryItem(subCategory, true);
        });
      });

      categoriesList.innerHTML = html;
    }

    function createCategoryItem(category, isSubcategory = false) {
      const parent = category.parent_id ? allCategories.find(c => c.id == category.parent_id) : null;
      const icon = category.icon ?
        (category.icon.includes('fa-') ? `<i class="fas ${category.icon}"></i>` : `<span>${category.icon}</span>`) :
        '<i class="fas fa-tag"></i>';
      const color = category.color || '#C084FC';

      return `
        <div class="category-option ${isSubcategory ? 'subcategory' : ''}" 
             onclick="selectCategory(${category.id})"
             data-category-id="${category.id}">
          <div class="category-option-content" style="color: ${color}">
            ${icon}
            <div>
              <div class="category-name">${category.name}</div>
              ${parent ? `<div class="category-path">${parent.name}</div>` : ''}
            </div>
          </div>
        </div>
      `;
    }

    window.selectCategory = function (categoryId) {
      const category = allCategories.find(c => c.id == categoryId);
      if (!category) {
        showNotification('Categoria n√£o encontrada!', 'error');
        return;
      }

      const selectedCategory = document.getElementById('selectedCategory');
      const categoryIdInput = document.getElementById('categoryId');
      const clearBtn = document.getElementById('clearCategoryBtn');

      if (selectedCategory) {
        const icon = category.icon ?
          (category.icon.includes('fa-') ? `<i class="fas ${category.icon}"></i>` : `<span>${category.icon}</span>`) :
          '<i class="fas fa-tag"></i>';

        const parent = category.parent_id ? allCategories.find(c => c.id == category.parent_id) : null;

        selectedCategory.innerHTML = `
          <div class="category-display" style="color: ${category.color || '#C084FC'}">
            ${icon}
            <div>
              <div><strong>${category.name}</strong></div>
              ${parent ? `<div style="font-size: 12px; color: #aaa;">${parent.name}</div>` : ''}
            </div>
          </div>
          <i class="fas fa-chevron-down"></i>
        `;
      }

      if (categoryIdInput) {
        categoryIdInput.value = category.id;
      }

      if (clearBtn) clearBtn.style.display = 'flex';
      hideCategoryDropdown();
      showNotification(`Categoria: ${category.name}`, 'success');
    };

    window.clearCategorySelection = function () {
      const selectedCategory = document.getElementById('selectedCategory');
      const categoryIdInput = document.getElementById('categoryId');
      const clearBtn = document.getElementById('clearCategoryBtn');

      if (selectedCategory) {
        selectedCategory.innerHTML = `
          <span class="placeholder">Selecione uma categoria</span>
          <i class="fas fa-chevron-down"></i>
        `;
      }

      if (categoryIdInput) categoryIdInput.value = '';
      if (clearBtn) clearBtn.style.display = 'none';
      showNotification('Categoria removida', 'info');
    };

    function toggleCategoryDropdown() {
      const dropdown = document.getElementById('categoryDropdown');
      if (dropdown) {
        if (dropdown.classList.contains('show')) {
          hideCategoryDropdown();
        } else {
          showCategoryDropdown();
        }
      }
    }

    function showCategoryDropdown() {
      const dropdown = document.getElementById('categoryDropdown');
      if (dropdown) {
        dropdown.classList.add('show');
        setTimeout(() => {
          document.addEventListener('click', closeDropdownOnClickOutside);
        }, 10);
      }
    }

    function hideCategoryDropdown() {
      const dropdown = document.getElementById('categoryDropdown');
      if (dropdown) {
        dropdown.classList.remove('show');
        document.removeEventListener('click', closeDropdownOnClickOutside);
      }
    }

    function closeDropdownOnClickOutside(event) {
      const selector = document.getElementById('categorySelector');
      const dropdown = document.getElementById('categoryDropdown');
      if (selector && !selector.contains(event.target) && dropdown) {
        hideCategoryDropdown();
      }
    }

    window.openCategoryForm = function () {
      window.location.href = 'categories.html';
    };

    window.openCategoryManager = function () {
      window.location.href = 'categories.html';
    };

    // ============================================
    // ===== FUN√á√ïES DE UPLOAD DE IMAGENS =====
    // ============================================
    function setupImageUploads() {
      const mainImageUpload = document.getElementById('mainImageUpload');
      const galleryUpload = document.getElementById('galleryUpload');
      const mainImagePreview = document.getElementById('mainImagePreview');
      const imageGallery = document.getElementById('imagePreview');

      // Upload de imagem principal
      if (mainImageUpload) {
        let mainImageInput = null;

        mainImageUpload.addEventListener('click', function () {
          if (!mainImageInput) {
            mainImageInput = document.createElement('input');
            mainImageInput.type = 'file';
            mainImageInput.accept = 'image/*';
            mainImageInput.style.display = 'none';
            mainImageUpload.appendChild(mainImageInput);

            mainImageInput.onchange = function (e) {
              const file = e.target.files[0];
              if (file) {
                if (!file.type.match('image/(jpeg|jpg|png|gif|webp)')) {
                  showNotification('Formato n√£o suportado! Use JPG, PNG ou GIF.', 'error');
                  return;
                }
                if (file.size > 5 * 1024 * 1024) {
                  showNotification('Imagem muito grande! M√°ximo 5MB.', 'error');
                  return;
                }

                const reader = new FileReader();
                reader.onload = function (event) {
                  mainImagePreview.innerHTML = `
                    <div class="preview-item" style="position: relative;">
                      <img src="${event.target.result}" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                      <button type="button" onclick="removeMainImage()" 
                              style="position: absolute; top: 5px; right: 5px; background: rgba(244,67,54,0.8); border: none; color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer;">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  `;
                };
                reader.readAsDataURL(file);
              }
            };
          }
          mainImageInput.click();
        });
      }

      // Upload de galeria
      if (galleryUpload) {
        let galleryInput = null;

        galleryUpload.addEventListener('click', function () {
          if (!galleryInput) {
            galleryInput = document.createElement('input');
            galleryInput.type = 'file';
            galleryInput.accept = 'image/*';
            galleryInput.multiple = true;
            galleryInput.style.display = 'none';
            galleryUpload.appendChild(galleryInput);

            galleryInput.onchange = function (e) {
              Array.from(e.target.files).forEach(file => {
                if (!file.type.match('image/(jpeg|jpg|png|gif|webp)')) {
                  showNotification(`Arquivo "${file.name}" n√£o √© uma imagem v√°lida!`, 'error');
                  return;
                }
                if (file.size > 5 * 1024 * 1024) {
                  showNotification(`Imagem "${file.name}" muito grande! M√°ximo 5MB.`, 'error');
                  return;
                }

                const reader = new FileReader();
                reader.onload = function (event) {
                  const div = document.createElement('div');
                  div.className = 'preview-item';
                  div.style.position = 'relative';
                  div.innerHTML = `
                    <img src="${event.target.result}" alt="Gallery" style="max-width: 150px; max-height: 150px; border-radius: 8px;">
                    <button type="button" onclick="this.parentElement.remove()" 
                            style="position: absolute; top: 5px; right: 5px; background: rgba(244,67,54,0.8); border: none; color: white; width: 25px; height: 25px; border-radius: 50%; cursor: pointer;">
                      <i class="fas fa-times"></i>
                    </button>
                  `;
                  imageGallery.appendChild(div);
                };
                reader.readAsDataURL(file);
              });
            };
          }
          galleryInput.click();
        });
      }
    }

    window.removeMainImage = function () {
      const mainImagePreview = document.getElementById('mainImagePreview');
      const mainImageUpload = document.getElementById('mainImageUpload');
      const input = mainImageUpload.querySelector('input[type="file"]');
      if (input) input.value = '';
      if (mainImagePreview) mainImagePreview.innerHTML = '';
    };

    // ============================================
    // ===== PREPARAR FORMDATA =====
    // ============================================
    function prepareFormData() {
      const formData = new FormData();

      // Informa√ß√µes B√°sicas
      const name = document.getElementById('productName')?.value;
      const price = document.getElementById('productPrice')?.value;
      const stock = document.getElementById('productStock')?.value;
      const categoryId = document.getElementById('categoryId')?.value;
      const sku = document.getElementById('productSku')?.value;
      const promoPrice = document.getElementById('productPromoPrice')?.value;
      const shortDesc = document.getElementById('productShortDesc')?.value;

      if (!name) throw new Error('Nome do produto √© obrigat√≥rio');
      if (!price || parseFloat(price) <= 0) throw new Error('Pre√ßo deve ser maior que zero');
      if (!categoryId) throw new Error('Selecione uma categoria');

      formData.append('name', name.trim());
      formData.append('price', parseFloat(price));
      formData.append('stock', parseInt(stock) || 0);
      formData.append('category_id', parseInt(categoryId));
      if (sku) formData.append('sku', sku.trim());
      if (promoPrice) formData.append('promotional_price', parseFloat(promoPrice));
      if (shortDesc) formData.append('short_description', shortDesc.trim());

      // Nome da categoria para compatibilidade
      const category = allCategories.find(c => c.id == categoryId);
      if (category) formData.append('category', category.name);

      // Imagem principal
      const mainImageInput = document.querySelector('#mainImageUpload input[type="file"]');
      if (mainImageInput && mainImageInput.files[0]) {
        formData.append('main_image', mainImageInput.files[0]);
      }

      // Galeria
      const galleryInput = document.querySelector('#galleryUpload input[type="file"]');
      if (galleryInput && galleryInput.files) {
        for (let i = 0; i < galleryInput.files.length; i++) {
          formData.append('gallery_images', galleryInput.files[i]);
        }
      }

      // Descri√ß√£o
      const description = document.getElementById('productDescription')?.innerHTML || '';
      formData.append('description', description);

      // Variantes
      const variants = { sizes: [], colors: [] };

      document.querySelectorAll('.size-checkbox:checked').forEach(cb => {
        const size = cb.getAttribute('data-size');
        const priceInput = document.querySelector(`.size-price[data-size="${size}"]`);
        variants.sizes.push({
          size: size,
          price: priceInput ? parseFloat(priceInput.value) || null : null
        });
      });

      const selectedColor = document.querySelector('.color-option.selected');
      if (selectedColor) {
        variants.colors = [selectedColor.getAttribute('title') || 'Cor padr√£o'];
      }
      formData.append('variants', JSON.stringify(variants));

      // Especifica√ß√µes
      const specifications = [];
      document.querySelectorAll('#specifications > div').forEach(spec => {
        const inputs = spec.querySelectorAll('input');
        if (inputs.length >= 2 && inputs[0].value && inputs[1].value) {
          specifications.push({
            key: inputs[0].value.trim(),
            value: inputs[1].value.trim()
          });
        }
      });
      formData.append('specifications', JSON.stringify(specifications));

      // Informa√ß√µes de envio
      const weight = document.getElementById('productWeight')?.value;
      const dimensions = document.getElementById('productDimensions')?.value;
      const productionTime = document.getElementById('productionTime')?.value;
      const isPhysical = document.getElementById('isPhysical')?.checked;

      const shippingInfo = {
        is_physical: isPhysical !== undefined ? isPhysical : true,
        weight_kg: weight ? parseFloat(weight) : 0,
        dimensions_cm: dimensions || '',
        production_time: productionTime || ''
      };
      formData.append('shipping_info', JSON.stringify(shippingInfo));
      if (dimensions) formData.append('dimensions', dimensions);
      if (weight) formData.append('weight', weight);

      // Material
      const materialSpec = specifications.find(s =>
        s.key && s.key.toLowerCase().includes('material')
      );
      if (materialSpec) formData.append('material', materialSpec.value);

      // Status
      const isActive = document.getElementById('productActive')?.checked;
      const isFeatured = document.getElementById('productFeatured')?.checked;
      const allowReviews = document.getElementById('allowReviews')?.checked;

      formData.append('status', isActive ? 'active' : 'inactive');
      formData.append('featured', isFeatured ? 1 : 0);

      const settings = { allow_reviews: allowReviews !== undefined ? allowReviews : true };
      formData.append('settings', JSON.stringify(settings));

      // SEO
      const seoTitle = document.getElementById('seoTitle')?.value;
      const seoDesc = document.getElementById('seoDescription')?.value;
      const slug = document.getElementById('productSlug')?.value;
      const keywords = document.getElementById('productKeywords')?.value;

      const seo = {
        title: seoTitle || '',
        description: seoDesc || '',
        slug: slug || '',
        keywords: keywords ? keywords.split(',').map(k => k.trim()).filter(k => k) : []
      };
      formData.append('seo', JSON.stringify(seo));

      return formData;
    }

    // ============================================
    // ===== CARREGAR PRODUTO PARA EDI√á√ÉO =====
    // ============================================
    async function loadProductForEdit(productId) {
      try {
        console.log(`üì• Carregando produto ${productId}...`);
        showNotification('Carregando produto...', 'info');

        const product = await ProductAPI.getProductById(productId);
        if (!product) {
          showNotification('Produto n√£o encontrado!', 'error');
          window.location.href = 'products.html';
          return;
        }

        console.log('‚úÖ Produto carregado:', product);

        // Informa√ß√µes B√°sicas
        document.getElementById('productName').value = product.name || '';
        document.getElementById('productPrice').value = product.price || '';
        document.getElementById('productStock').value = product.stock || 0;
        document.getElementById('productShortDesc').value = product.short_description || '';
        document.getElementById('productSku').value = product.sku || '';
        if (product.promotional_price) {
          document.getElementById('productPromoPrice').value = product.promotional_price;
        }

        // Categoria
        if (product.category_id) {
          const category = allCategories.find(c => c.id == product.category_id);
          if (category) {
            setTimeout(() => selectCategory(category.id), 500);
          }
        }

        // Imagens
        setTimeout(() => {
          if (product.image_url) {
            const mainImagePreview = document.getElementById('mainImagePreview');
            let imageUrl = product.image_url;
            if (!imageUrl.startsWith('http')) {
              imageUrl = `https://upuniversestorege.onrender.com${imageUrl}`;
            }
            mainImagePreview.innerHTML = `
              <div class="preview-item">
                <img src="${imageUrl}" alt="${product.name}" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                <p style="font-size: 12px; color: #aaa; margin-top: 5px;">Imagem atual</p>
              </div>
            `;
          }
        }, 500);

        // Descri√ß√£o
        if (product.description) {
          document.getElementById('productDescription').innerHTML = product.description;
        }

        // Status
        document.getElementById('productActive').checked = product.status === 'active';
        document.getElementById('productFeatured').checked = product.featured === true;
        if (product.settings) {
          document.getElementById('allowReviews').checked = product.settings.allow_reviews !== false;
        }

        // Informa√ß√µes de envio
        if (product.shipping_info) {
          document.getElementById('isPhysical').checked = product.shipping_info.is_physical !== false;
          if (product.shipping_info.weight_kg) {
            document.getElementById('productWeight').value = product.shipping_info.weight_kg;
          }
          if (product.shipping_info.dimensions_cm) {
            document.getElementById('productDimensions').value = product.shipping_info.dimensions_cm;
          }
          if (product.shipping_info.production_time) {
            document.getElementById('productionTime').value = product.shipping_info.production_time;
          }
        } else {
          if (product.weight) document.getElementById('productWeight').value = product.weight;
          if (product.dimensions) document.getElementById('productDimensions').value = product.dimensions;
        }

        // SEO
        if (product.seo) {
          document.getElementById('seoTitle').value = product.seo.title || '';
          document.getElementById('seoDescription').value = product.seo.description || '';
          document.getElementById('productSlug').value = product.seo.slug || '';
          if (product.seo.keywords) {
            document.getElementById('productKeywords').value = Array.isArray(product.seo.keywords)
              ? product.seo.keywords.join(', ')
              : product.seo.keywords;
          }
        }

        // Especifica√ß√µes
        if (product.specifications && product.specifications.length > 0) {
          const specsContainer = document.getElementById('specifications');
          specsContainer.innerHTML = '';
          product.specifications.forEach(spec => {
            addSpecification(spec.key, spec.value);
          });
        }

        showNotification('Produto carregado!', 'success');
      } catch (error) {
        console.error('‚ùå Erro ao carregar produto:', error);
        showNotification('Erro ao carregar produto', 'error');
      }
    }

    // ============================================
    // ===== FUN√á√ïES AUXILIARES =====
    // ============================================
    function addSpecification(key = '', value = '') {
      const specsContainer = document.getElementById('specifications');
      const newSpec = document.createElement('div');
      newSpec.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
      newSpec.innerHTML = `
        <input type="text" class="form-control" placeholder="Ex: Material" value="${key}">
        <input type="text" class="form-control" placeholder="Ex: PLA Premium" value="${value}">
        <button type="button" class="remove-spec" style="background: transparent; border: 1px solid rgba(124, 58, 237, 0.3); color: #f44336; border-radius: 6px; width: 40px; cursor: pointer;">
          <i class="fas fa-times"></i>
        </button>
      `;
      specsContainer.appendChild(newSpec);

      newSpec.querySelector('.remove-spec').addEventListener('click', () => newSpec.remove());
    }

    function updateSeoPreview() {
      const title = document.getElementById('seoTitle')?.value || 'Cr√¢nio T-Rex 3D - Universo Paralelo Store';
      const slug = document.getElementById('productSlug')?.value || 'cranio-t-rex-3d';
      const desc = document.getElementById('seoDescription')?.value || 'Esta impressionante r√©plica do cr√¢nio do T-Rex √© perfeita para apaixonados por paleontologia e decora√ß√£o √∫nica.';

      document.getElementById('previewTitle').textContent = title;
      document.getElementById('previewUrl').textContent = `https://universoparalelo.com/produtos/${slug}`;
      document.getElementById('previewDescription').textContent = desc.substring(0, 160) + '...';
    }

    // ============================================
    // ===== INICIALIZA√á√ÉO =====
    // ============================================
    document.addEventListener('DOMContentLoaded', async function () {
      console.log('üì± Inicializando formul√°rio de produtos...');

      // Verificar login
      const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
      if (!isLoggedIn) {
        window.location.href = 'login.html';
        return;
      }

      // Verificar se √© edi√ß√£o
      const urlParams = new URLSearchParams(window.location.search);
      const editProductId = urlParams.get('edit');
      let isEditing = false;
      let currentProductId = null;

      if (editProductId) {
        isEditing = true;
        currentProductId = parseInt(editProductId);
        document.title = "Editar Produto - Admin";

        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
          submitBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Altera√ß√µes';
        }
      }

      // Configurar tabs
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabContents = document.querySelectorAll('.tab-content');

      tabButtons.forEach(button => {
        button.addEventListener('click', function () {
          const tabId = this.getAttribute('data-tab');
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabContents.forEach(content => content.classList.remove('active'));
          this.classList.add('active');
          const tabElement = document.getElementById(`${tabId}Tab`);
          if (tabElement) tabElement.classList.add('active');
        });
      });

      // Configurar categoria selector
      const selectedCategory = document.getElementById('selectedCategory');
      if (selectedCategory) {
        selectedCategory.addEventListener('click', toggleCategoryDropdown);
      }

      // Carregar categorias
      await loadCategories();

      // Se for edi√ß√£o, carregar produto
      if (isEditing && currentProductId) {
        await loadProductForEdit(currentProductId);
      }

      // Configurar upload de imagens
      setupImageUploads();

      // Configurar especifica√ß√µes
      const addSpecBtn = document.getElementById('addSpecBtn');
      if (addSpecBtn) {
        addSpecBtn.addEventListener('click', () => addSpecification());
      }

      // Configurar cores
      document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function () {
          document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
          this.classList.add('selected');
          document.getElementById('selectedColor').value = this.getAttribute('title') || '';
        });
      });

      // Configurar preview SEO
      ['seoTitle', 'productSlug', 'seoDescription'].forEach(id => {
        document.getElementById(id)?.addEventListener('input', updateSeoPreview);
      });

      // Gerar slug automaticamente
      document.getElementById('productName')?.addEventListener('input', function () {
        const slugInput = document.getElementById('productSlug');
        if (!isEditing && slugInput && !slugInput.value) {
          slugInput.value = this.value
            .toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .replace(/[^\w\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .trim();
          updateSeoPreview();
        }
      });

      // Gerar SKU autom√°tico
      document.getElementById('productName')?.addEventListener('blur', function () {
        const skuInput = document.getElementById('productSku');
        if (skuInput && !skuInput.value) {
          const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
          skuInput.value = `PROD-${randomNum}`;
        }
      });

      // Submiss√£o do formul√°rio
      const productForm = document.getElementById('productForm');
      if (productForm) {
        productForm.addEventListener('submit', async function (e) {
          e.preventDefault();

          if (this.hasAttribute('data-submitting') && this.getAttribute('data-submitting') === 'true') {
            console.log('‚è≥ Requisi√ß√£o j√° em andamento');
            return;
          }
          this.setAttribute('data-submitting', 'true');

          const submitBtn = document.getElementById('submitBtn');
          const originalHTML = submitBtn.innerHTML;
          submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
          submitBtn.disabled = true;

          try {
            const formData = prepareFormData();

            let result;
            if (isEditing && currentProductId) {
              result = await ProductAPI.updateProduct(currentProductId, formData);
            } else {
              result = await ProductAPI.createProduct(formData);
            }

            if (result.success) {
              showNotification(`‚úÖ Produto ${isEditing ? 'atualizado' : 'criado'} com sucesso!`, 'success');
              setTimeout(() => {
                window.location.href = 'products.html';
              }, 2000);
            } else {
              showNotification(`‚ùå Erro: ${result.error || 'Falha ao processar'}`, 'error');
              submitBtn.innerHTML = originalHTML;
              submitBtn.disabled = false;
            }
          } catch (error) {
            console.error('‚ùå Erro:', error);
            showNotification(`‚ùå Erro: ${error.message}`, 'error');
            submitBtn.innerHTML = originalHTML;
            submitBtn.disabled = false;
          } finally {
            this.removeAttribute('data-submitting');
          }
        });
      }

      // Salvar rascunho
      const saveDraftBtn = document.getElementById('saveDraftBtn');
      if (saveDraftBtn) {
        saveDraftBtn.addEventListener('click', function () {
          showNotification('Fun√ß√£o de rascunho ser√° implementada em breve', 'info');
        });
      }

      console.log("‚úÖ Formul√°rio inicializado");
    });

    // ============================================
    // ===== ANIMA√á√ïES CSS =====
    // ============================================
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes fadeOut {
        from { opacity: 1; transform: translateX(0); }
        to { opacity: 0; transform: translateX(100%); }
      }
      .label-required::after {
        content: " *";
        color: #f44336;
      }
    `;
    document.head.appendChild(style);
  </script>
</body>

</html>