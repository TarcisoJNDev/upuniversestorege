<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Produtos - Admin</title>
  <link rel="stylesheet" href="../public/css/base.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="categories.css">
  <link rel="stylesheet" href="products.css">
  <script src="../public/js/api.js"></script>
</head>

<body>
  <div class="admin-wrapper">
    <!-- SIDEBAR ATUALIZADA COM LINKS DESABILITADOS -->
    <aside class="admin-sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">UNIVERSO PARALELO</div>
        <div class="admin-status">
          <span class="status-dot"></span>
          <span>Admin Online</span>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="section-title">Principal</div>
          <a href="dashboard.html" class="nav-link">
            <i class="fas fa-tachometer-alt"></i>
            <span>Dashboard</span>
          </a>
          <a href="products.html" class="nav-link active">
            <i class="fas fa-cube"></i>
            <span>Produtos</span>
          </a>
          <a href="categories.html" class="nav-link">
            <i class="fas fa-tags"></i>
            <span>Categorias</span>
          </a>
          <!-- href="orders.html" -->
          <a href="#" class="nav-link disabled">
            <i class="fas fa-shopping-cart"></i>
            <span>Pedidos</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="section-title">Conte√∫do</div>
          <a href="#" class="nav-link disabled">
            <i class="fas fa-images"></i>
            <span>Banners</span>
          </a>
          <a href="#" class="nav-link disabled">
            <i class="fas fa-star"></i>
            <span>Avalia√ß√µes</span>
          </a>
          <!-- Blog foi removido conforme solicitado -->
        </div>

        <div class="nav-section">
          <div class="section-title">Configura√ß√µes</div>
          <!-- Usu√°rios foi removido conforme solicitado -->
          <a href="#" class="nav-link disabled">
            <i class="fas fa-cog"></i>
            <span>Configura√ß√µes</span>
          </a>
          <a href="#" class="nav-link disabled">
            <i class="fas fa-chart-line"></i>
            <span>Relat√≥rios</span>
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <div class="admin-profile">
          <div class="profile-avatar">A</div>
          <div class="profile-info">
            <h4>Admin Master</h4>
            <p>Super Admin</p>
          </div>
        </div>
        <button class="btn-logout" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>
          <span>Sair</span>
        </button>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="admin-main">
      <header class="products-header">
        <div class="header-title">
          <h1><i class="fas fa-cube"></i> Gerenciar Produtos</h1>
          <p>Gerencie todos os produtos da sua loja</p>
        </div>
        <div class="products-toolbar">
          <div class="search-box">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" placeholder="Buscar produtos..." id="searchInput">
          </div>
          <a href="product-form.html" class="btn-new-product">
            <i class="fas fa-plus"></i>
            Novo Produto
          </a>
        </div>
      </header>

      <!-- Filtros -->
      <div class="products-filters">
        <select class="filter-select" id="categoryFilter">
          <option value="">Todas as categorias</option>
          <!-- Categorias ser√£o carregadas dinamicamente aqui -->
        </select>

        <select class="filter-select" id="statusFilter">
          <option value="">Todos os status</option>
          <option value="active">Ativo</option>
          <option value="inactive">Inativo</option>
          <option value="out_of_stock">Esgotado</option>
        </select>

        <select class="filter-select" id="sortFilter">
          <option value="newest">Ordenar por: Mais recentes</option>
          <option value="name_asc">Ordenar por: Nome (A-Z)</option>
          <option value="name_desc">Ordenar por: Nome (Z-A)</option>
          <option value="price_asc">Ordenar por: Pre√ßo (menor)</option>
          <option value="price_desc">Ordenar por: Pre√ßo (maior)</option>
        </select>

        <button class="btn-action btn-view" style="padding: 12px 25px;" id="applyFiltersBtn">
          <i class="fas fa-filter"></i>
          Aplicar Filtros
        </button>

        <button class="btn-action btn-view" style="padding: 12px 25px; background: #4CAF50;" id="refreshBtn">
          <i class="fas fa-sync-alt"></i>
          Atualizar
        </button>
      </div>

      <!-- Tabela de Produtos -->
      <div class="products-table-container">
        <table class="products-table">
          <thead>
            <tr>
              <th style="width: 50px;">
                <input type="checkbox" id="selectAll">
              </th>
              <th>Produto</th>
              <th>Categoria</th>
              <th>Pre√ßo</th>
              <th>Estoque</th>
              <th>Status</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="productsTableBody">
            <!-- Os produtos ser√£o carregados aqui dinamicamente -->
            <tr id="loadingRow">
              <td colspan="7" style="text-align: center; padding: 40px;">
                <i class="fas fa-spinner fa-spin fa-2x" style="color: #7C3AED;"></i>
                <p style="margin-top: 10px;">Carregando produtos...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagina√ß√£o -->
      <div class="pagination">
        <div class="pagination-info" id="paginationInfo">
          Carregando...
        </div>
        <div class="pagination-controls">
          <button class="btn-pagination" id="prevPageBtn" disabled>
            <i class="fas fa-chevron-left"></i>
            Anterior
          </button>
          <div class="page-numbers" id="pageNumbers">
            <span class="page-number active">1</span>
          </div>
          <button class="btn-pagination" id="nextPageBtn">
            Pr√≥xima
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>

      <!-- A√ß√µes em massa -->
      <div id="bulkActions"
        style="display: none; margin-top: 30px; padding: 20px; background: rgba(26, 0, 43, 0.7); border-radius: 12px; border: 1px solid rgba(124, 58, 237, 0.2); display: flex; gap: 15px; align-items: center;">
        <span style="color: #aaa; font-size: 14px;">Com <strong id="selectedCount">0</strong> selecionados:</span>
        <select id="bulkActionSelect"
          style="padding: 10px 15px; background: rgba(11, 0, 21, 0.8); border: 1px solid rgba(124, 58, 237, 0.3); border-radius: 8px; color: #fff; font-size: 13px;">
          <option value="">A√ß√µes em massa...</option>
          <option value="activate">Ativar selecionados</option>
          <option value="deactivate">Desativar selecionados</option>
          <option value="delete">Excluir selecionados</option>
        </select>
        <button id="applyBulkActionBtn"
          style="padding: 10px 20px; background: linear-gradient(135deg, #DF38FF, #7C3AED); border: none; border-radius: 8px; color: #fff; font-size: 13px; cursor: pointer; transition: all 0.3s ease;">
          Aplicar
        </button>
      </div>
    </main>
  </div>

  <!-- Modal de Confirma√ß√£o -->
  <div class="modal" id="deleteModal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeDeleteModal()">
        <i class="fas fa-times"></i>
      </button>
      <h2 class="modal-title">Excluir Produto</h2>
      <p class="modal-text" id="deleteModalText">
        Tem certeza que deseja excluir este produto? Esta a√ß√£o n√£o pode ser desfeita.
      </p>
      <div class="modal-actions">
        <button class="btn-modal cancel" onclick="closeDeleteModal()">
          Cancelar
        </button>
        <button class="btn-modal delete" onclick="confirmDelete()">
          Sim, excluir
        </button>
      </div>
    </div>
  </div>

  <script>
    // ========== CONFIGURA√á√ÉO DA API ==========
    const API_BASE_URL = 'http://localhost:5000/api';

    // Fun√ß√£o para obter headers
    function getAPIConfig() {
      return {
        headers: {
          'Content-Type': 'application/json',
        }
      };
    }

    // ========== FUN√á√ïES DE API ESPEC√çFICAS PARA CATEGORIAS ==========

    // Fun√ß√£o para buscar categorias com contagem (ADICIONADA AQUI)
    async function getCategoriesWithProductCount() {
      try {
        console.log("üåê Chamando API:", `${API_BASE_URL}/categories/with-count`);
        const response = await fetch(`${API_BASE_URL}/categories/with-count`, getAPIConfig());

        if (!response.ok) {
          throw new Error('Erro ao buscar categorias');
        }

        const data = await response.json();
        console.log("üìä Dados recebidos da API:", data);
        return data.categories || [];
      } catch (error) {
        console.error('Erro ao buscar categorias com contagem:', error);
        return [];
      }
    }

    // Fun√ß√£o para buscar categorias simples (sem contagem)
    async function getCategories() {
      try {
        console.log("üåê Chamando API:", `${API_BASE_URL}/categories`);
        const response = await fetch(`${API_BASE_URL}/categories`, getAPIConfig());

        if (!response.ok) {
          throw new Error('Erro ao buscar categorias');
        }

        const data = await response.json();
        return data.categories || [];
      } catch (error) {
        console.error('Erro ao buscar categorias:', error);
        return [];
      }
    }

    // ========== INTEGRAR COM ProductAPI EXISTENTE ==========
    // Adicionar m√©todos ao ProductAPI se n√£o existirem
    if (typeof ProductAPI === 'undefined') {
      window.ProductAPI = {};
    }

    // Adicionar os m√©todos de categorias ao ProductAPI
    ProductAPI.getCategoriesWithProductCount = getCategoriesWithProductCount;
    ProductAPI.getCategories = getCategories;

    document.addEventListener('DOMContentLoaded', function () {
      console.log("üì¶ Iniciando p√°gina de produtos...");

      // === GERENCIAMENTO DO PERFIL E LOGOUT ===
      // Verificar login
      const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
      if (!isLoggedIn) {
        window.location.href = 'login.html';
        return;
      }

      // Logout
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function () {
          if (confirm('Tem certeza que deseja sair?')) {
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('adminEmail');
            window.location.href = 'login.html';
          }
        });
      }

      // Update admin name from localStorage
      const adminEmail = localStorage.getItem('adminEmail');
      const profileName = document.querySelector('.profile-info h4');
      if (adminEmail && profileName) {
        profileName.textContent = adminEmail.split('@')[0];
      }

      // Atualizar avatar com primeira letra do nome
      const profileAvatar = document.querySelector('.profile-avatar');
      if (adminEmail && profileAvatar) {
        const firstName = adminEmail.split('@')[0];
        profileAvatar.textContent = firstName.charAt(0).toUpperCase();
      }

      // === GERENCIAMENTO DE PRODUTOS ===
      // Vari√°veis globais
      let allProducts = [];
      let filteredProducts = [];
      let allCategories = [];
      let currentPage = 1;
      const productsPerPage = 10;
      let productToDelete = null;

      // Elementos DOM
      const searchInput = document.getElementById('searchInput');
      const categoryFilter = document.getElementById('categoryFilter');
      const statusFilter = document.getElementById('statusFilter');
      const sortFilter = document.getElementById('sortFilter');
      const applyFiltersBtn = document.getElementById('applyFiltersBtn');
      const refreshBtn = document.getElementById('refreshBtn');
      const productsTableBody = document.getElementById('productsTableBody');
      const paginationInfo = document.getElementById('paginationInfo');
      const prevPageBtn = document.getElementById('prevPageBtn');
      const nextPageBtn = document.getElementById('nextPageBtn');
      const pageNumbers = document.getElementById('pageNumbers');
      const bulkActions = document.getElementById('bulkActions');
      const selectedCount = document.getElementById('selectedCount');
      const bulkActionSelect = document.getElementById('bulkActionSelect');
      const applyBulkActionBtn = document.getElementById('applyBulkActionBtn');
      const selectAll = document.getElementById('selectAll');

      // === FUN√á√ïES PRINCIPAIS ===

      // Fun√ß√£o para carregar categorias da API
      async function loadCategories() {
        try {
          console.log("üè∑Ô∏è Carregando categorias da API...");

          // Tentar buscar categorias com contagem
          try {
            allCategories = await ProductAPI.getCategoriesWithProductCount();
          } catch (error) {
            console.log("üîÑ Fallback: buscando categorias simples...");
            // Se falhar, tentar buscar categorias normais
            allCategories = await ProductAPI.getCategories();
          }

          console.log(`‚úÖ ${allCategories.length} categorias carregadas`);

          // Atualizar o select de categorias
          updateCategoryFilter();

          return allCategories;
        } catch (error) {
          console.error("‚ùå Erro ao carregar categorias:", error);
          showNotification('Erro ao carregar categorias', 'error');
          return [];
        }
      }

      // Fun√ß√£o para atualizar o filtro de categorias
      function updateCategoryFilter() {
        const categoryFilter = document.getElementById('categoryFilter');

        // Limpar op√ß√µes existentes (exceto a primeira)
        categoryFilter.innerHTML = '<option value="">Todas as categorias</option>';

        if (!allCategories || allCategories.length === 0) {
          // Se n√£o houver categorias, adicionar uma op√ß√£o padr√£o
          const option = document.createElement('option');
          option.value = "uncategorized";
          option.textContent = "N√£o categorizado";
          categoryFilter.appendChild(option);
          return;
        }

        // Ordenar categorias por nome
        allCategories.sort((a, b) => a.name.localeCompare(b.name));

        // Adicionar categorias principais primeiro (sem parent_id)
        const mainCategories = allCategories.filter(cat => !cat.parent_id);
        const subCategories = allCategories.filter(cat => cat.parent_id);

        // Adicionar categorias principais
        mainCategories.forEach(category => {
          const option = document.createElement('option');
          option.value = category.id;
          option.textContent = category.name;
          categoryFilter.appendChild(option);

          // Adicionar subcategorias desta categoria
          const categorySubCategories = subCategories.filter(sub => sub.parent_id == category.id);
          if (categorySubCategories.length > 0) {
            categorySubCategories.forEach(subCategory => {
              const subOption = document.createElement('option');
              subOption.value = subCategory.id;
              subOption.textContent = `‚îî‚îÄ ${subCategory.name}`;
              subOption.style.paddingLeft = '20px';
              categoryFilter.appendChild(subOption);
            });
          }
        });
      }

      // Carregar produtos da API
      async function loadProducts() {
        try {
          console.log("üì• Carregando produtos da API...");

          // Mostrar loading
          productsTableBody.innerHTML = `
            <tr id="loadingRow">
              <td colspan="7" style="text-align: center; padding: 40px;">
                <i class="fas fa-spinner fa-spin fa-2x" style="color: #7C3AED;"></i>
                <p style="margin-top: 10px;">Carregando produtos...</p>
              </td>
            </tr>
          `;

          // Carregar categorias primeiro
          await loadCategories();

          // Buscar produtos
          allProducts = await ProductAPI.getAllProducts();
          console.log(`‚úÖ ${allProducts.length} produtos carregados`);

          // Aplicar filtros iniciais
          applyFilters();

        } catch (error) {
          console.error("‚ùå Erro ao carregar produtos:", error);
          showNotification('Erro ao carregar produtos', 'error');

          productsTableBody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 40px; color: #f44336;">
                <i class="fas fa-exclamation-triangle fa-2x"></i>
                <p style="margin-top: 10px;">Erro ao carregar produtos</p>
                <button onclick="loadProducts()" style="margin-top: 10px; padding: 8px 15px; background: #7C3AED; color: white; border: none; border-radius: 5px; cursor: pointer;">
                  Tentar novamente
                </button>
              </td>
            </tr>
          `;
        }
      }

      // Aplicar filtros
     // Aplicar filtros - VERS√ÉO CORRIGIDA PARA category (string)
      function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        const categoryId = categoryFilter.value;
        const status = statusFilter.value;
        const sortBy = sortFilter.value;

        console.log("üîç Aplicando filtros:", {
          searchTerm,
          categoryId,
          status,
          sortBy
        });

        // Filtrar produtos
        filteredProducts = allProducts.filter(product => {
          // Busca por texto
          const matchesSearch = !searchTerm ||
            product.name.toLowerCase().includes(searchTerm) ||
            (product.description && product.description.toLowerCase().includes(searchTerm)) ||
            (product.sku && product.sku.toLowerCase().includes(searchTerm));

          // Filtro por categoria - VERS√ÉO CORRIGIDA PARA category (string)
          let matchesCategory = true;
          if (categoryId) {
            // Obter o nome da categoria selecionada
            let selectedCategoryName = '';

            // Encontrar a categoria selecionada pelo ID
            const selectedCategory = allCategories.find(cat => cat.id.toString() === categoryId.toString());
            if (selectedCategory) {
              selectedCategoryName = selectedCategory.name;
              console.log(`Categoria selecionada: ${selectedCategoryName} (ID: ${categoryId})`);
            }

            // Verificar se o produto pertence a esta categoria
            if (selectedCategoryName) {
              // Primeiro, tentar usar category_id se existir
              if (product.category_id !== null && product.category_id !== undefined) {
                matchesCategory = product.category_id.toString() === categoryId.toString();
              }
              // Se n√£o tiver category_id, usar o campo category (string)
              else if (product.category) {
                // Comparar nomes das categorias
                matchesCategory = product.category.toLowerCase() === selectedCategoryName.toLowerCase();
                console.log(`Comparando categoria do produto "${product.category}" com "${selectedCategoryName}": ${matchesCategory}`);
              } else {
                // Produto sem categoria
                matchesCategory = false;
              }
            } else {
              // Categoria n√£o encontrada (n√£o deve acontecer)
              matchesCategory = false;
            }
          }

          // Filtro por status
          const matchesStatus = !status || product.status === status;

          return matchesSearch && matchesCategory && matchesStatus;
        });

        console.log(`üìä ${filteredProducts.length} produtos ap√≥s filtragem (de ${allProducts.length} total)`);

        // Ordenar produtos
        filteredProducts.sort((a, b) => {
          switch (sortBy) {
            case 'name_asc':
              return a.name.localeCompare(b.name);
            case 'name_desc':
              return b.name.localeCompare(a.name);
            case 'price_asc':
              return a.price - b.price;
            case 'price_desc':
              return b.price - a.price;
            case 'newest':
            default:
              return new Date(b.created_at) - new Date(a.created_at);
          }
        });

        // Atualizar exibi√ß√£o
        currentPage = 1;
        updateTable();
        updatePagination();
      }

      // Atualizar tabela
      function updateTable() {
        const startIndex = (currentPage - 1) * productsPerPage;
        const endIndex = startIndex + productsPerPage;
        const pageProducts = filteredProducts.slice(startIndex, endIndex);

        function buildImageUrl(imagePath) {
          if (!imagePath) return '';

          // Se j√° for URL completa
          if (imagePath.startsWith('http') || imagePath.startsWith('data:image')) {
            return imagePath;
          }

          // Se come√ßar com /, adicionar dom√≠nio
          if (imagePath.startsWith('/')) {
            return `http://localhost:5000${imagePath}`;
          }

          // Se for apenas nome do arquivo
          return `http://localhost:5000/uploads/${imagePath}`;
        }

        if (pageProducts.length === 0) {
          productsTableBody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 40px;">
                <i class="fas fa-box-open fa-2x" style="color: #7C3AED; opacity: 0.5;"></i>
                <p style="margin-top: 10px; color: #aaa;">Nenhum produto encontrado</p>
                ${filteredProducts.length === 0 && allProducts.length > 0 ?
              '<p style="color: #888; font-size: 14px;">Tente ajustar os filtros</p>' :
              '<a href="product-form.html" style="display: inline-block; margin-top: 10px; padding: 8px 15px; background: #7C3AED; color: white; text-decoration: none; border-radius: 5px;">Criar primeiro produto</a>'}
              </td>
            </tr>
          `;
          bulkActions.style.display = 'none';
          return;
        }

        // Gerar linhas da tabela
        let tableHTML = '';

        pageProducts.forEach((product, index) => {
          const isFeatured = product.featured ? '<span style="margin-left: 5px; color: #FFD700;"><i class="fas fa-star"></i></span>' : '';

          // Determinar status do estoque
          let stockStatusClass = '';
          let stockStatusIcon = '';
          let stockStatusText = '';

          if (product.status === 'inactive') {
            stockStatusClass = 'stock-out';
            stockStatusIcon = 'fas fa-ban';
            stockStatusText = 'Inativo';
          } else if (product.stock === 0) {
            stockStatusClass = 'stock-out';
            stockStatusIcon = 'fas fa-times-circle';
            stockStatusText = 'Esgotado';
          } else if (product.stock <= 5) {
            stockStatusClass = 'stock-low';
            stockStatusIcon = 'fas fa-exclamation-triangle';
            stockStatusText = 'Estoque baixo';
          } else {
            stockStatusClass = 'stock-in';
            stockStatusIcon = 'fas fa-check-circle';
            stockStatusText = 'Em estoque';
          }

          // Imagem do produto
          const mainImageUrl = buildImageUrl(product.image_url);

          // Formatar pre√ßo
          const formattedPrice = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
          }).format(product.price);

          // SKU ou ID
          const productId = product.sku || `PROD-${String(product.id).padStart(3, '0')}`;

          // Obter nome da categoria
          let categoryName = 'N√£o categorizado';
          if (product.category_id && allCategories && allCategories.length > 0) {
            const category = allCategories.find(cat => cat.id == product.category_id);
            if (category) {
              categoryName = category.name;
            }
          } else if (product.category) {
            // Se ainda estiver usando o campo antigo category
            categoryName = product.category;
          }

          tableHTML += `
    <tr data-product-id="${product.id}">
      <td>
        <input type="checkbox" class="product-checkbox" data-product-id="${product.id}">
      </td>
      <td>
        <div class="product-cell">
          <div class="product-image">
            <img src="${mainImageUrl}" alt="${product.name}" 
                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px;"
                 onerror="
                    console.error('‚ùå Erro ao carregar imagem do produto ${product.id}:', this.src);
                    this.src='https://images.unsplash.com/photo-1571330735066-03aaa9429d89?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80';
                 ">
          </div>
          <div class="product-info">
            <h4>${product.name} ${isFeatured}</h4>
            <p>ID: ${productId}</p>
          </div>
        </div>
      </td>
      <td>${categoryName}</td>
      <td>
        <strong style="color: #C084FC;">${formattedPrice}</strong>
      </td>
      <td>${product.stock} unidades</td>
      <td>
        <span class="stock-status ${stockStatusClass}">
          <i class="${stockStatusIcon}"></i>
          ${stockStatusText}
        </span>
      </td>
      <td>
        <div class="actions-cell">
          <button class="btn-action btn-view" onclick="viewProduct(${product.id})">
            <i class="far fa-eye"></i>
            Ver
          </button>
          <button class="btn-action btn-edit" onclick="editProduct(${product.id})">
            <i class="far fa-edit"></i>
            Editar
          </button>
          <button class="btn-action btn-delete" onclick="showDeleteModal(${product.id}, '${product.name.replace(/'/g, "\\'")}')">
            <i class="far fa-trash-alt"></i>
            Excluir
          </button>
        </div>
      </td>
    </tr>
  `;
        });

        productsTableBody.innerHTML = tableHTML;
        updateBulkActions();
      }

      // Atualizar pagina√ß√£o
      function updatePagination() {
        const totalPages = Math.ceil(filteredProducts.length / productsPerPage);

        // Atualizar informa√ß√µes
        const startProduct = (currentPage - 1) * productsPerPage + 1;
        const endProduct = Math.min(currentPage * productsPerPage, filteredProducts.length);

        paginationInfo.innerHTML = filteredProducts.length > 0 ?
          `Mostrando <strong>${startProduct}-${endProduct}</strong> de <strong>${filteredProducts.length}</strong> produtos` :
          'Nenhum produto encontrado';

        // Atualizar bot√µes
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;

        // Atualizar n√∫meros de p√°gina
        let pageNumbersHTML = '';
        const maxPagesToShow = 5;

        if (totalPages <= maxPagesToShow) {
          for (let i = 1; i <= totalPages; i++) {
            pageNumbersHTML += `<span class="page-number ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</span>`;
          }
        } else {
          // L√≥gica para mostrar p√°ginas com "..." quando h√° muitas
          if (currentPage <= 3) {
            for (let i = 1; i <= 4; i++) {
              pageNumbersHTML += `<span class="page-number ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</span>`;
            }
            pageNumbersHTML += '<span class="page-dots">...</span>';
            pageNumbersHTML += `<span class="page-number" onclick="goToPage(${totalPages})">${totalPages}</span>`;
          } else if (currentPage >= totalPages - 2) {
            pageNumbersHTML += `<span class="page-number" onclick="goToPage(1)">1</span>`;
            pageNumbersHTML += '<span class="page-dots">...</span>';
            for (let i = totalPages - 3; i <= totalPages; i++) {
              pageNumbersHTML += `<span class="page-number ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</span>`;
            }
          } else {
            pageNumbersHTML += `<span class="page-number" onclick="goToPage(1)">1</span>`;
            pageNumbersHTML += '<span class="page-dots">...</span>';
            for (let i = currentPage - 1; i <= currentPage + 1; i++) {
              pageNumbersHTML += `<span class="page-number ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</span>`;
            }
            pageNumbersHTML += '<span class="page-dots">...</span>';
            pageNumbersHTML += `<span class="page-number" onclick="goToPage(${totalPages})">${totalPages}</span>`;
          }
        }

        pageNumbers.innerHTML = pageNumbersHTML;
      }

      // Atualizar a√ß√µes em massa
      function updateBulkActions() {
        const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
        const selectedCountValue = selectedCheckboxes.length;

        if (selectedCountValue > 0) {
          bulkActions.style.display = 'flex';
          selectedCount.textContent = selectedCountValue;
        } else {
          bulkActions.style.display = 'none';
        }
      }

      // === FUN√á√ïES DE NAVEGA√á√ÉO ===
      window.goToPage = function (page) {
        if (page < 1 || page > Math.ceil(filteredProducts.length / productsPerPage)) return;
        currentPage = page;
        updateTable();
        updatePagination();
      }

      window.viewProduct = function (productId) {
        console.log("üëÅÔ∏è Visualizando produto:", productId);
        // Aqui voc√™ pode abrir um modal ou redirecionar para uma p√°gina de detalhes
        showNotification(`Visualizando produto ID: ${productId}`, 'info');
      }

      window.editProduct = function (productId) {
        console.log("‚úèÔ∏è Editando produto:", productId);
        // Redirecionar para p√°gina de edi√ß√£o
        window.location.href = `product-form.html?edit=${productId}`;
      }

      // === FUN√á√ïES DO MODAL DE EXCLUS√ÉO ===
      window.showDeleteModal = function (productId, productName) {
        productToDelete = productId;
        const modal = document.getElementById('deleteModal');
        modal.classList.add('show');

        document.getElementById('deleteModalText').textContent =
          `Tem certeza que deseja excluir o produto "${productName}"? Esta a√ß√£o n√£o pode ser desfeita.`;
      }

      window.closeDeleteModal = function () {
        const modal = document.getElementById('deleteModal');
        modal.classList.remove('show');
        productToDelete = null;
      }

      window.confirmDelete = async function () {
        if (!productToDelete) return;

        try {
          console.log(`üóëÔ∏è Excluindo produto ${productToDelete}...`);

          const result = await ProductAPI.deleteProduct(productToDelete);

          if (result.success) {
            showNotification('Produto exclu√≠do com sucesso!', 'success');

            // Remover produto da lista local
            allProducts = allProducts.filter(p => p.id !== productToDelete);
            filteredProducts = filteredProducts.filter(p => p.id !== productToDelete);

            // Atualizar exibi√ß√£o
            updateTable();
            updatePagination();
          } else {
            showNotification(`Erro: ${result.error || 'N√£o foi poss√≠vel excluir o produto'}`, 'error');
          }
        } catch (error) {
          console.error("‚ùå Erro ao excluir produto:", error);
          showNotification('Erro ao excluir produto', 'error');
        }

        closeDeleteModal();
      }

      // === FUN√á√ïES DE A√á√ïES EM MASSA ===
      async function applyBulkAction() {
        const action = bulkActionSelect.value;
        const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');

        if (!action || selectedCheckboxes.length === 0) {
          showNotification('Selecione uma a√ß√£o e pelo menos um produto', 'warning');
          return;
        }

        const productIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.productId));

        try {
          let successCount = 0;
          let errorCount = 0;

          for (const productId of productIds) {
            try {
              let result;

              switch (action) {
                case 'activate':
                  result = await ProductAPI.updateProduct(productId, { status: 'active' });
                  break;
                case 'deactivate':
                  result = await ProductAPI.updateProduct(productId, { status: 'inactive' });
                  break;
                case 'delete':
                  result = await ProductAPI.deleteProduct(productId);
                  break;
              }

              if (result && result.success) {
                successCount++;
              } else {
                errorCount++;
              }
            } catch (error) {
              errorCount++;
              console.error(`Erro processando produto ${productId}:`, error);
            }
          }

          // Recarregar produtos
          await loadProducts();

          // Mostrar resultado
          if (errorCount === 0) {
            showNotification(`${successCount} produto(s) ${getActionText(action)} com sucesso!`, 'success');
          } else {
            showNotification(`${successCount} sucesso(s), ${errorCount} erro(s)`, 'warning');
          }

          // Resetar sele√ß√£o
          selectAll.checked = false;
          document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = false);
          updateBulkActions();

        } catch (error) {
          console.error("‚ùå Erro nas a√ß√µes em massa:", error);
          showNotification('Erro ao processar a√ß√µes em massa', 'error');
        }
      }

      function getActionText(action) {
        switch (action) {
          case 'activate': return 'ativado(s)';
          case 'deactivate': return 'desativado(s)';
          case 'delete': return 'exclu√≠do(s)';
          default: return 'processado(s)';
        }
      }

      // === EVENT LISTENERS ===
      // Selecionar todos
      if (selectAll) {
        selectAll.addEventListener('change', function () {
          const checkboxes = document.querySelectorAll('.product-checkbox');
          checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
          });
          updateBulkActions();
        });
      }

      // Atualizar contagem quando checkboxes mudam
      document.addEventListener('change', function (e) {
        if (e.target.classList.contains('product-checkbox')) {
          updateBulkActions();
        }
      });

      // Busca em tempo real
      if (searchInput) {
        searchInput.addEventListener('input', function () {
          clearTimeout(this.searchTimeout);
          this.searchTimeout = setTimeout(() => {
            applyFilters();
          }, 500);
        });
      }

      // Filtros
      if (categoryFilter) categoryFilter.addEventListener('change', applyFilters);
      if (statusFilter) statusFilter.addEventListener('change', applyFilters);
      if (sortFilter) sortFilter.addEventListener('change', applyFilters);
      if (applyFiltersBtn) applyFiltersBtn.addEventListener('click', applyFilters);

      // Bot√£o de atualizar
      if (refreshBtn) {
        refreshBtn.addEventListener('click', function () {
          loadProducts();
          showNotification('Produtos atualizados!', 'info');
        });
      }

      // Bot√µes de pagina√ß√£o
      if (prevPageBtn) prevPageBtn.addEventListener('click', () => goToPage(currentPage - 1));
      if (nextPageBtn) nextPageBtn.addEventListener('click', () => goToPage(currentPage + 1));

      // A√ß√µes em massa
      if (applyBulkActionBtn) {
        applyBulkActionBtn.addEventListener('click', applyBulkAction);
      }

      // Carregar produtos inicialmente
      loadProducts();
    });

    // === FUN√á√ÉO DE NOTIFICA√á√ÉO ===
    function showNotification(message, type = 'info') {
      console.log(`üì¢ Notifica√ß√£o [${type}]: ${message}`);

      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #1a002b, #0b0015);
        border: 2px solid ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#7C3AED'};
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 15px;
        z-index: 10000;
        animation: slideIn 0.3s ease;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        max-width: 400px;
      `;

      const icon = type === 'success' ? 'check-circle' :
        type === 'error' ? 'exclamation-circle' :
          type === 'warning' ? 'exclamation-triangle' : 'info-circle';

      notification.innerHTML = `
        <i class="fas fa-${icon}" style="color: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#7C3AED'}; font-size: 20px;"></i>
        <span>${message}</span>
      `;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    // === ANIMA√á√ïES CSS ===
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes fadeOut {
        from { opacity: 1; transform: translateX(0); }
        to { opacity: 0; transform: translateX(100%); }
      }
      
      .page-dots {
        color: #888;
        padding: 5px 10px;
      }
      
      .page-number {
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .page-number:hover {
        background: rgba(124, 58, 237, 0.2);
      }
    `;
    document.head.appendChild(style);
  </script>
</body>

</html>