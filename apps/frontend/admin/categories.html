<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Categorias - Admin</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/brands.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/solid.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/regular.min.css">
  <link rel="stylesheet" href="./../public/css/base.css">
  <link rel="stylesheet" href="./../admin/categories.css">
  <script src="./../public/js/api.js"></script>
  <script src="/public/js/config.js"></script>
</head>

<body>
  <div class="admin-wrapper">
    <!-- SIDEBAR COMPLETA (ATUALIZADA) -->
    <aside class="admin-sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">UNIVERSO PARALELO</div>
        <div class="admin-status">
          <span class="status-dot"></span>
          <span>Admin Online</span>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="section-title">Principal</div>
          <a href="dashboard.html" class="nav-link">
            <i class="fas fa-tachometer-alt"></i>
            <span>Dashboard</span>
          </a>
          <a href="products.html" class="nav-link">
            <i class="fas fa-cube"></i>
            <span>Produtos</span>
          </a>
          <a href="categories.html" class="nav-link active">
            <i class="fas fa-tags"></i>
            <span>Categorias</span>
          </a>
          <!-- href="orders.html" -->
          <a href="#" class="nav-link disabled">
            <i class="fas fa-shopping-cart"></i>
            <span>Pedidos</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="section-title">Conte√∫do</div>
          <a href="#" class="nav-link disabled">
            <i class="fas fa-images"></i>
            <span>Banners</span>
          </a>
          <a href="#" class="nav-link disabled">
            <i class="fas fa-star"></i>
            <span>Avalia√ß√µes</span>
          </a>
          <!-- Blog foi removido conforme solicitado -->
        </div>

        <div class="nav-section">
          <div class="section-title">Configura√ß√µes</div>
          <!-- Usu√°rios foi removido conforme solicitado -->
          <a href="#" class="nav-link disabled">
            <i class="fas fa-cog"></i>
            <span>Configura√ß√µes</span>
          </a>
          <a href="#" class="nav-link disabled">
            <i class="fas fa-chart-line"></i>
            <span>Relat√≥rios</span>
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <div class="admin-profile">
          <div class="profile-avatar">A</div>
          <div class="profile-info">
            <h4>Admin Master</h4>
            <p>Super Admin</p>
          </div>
        </div>
        <button class="btn-logout" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>
          <span>Sair</span>
        </button>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="admin-main">
      <!-- O resto do seu HTML atual (header, formul√°rio, grid, modal) -->
      <header class="categories-header">
        <div class="header-title">
          <h1><i class="fas fa-tags"></i> Gerenciar Categorias</h1>
          <p>Organize seus produtos em categorias e subcategorias</p>
        </div>
        <div class="categories-header-buttons">
          <button class="btn-new-category" id="refreshBtn">
            <i class="fas fa-sync-alt"></i>
            Atualizar
          </button>
          <button class="btn-new-category" id="newCategoryBtn">
            <i class="fas fa-plus"></i>
            Nova Categoria
          </button>
        </div>
      </header>

      <!-- Formul√°rio de Categoria (Oculto por padr√£o) -->
      <div class="category-form-container" id="categoryForm">
        <div class="form-header">
          <h2><i class="fas fa-plus-circle"></i> <span id="formTitle">Nova Categoria</span></h2>
          <button class="btn-close-form" onclick="hideCategoryForm()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <form id="categoryFormData">
          <input type="hidden" id="categoryId" value="">

          <div class="form-grid">
            <div class="form-group">
              <label class="label-required">Nome da Categoria</label>
              <input type="text" class="form-control" id="categoryName" placeholder="Ex: Esculturas 3D" required>
            </div>

            <div class="form-group">
              <label class="label-required">Slug (URL)</label>
              <input type="text" class="form-control" id="categorySlug" placeholder="ex: esculturas-3d" required>
              <small style="color: #666; font-size: 12px;">URL amig√°vel para a categoria (sem espa√ßos, use
                h√≠fens)</small>
            </div>
          </div>

          <div class="form-group">
            <label>Descri√ß√£o</label>
            <textarea class="form-control" id="categoryDescription"
              placeholder="Descreva a categoria em poucas palavras..." rows="3"></textarea>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label>√çcone (Emoji ou Texto)</label>
              <div class="icon-selector">
                <div class="icon-preview" id="iconPreview" onclick="openIconPicker()">üè∫</div>
                <input type="text" id="iconInput" class="form-control" placeholder="Clique para selecionar √≠cone"
                  style="flex: 1; margin-left: 10px; cursor: pointer;" onclick="openIconPicker()" readonly>
              </div>
              <small style="color: #666; font-size: 12px;">Digite um emoji ou nome de √≠cone FontAwesome (ex:
                fa-tag)</small>
            </div>

            <div class="form-group">
              <label>Cor do √çcone</label>
              <div class="color-picker" id="colorPicker">
                <div class="color-option selected" style="background: #C084FC;" data-color="#C084FC"></div>
                <div class="color-option" style="background: #DF38FF;" data-color="#DF38FF"></div>
                <div class="color-option" style="background: #7C3AED;" data-color="#7C3AED"></div>
                <div class="color-option" style="background: #4CAF50;" data-color="#4CAF50"></div>
                <div class="color-option" style="background: #2196F3;" data-color="#2196F3"></div>
                <div class="color-option" style="background: #FFC107;" data-color="#FFC107"></div>
                <div class="color-option" style="background: #F44336;" data-color="#F44336"></div>
                <div class="color-option" style="background: #9C27B0;" data-color="#9C27B0"></div>
              </div>
              <input type="hidden" id="selectedColor" value="#C084FC">
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label>Categoria Pai</label>
              <select class="form-control" id="parentCategory">
                <option value="">Nenhuma (Categoria Principal)</option>
                <!-- Categorias ser√£o carregadas aqui -->
              </select>
            </div>

            <div class="form-group">
              <label>Ordem de Exibi√ß√£o</label>
              <input type="number" class="form-control" id="displayOrder" placeholder="1" min="1" value="1">
            </div>
          </div>

          <div class="form-group">
            <label>Imagem da Categoria (URL)</label>
            <input type="url" class="form-control" id="categoryImage"
              placeholder="https://exemplo.com/imagem-categoria.jpg">
            <small style="color: #666; font-size: 12px;">URL de uma imagem representativa da categoria</small>
          </div>

          <div style="margin: 20px 0;">
            <label style="display: flex; align-items: center; gap: 10px;">
              <input type="checkbox" id="isActive" checked>
              <span>Categoria ativa (vis√≠vel na loja)</span>
            </label>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" onclick="hideCategoryForm()">
              Cancelar
            </button>
            <button type="submit" class="btn-submit" id="submitBtn">
              <i class="fas fa-save"></i>
              Salvar Categoria
            </button>
          </div>
        </form>
      </div>

      <!-- Loading State -->
      <div id="loadingState" style="text-align: center; padding: 40px;">
        <i class="fas fa-spinner fa-spin fa-2x" style="color: #7C3AED;"></i>
        <p style="margin-top: 10px; color: #aaa;">Carregando categorias...</p>
      </div>

      <!-- Grid de Categorias -->
      <div class="categories-grid" id="categoriesGrid" style="display: none;">
        <!-- Categorias ser√£o carregadas aqui dinamicamente -->
      </div>

      <!-- Modal de Confirma√ß√£o -->
      <div class="modal" id="deleteModal">
        <div class="modal-content">
          <button class="modal-close" onclick="closeDeleteModal()">
            <i class="fas fa-times"></i>
          </button>
          <h2 class="modal-title">Excluir Categoria</h2>
          <p class="modal-text" id="deleteModalText">
            Tem certeza que deseja excluir esta categoria? Esta a√ß√£o n√£o pode ser desfeita.
          </p>
          <div class="modal-actions">
            <button class="btn-modal cancel" onclick="closeDeleteModal()">
              Cancelar
            </button>
            <button class="btn-modal delete" onclick="confirmDelete()">
              Sim, excluir
            </button>
          </div>
        </div>
      </div>

      <!-- Modal de Sele√ß√£o de √çcones FontAwesome -->
      <div class="modal" id="iconPickerModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
          <button class="modal-close" onclick="closeIconPicker()">
            <i class="fas fa-times"></i>
          </button>
      
          <h2 class="modal-title">
            <i class="fas fa-icons"></i> Selecione um √çcone
          </h2>
      
          <div class="icon-picker-header">
            <div class="search-container">
              <i class="fas fa-search"></i>
              <input type="text" id="iconSearch" placeholder="Buscar √≠cones (ex: tag, home, user...)">
            </div>
            <div class="icon-categories" id="iconCategories">
              <button class="category-btn active" data-category="all">Todos</button>
              <button class="category-btn" data-category="solid">Solid</button>
              <button class="category-btn" data-category="regular">Regular</button>
              <button class="category-btn" data-category="brands">Brands</button>
              <button class="category-btn" data-category="emoji">Emojis</button>
            </div>
          </div>
      
          <div class="icons-grid-container">
            <div class="icons-grid" id="iconsGrid">
              <!-- √çcones ser√£o carregados aqui -->
            </div>
          </div>
      
          <div class="selected-icon-preview" id="selectedIconPreview">
            <div class="preview-box">
              <i class="fas fa-tag" id="previewIcon"></i>
              <div class="preview-info">
                <span id="previewName">fa-tag</span>
                <small id="previewCode">fas fa-tag</small>
              </div>
            </div>
            <div class="modal-actions">
              <button class="btn-modal cancel" onclick="closeIconPicker()">
                Cancelar
              </button>
              <button class="btn-modal" onclick="selectIcon()" style="background: linear-gradient(135deg, #DF38FF, #7C3AED);">
                <i class="fas fa-check"></i> Selecionar √çcone
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ========== CONFIGURA√á√ÉO DA API ==========
      const API_BASE_URL = API_CONFIG.BASE_URL;

        // Atualizar TODAS as chamadas fetch para usar getApiUrl()
        async function getCategoriesWithProductCount() {
          try {
            const url = getApiUrl(API_CONFIG.ENDPOINTS.CATEGORIES_WITH_COUNT);
            console.log("üåê Chamando API:", url);

            const response = await fetch(url, {
              headers: { 'Content-Type': 'application/json' },
              signal: AbortSignal.timeout(30000)
            });

            if (!response.ok) {
              throw new Error(`Erro ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            return data.categories || [];

          } catch (error) {
            console.error('‚ùå Erro:', error);
            showNotification('Erro ao carregar categorias', 'error');
            return [];
          }
        }

    // Fun√ß√£o para buscar produtos por categoria
    async function getProductsByCategory(categoryId) {
      try {
        const url = `${API_BASE_URL}/categories/${categoryId}/products`;
        console.log("üåê Chamando API:", url);

        const response = await fetch(url, getAPIConfig());

        if (!response.ok) {
          // Se der 404, tente usar o nome da categoria
          const category = await getCategoryById(categoryId);
          if (category) {
            console.log("üîÑ Tentando buscar por nome da categoria...");
            return await getProductsByCategoryName(category.name);
          }
          throw new Error('Erro ao buscar produtos da categoria');
        }

        const data = await response.json();
        console.log("üì¶ Produtos retornados:", data);
        return data;
      } catch (error) {
        console.error('Erro ao buscar produtos por categoria:', error);
        throw error;
      }
    }

    // Fun√ß√£o auxiliar: buscar produtos pelo NOME da categoria (fallback)
    async function getProductsByCategoryName(categoryName) {
      try {
        const url = `${API_BASE_URL}/products/category/${encodeURIComponent(categoryName)}`;
        console.log("üîÑ Chamando API por nome:", url);

        const response = await fetch(url, getAPIConfig());

        if (!response.ok) {
          throw new Error('Erro ao buscar produtos por nome da categoria');
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Erro ao buscar produtos por nome:', error);
        return { products: [] };
      }
    }

    
    // Fun√ß√£o auxiliar: buscar categoria por ID
    async function getCategoryById(categoryId) {
      try {
        const response = await fetch(`${API_BASE_URL}/categories/${categoryId}`, getAPIConfig());

        if (!response.ok) {
          return null;
        }

        const data = await response.json();
        return data.category;
      } catch (error) {
        console.error('Erro ao buscar categoria:', error);
        return null;
      }
    }

    // ========== INTEGRAR COM ProductAPI EXISTENTE ==========
    // Verificar se j√° existe um ProductAPI e adicionar nossos m√©todos
    if (typeof ProductAPI !== 'undefined') {
      // Adicionar m√©todos ao ProductAPI existente
      ProductAPI.getCategoriesWithProductCount = getCategoriesWithProductCount;
      ProductAPI.getProductsByCategory = getProductsByCategory;
      ProductAPI.API_BASE_URL = API_BASE_URL;
    } else {
      // Se n√£o existir, criar objeto global
      window.ProductAPI = {
        getCategoriesWithProductCount,
        getProductsByCategory,
        API_BASE_URL,

        // M√©todos b√°sicos que devem existir (se n√£o existirem, crie fallbacks)
        getCategoryById: getCategoryById || async function (id) {
          try {
            const response = await fetch(`${API_BASE_URL}/categories/${id}`, getAPIConfig());
            const data = await response.json();
            return data.category;
          } catch (error) {
            console.error('Erro no fallback getCategoryById:', error);
            return null;
          }
        },

        updateCategory: ProductAPI?.updateCategory || async function (id, data) {
          try {
            const response = await fetch(`${API_BASE_URL}/categories/${id}`, {
              method: 'PUT',
              ...getAPIConfig(),
              body: JSON.stringify(data)
            });
            return await response.json();
          } catch (error) {
            console.error('Erro no fallback updateCategory:', error);
            return { success: false, error: error.message };
          }
        },

        createCategory: ProductAPI?.createCategory || async function (data) {
          try {
            const response = await fetch(`${API_BASE_URL}/categories`, {
              method: 'POST',
              ...getAPIConfig(),
              body: JSON.stringify(data)
            });
            return await response.json();
          } catch (error) {
            console.error('Erro no fallback createCategory:', error);
            return { success: false, error: error.message };
          }
        },

        deleteCategory: ProductAPI?.deleteCategory || async function (id) {
          try {
            const response = await fetch(`${API_BASE_URL}/categories/${id}`, {
              method: 'DELETE',
              ...getAPIConfig()
            });
            return await response.json();
          } catch (error) {
            console.error('Erro no fallback deleteCategory:', error);
            return { success: false, error: error.message };
          }
        }
      };
    }

    // ========== SISTEMA DE SELE√á√ÉO DE √çCONES ==========

      // Lista de √≠cones FontAwesome populares
      const fontAwesomeIcons = {
        solid: [
          'fa-tag', 'fa-tags', 'fa-box', 'fa-cube', 'fa-cubes', 'fa-gem', 'fa-ring',
          'fa-home', 'fa-store', 'fa-shopping-cart', 'fa-shopping-bag', 'fa-gift',
          'fa-star', 'fa-heart', 'fa-thumbs-up', 'fa-fire', 'fa-bolt', 'fa-magic',
          'fa-palette', 'fa-brush', 'fa-image', 'fa-camera', 'fa-photo-film',
          'fa-toolbox', 'fa-wrench', 'fa-screwdriver', 'fa-hammer', 'fa-ruler',
          'fa-robot', 'fa-gamepad', 'fa-dice', 'fa-puzzle-piece', 'fa-chess',
          'fa-book', 'fa-graduation-cap', 'fa-microscope', 'fa-atom',
          'fa-car', 'fa-bicycle', 'fa-motorcycle', 'fa-plane', 'fa-rocket',
          'fa-utensils', 'fa-mug-hot', 'fa-pizza-slice', 'fa-cake-candles',
          'fa-shirt', 'fa-hat-cowboy', 'fa-glasses', 'fa-watch', 'fa-ring'
        ],
        regular: [
          'fa-clock', 'fa-calendar', 'fa-flag', 'fa-bookmark', 'fa-star', 'fa-heart',
          'fa-comment', 'fa-envelope', 'fa-folder', 'fa-file', 'fa-image', 'fa-user'
        ],
        brands: [
          'fa-apple', 'fa-windows', 'fa-android', 'fa-playstation', 'fa-xbox',
          'fa-steam', 'fa-spotify', 'fa-youtube', 'fa-twitch', 'fa-discord'
        ]
      };

      // Emojis populares para categorias
      const popularEmojis = [
        'üè∫', 'üé®', 'üñºÔ∏è', 'üì∏', 'üîß', '‚öôÔ∏è', 'üß©', 'üéÆ', 'ü§ñ', 'üöó',
        '‚úàÔ∏è', 'üöÄ', 'üìö', 'üéì', 'üî¨', '‚öóÔ∏è', 'üçï', '‚òï', 'üéÇ', 'üëï',
        'üëí', 'üëì', '‚åö', 'üíç', 'üè†', 'üè™', 'üõí', 'üéÅ', '‚≠ê', '‚ù§Ô∏è',
        'üî•', '‚ö°', '‚ú®', 'üé≠', 'üé™', 'üèÜ', 'üéØ', 'üß∏', 'üé≤', '‚ôüÔ∏è',
        'üéß', 'üé∏', 'ü•Å', 'üé∫', 'üé¨', 'üì∫', 'üé•', 'üéôÔ∏è', 'üìª', 'üì±',
        'üíª', 'üñ•Ô∏è', '‚å®Ô∏è', 'üñ±Ô∏è', 'üìû', 'üì†', 'üìπ', 'üîç', 'üí°', 'üî¶',
        'üïØÔ∏è', 'üß≠', '‚è∞', '‚è≤Ô∏è', 'üìÖ', 'üìç', 'üìå', 'üñáÔ∏è', 'üìé', '‚úÇÔ∏è',
        'üìè', 'üìê', 'üßÆ', 'üìä', 'üìà', 'üìâ', 'üìã', 'üìÅ', 'üìÇ', 'üóÇÔ∏è',
        'üóÉÔ∏è', 'üóÑÔ∏è', 'üóëÔ∏è', 'üîí', 'üîë', 'üóùÔ∏è', 'üî®', '‚õèÔ∏è', '‚öíÔ∏è', 'üõ†Ô∏è',
        'üó°Ô∏è', '‚öîÔ∏è', 'üî´', 'üèπ', 'üõ°Ô∏è', 'üîß', 'üî©', '‚öôÔ∏è', 'üóúÔ∏è', '‚öñÔ∏è',
        'üîó', '‚õìÔ∏è', 'üß∞', 'üß≤', '‚öóÔ∏è', 'üß™', 'üß´', 'üß¨', 'üî¨', 'üî≠',
        'üì°', 'üíâ', 'üíä', 'ü©π', 'ü©∫', 'üö™', 'ü™ë', 'üõãÔ∏è', 'üõèÔ∏è', 'üõå',
        'üß∫', 'üßª', 'üöΩ', 'üöø', 'üõÅ', 'ü™í', 'üß¥', 'üß∑', 'üßπ', 'üßΩ',
        'üßº', 'ü™•', 'ü™í', 'üß∫', 'üõí', 'üö≤', 'üõµ', 'üèçÔ∏è', 'üöó', 'üöï',
        'üöô', 'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöê', 'üöö', 'üöõ',
        'üöú', 'üõª', 'üöî', 'üöç', 'üöò', 'üöñ', 'üö°', 'üö†', 'üöü', 'üöÉ',
        'üöã', 'üöû', 'üöù', 'üöÑ', 'üöÖ', 'üöà', 'üöÇ', 'üöÜ', 'üöá', 'üöä',
        'üöâ', '‚úàÔ∏è', 'üõ´', 'üõ¨', 'üõ©Ô∏è', 'üí∫', 'üõ∞Ô∏è', 'üöÄ', 'üõ∏', 'üöÅ',
        'üõ∂', '‚õµ', 'üö§', 'üõ•Ô∏è', 'üõ≥Ô∏è', '‚õ¥Ô∏è', 'üö¢', '‚öì', 'üöß', '‚õΩ',
        'üöè', 'üö¶', 'üö•', 'üó∫Ô∏è', 'üß≠', 'üé†', 'üé°', 'üé¢', 'üöÇ', 'üé™'
      ];

      // Vari√°veis para controle do seletor de √≠cones
      let selectedIconType = 'fa'; // 'fa' ou 'emoji'
      let selectedIconValue = 'fa-tag';
      let selectedIconClass = 'fas fa-tag';

      // Fun√ß√£o para abrir o seletor de √≠cones
      window.openIconPicker = function () {
        const modal = document.getElementById('iconPickerModal');
        modal.classList.add('show');

        // Carregar √≠cones
        loadIcons('all');

        // Atualizar preview com √≠cone atual
        const currentIcon = document.getElementById('iconPreview').innerHTML;
        const currentInput = document.getElementById('iconInput').value;

        if (currentIcon.includes('fa-')) {
          // √â um FontAwesome
          selectedIconType = 'fa';
          selectedIconValue = currentInput || 'fa-tag';
          selectedIconClass = currentInput.includes('fa-') ? currentInput : `fas ${currentInput}`;
        } else {
          // √â um emoji
          selectedIconType = 'emoji';
          selectedIconValue = currentIcon;
          selectedIconClass = currentIcon;
        }

        updateIconPreview();
      };

      // Fun√ß√£o para fechar o seletor
      function closeIconPicker() {
        const modal = document.getElementById('iconPickerModal');
        modal.classList.remove('show');
      }

      // Fun√ß√£o para carregar √≠cones na grid
      function loadIcons(category) {
        const grid = document.getElementById('iconsGrid');
        grid.innerHTML = '';

        let icons = [];

        if (category === 'all' || category === 'emoji') {
          // Adicionar emojis
          popularEmojis.forEach(emoji => {
            const div = document.createElement('div');
            div.className = 'icon-item';
            div.setAttribute('data-type', 'emoji');
            div.setAttribute('data-value', emoji);
            div.innerHTML = `
        <div style="font-size: 24px;">${emoji}</div>
        <div class="icon-name">Emoji</div>
      `;
            div.onclick = () => selectIconInGrid(emoji, 'emoji', emoji);
            grid.appendChild(div);
          });
        }

        if (category === 'all' || category === 'solid') {
          fontAwesomeIcons.solid.forEach(icon => {
            const div = document.createElement('div');
            div.className = 'icon-item';
            div.setAttribute('data-type', 'fa');
            div.setAttribute('data-value', icon);
            div.innerHTML = `
        <i class="fas ${icon}"></i>
        <div class="icon-name">${icon}</div>
      `;
            div.onclick = () => selectIconInGrid(icon, 'fa', `fas ${icon}`);
            grid.appendChild(div);
          });
        }

        if (category === 'all' || category === 'regular') {
          fontAwesomeIcons.regular.forEach(icon => {
            const div = document.createElement('div');
            div.className = 'icon-item';
            div.setAttribute('data-type', 'fa');
            div.setAttribute('data-value', icon);
            div.innerHTML = `
        <i class="far ${icon}"></i>
        <div class="icon-name">${icon}</div>
      `;
            div.onclick = () => selectIconInGrid(icon, 'fa', `far ${icon}`);
            grid.appendChild(div);
          });
        }

        if (category === 'all' || category === 'brands') {
          fontAwesomeIcons.brands.forEach(icon => {
            const div = document.createElement('div');
            div.className = 'icon-item';
            div.setAttribute('data-type', 'fa');
            div.setAttribute('data-value', icon);
            div.innerHTML = `
        <i class="fab ${icon}"></i>
        <div class="icon-name">${icon}</div>
      `;
            div.onclick = () => selectIconInGrid(icon, 'fa', `fab ${icon}`);
            grid.appendChild(div);
          });
        }
      }

      // Fun√ß√£o para selecionar √≠cone na grid
      function selectIconInGrid(value, type, fullClass) {
        // Remover sele√ß√£o anterior
        document.querySelectorAll('.icon-item.selected').forEach(item => {
          item.classList.remove('selected');
        });

        // Selecionar novo
        const items = document.querySelectorAll(`.icon-item[data-value="${value}"]`);
        items.forEach(item => {
          if (item.getAttribute('data-type') === type) {
            item.classList.add('selected');
          }
        });

        // Atualizar vari√°veis
        selectedIconType = type;
        selectedIconValue = value;
        selectedIconClass = fullClass;

        // Atualizar preview
        updateIconPreview();
      }

      // Atualizar preview do √≠cone selecionado
      function updateIconPreview() {
        const previewIcon = document.getElementById('previewIcon');
        const previewName = document.getElementById('previewName');
        const previewCode = document.getElementById('previewCode');

        if (selectedIconType === 'emoji') {
          previewIcon.parentElement.innerHTML = `<div style="font-size: 32px;">${selectedIconValue}</div>`;
          previewName.textContent = 'Emoji';
          previewCode.textContent = selectedIconValue;
        } else {
          previewIcon.parentElement.innerHTML = `<i class="${selectedIconClass}" style="font-size: 32px;"></i>`;
          previewName.textContent = selectedIconValue;
          previewCode.textContent = selectedIconClass;
        }
      }

      // Fun√ß√£o para selecionar o √≠cone e aplicar ao formul√°rio
      function selectIcon() {
        const iconPreview = document.getElementById('iconPreview');
        const iconInput = document.getElementById('iconInput');

        if (selectedIconType === 'emoji') {
          iconPreview.innerHTML = selectedIconValue;
          iconInput.value = selectedIconValue;
        } else {
          // Para FontAwesome, mostrar o √≠cone no preview
          iconPreview.innerHTML = `<i class="${selectedIconClass}"></i>`;
          iconInput.value = selectedIconClass.includes(' ') ? selectedIconClass : `fas ${selectedIconClass}`;
        }

        closeIconPicker();
        showNotification('√çcone selecionado com sucesso!', 'success');
      }

    // Busca de √≠cones
      document.addEventListener('DOMContentLoaded', function () {
        // Configurar busca
        const searchInput = document.getElementById('iconSearch');
        if (searchInput) {
          searchInput.addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase();
            const items = document.querySelectorAll('.icon-item');

            items.forEach(item => {
              const iconName = item.getAttribute('data-value').toLowerCase();
              const iconType = item.querySelector('.icon-name')?.textContent.toLowerCase() || '';

              if (iconName.includes(searchTerm) || iconType.includes(searchTerm)) {
                item.style.display = 'flex';
              } else {
                item.style.display = 'none';
              }
            });
          });
        }

        // Configurar categorias
        const categoryBtns = document.querySelectorAll('.category-btn');
        categoryBtns.forEach(btn => {
          btn.addEventListener('click', function () {
            categoryBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            const category = this.getAttribute('data-category');
            loadIcons(category);
          });
        });

        

        // Tornar o preview do √≠cone clic√°vel
        const iconPreview = document.getElementById('iconPreview');
        if (iconPreview) {
          iconPreview.style.cursor = 'pointer';
          iconPreview.addEventListener('click', openIconPicker);
        }

        // Tamb√©m tornar o input clic√°vel
        const iconInput = document.getElementById('iconInput');
        if (iconInput) {
          iconInput.readOnly = true;
          iconInput.style.cursor = 'pointer';
          iconInput.addEventListener('click', openIconPicker);
        }

        
      });

      // === FUN√á√ïES PRINCIPAIS ===

        // Carregar categorias da API
        async function loadCategories() {
          // ... seu c√≥digo existente ...
        }

        // Atualizar select de categorias pai
        function updateParentCategorySelect() {
          // ... seu c√≥digo existente ...
        }

        // ========== ADICIONE O EVENT LISTENER AQUI ==========

        // Este c√≥digo deve vir AP√ìS as vari√°veis serem definidas e ANTES do event listener existente
        document.addEventListener('DOMContentLoaded', function () {
          // Configurar busca
          const searchInput = document.getElementById('iconSearch');
          if (searchInput) {
            searchInput.addEventListener('input', function () {
              // ... c√≥digo existente ...
            });
          }

          // Configurar categorias
          const categoryBtns = document.querySelectorAll('.category-btn');
          categoryBtns.forEach(btn => {
            btn.addEventListener('click', function () {
              // ... c√≥digo existente ...
            });
          });

          // ========== ADICIONE ESTA PARTE ==========
          // Tornar o preview do √≠cone clic√°vel
          const iconPreview = document.getElementById('iconPreview');
          const iconInput = document.getElementById('iconInput');

          if (iconPreview && iconInput) {
            // Preview clic√°vel
            iconPreview.style.cursor = 'pointer';
            iconPreview.addEventListener('click', openIconPicker);

            // Input tamb√©m clic√°vel
            iconInput.readOnly = true;
            iconInput.style.cursor = 'pointer';
            iconInput.addEventListener('click', openIconPicker);

            // ========== ADICIONE ESTE EVENT LISTENER ==========
            // Atualizar √≠cone preview em tempo real quando digitar manualmente
            iconInput.addEventListener('input', function () {
              const value = this.value.trim();
              if (value.includes('fa-')) {
                // Se for FontAwesome
                iconPreview.innerHTML = `<i class="${value}"></i>`;
              } else if (value) {
                // Se for emoji ou texto
                iconPreview.innerHTML = value;
              }
            });
            // =================================================
          }
        });
    document.addEventListener('DOMContentLoaded', function () {
      // Adiciona o script do dashboard para logout e perfil
      const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
      if (!isLoggedIn) {
        window.location.href = 'login.html';
        return;
      }

      // Logout
      const logoutBtn = document.getElementById('logoutBtn');
      logoutBtn.addEventListener('click', function () {
        if (confirm('Tem certeza que deseja sair?')) {
          localStorage.removeItem('adminLoggedIn');
          localStorage.removeItem('adminEmail');
          window.location.href = 'login.html';
        }
      });

      // Update admin name from localStorage
      const adminEmail = localStorage.getItem('adminEmail');
      const profileName = document.querySelector('.profile-info h4');
      if (adminEmail) {
        profileName.textContent = adminEmail.split('@')[0];
      }

      // Atualizar avatar com primeira letra do nome
      const profileAvatar = document.querySelector('.profile-avatar');
      if (adminEmail && profileAvatar) {
        const firstName = adminEmail.split('@')[0];
        profileAvatar.textContent = firstName.charAt(0).toUpperCase();
      }
    });
    document.addEventListener('DOMContentLoaded', function () {
      console.log("üè∑Ô∏è Iniciando p√°gina de categorias...");

      // Verificar login
      const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
      if (!isLoggedIn) {
        window.location.href = 'login.html';
        return;
      }

      // Vari√°veis globais
      let allCategories = [];
      let categoryToDelete = null;
      let isEditing = false;

      // Elementos DOM
      const newCategoryBtn = document.getElementById('newCategoryBtn');
      const refreshBtn = document.getElementById('refreshBtn');
      const categoryForm = document.getElementById('categoryForm');
      const categoryFormData = document.getElementById('categoryFormData');
      const categoriesGrid = document.getElementById('categoriesGrid');
      const loadingState = document.getElementById('loadingState');
      const parentCategorySelect = document.getElementById('parentCategory');
      const categoryNameInput = document.getElementById('categoryName');
      const categorySlugInput = document.getElementById('categorySlug');
      const iconPreview = document.getElementById('iconPreview');
      const iconInput = document.getElementById('iconInput');
      const colorPicker = document.getElementById('colorPicker');
      const selectedColorInput = document.getElementById('selectedColor');
      const formTitle = document.getElementById('formTitle');
      const submitBtn = document.getElementById('submitBtn');
      const categoryIdInput = document.getElementById('categoryId');

      // === FUN√á√ïES PRINCIPAIS ===

      // Carregar categorias da API
      async function loadCategories() {
        try {
          console.log("üì• Carregando categorias da API...");

          // Mostrar loading
          loadingState.style.display = 'block';
          categoriesGrid.style.display = 'none';
          categoriesGrid.innerHTML = '';

          // DEBUG: Testar a API primeiro
          console.log("üß™ Testando API...");
          const testResponse = await fetch('http://localhost:5000/api/categories/with-count');
          const testData = await testResponse.json();
          console.log("üìä Teste API - Resposta:", testData);
          console.log("üìä Teste API - Primeira categoria:", testData.categories ? testData.categories[0] : 'Nenhuma');

          // Buscar categorias COM CONTAGEM DE PRODUTOS
          allCategories = await ProductAPI.getCategoriesWithProductCount();

          console.log(`‚úÖ ${allCategories.length} categorias carregadas`);

          // DEBUG: Mostrar detalhes das primeiras 3 categorias
          if (allCategories.length > 0) {
            console.log("üîç Detalhes das categorias:");
            allCategories.slice(0, 3).forEach((cat, index) => {
              console.log(`  ${index + 1}. ${cat.name}: product_count = ${cat.product_count} (tipo: ${typeof cat.product_count})`);
            });
          }

          // Ordenar categorias (principais primeiro, depois subcategorias)
          allCategories.sort((a, b) => {
            // Categorias principais primeiro (sem parent_id)
            if (!a.parent_id && b.parent_id) return -1;
            if (a.parent_id && !b.parent_id) return 1;

            // Ordenar por nome
            return a.name.localeCompare(b.name);
          });

          // Atualizar select de categorias pai
          updateParentCategorySelect();

          // Renderizar categorias
          renderCategories();

          // Esconder loading
          loadingState.style.display = 'none';
          categoriesGrid.style.display = 'grid';

        } catch (error) {
          console.error("‚ùå Erro ao carregar categorias:", error);
          showNotification('Erro ao carregar categorias: ' + error.message, 'error');

          loadingState.innerHTML = `
      <div style="color: #f44336;">
        <i class="fas fa-exclamation-triangle fa-2x"></i>
        <p style="margin-top: 10px;">Erro ao carregar categorias</p>
        <p style="font-size: 12px; color: #aaa;">${error.message}</p>
        <p style="font-size: 12px; color: #aaa;">Verifique se o servidor est√° rodando em http://localhost:5000</p>
        <button onclick="loadCategories()" style="margin-top: 10px; padding: 8px 15px; background: #7C3AED; color: white; border: none; border-radius: 5px; cursor: pointer;">
          <i class="fas fa-sync-alt"></i> Tentar novamente
        </button>
        <button onclick="testAPI()" style="margin-top: 10px; margin-left: 10px; padding: 8px 15px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer;">
          <i class="fas fa-bug"></i> Testar API
        </button>
      </div>
    `;
        }
      }

      // Adicione esta fun√ß√£o de teste
      async function testAPI() {
        try {
          console.log("üß™ Testando todas as APIs...");

          // Teste 1: Health check
          const health = await fetch('http://localhost:5000/api/health');
          console.log("‚úÖ Health check:", await health.json());

          // Teste 2: Categorias normais
          const categories = await fetch('http://localhost:5000/api/categories');
          const catData = await categories.json();
          console.log("‚úÖ Categorias normais:", catData.categories ? catData.categories.length : 0, "categorias");

          // Teste 3: Categorias com contagem
          const withCount = await fetch('http://localhost:5000/api/categories/with-count');
          const countData = await withCount.json();
          console.log("‚úÖ Categorias com contagem:", countData.categories ? countData.categories.length : 0, "categorias");

          if (countData.categories && countData.categories.length > 0) {
            console.log("üìä Exemplo de categoria com contagem:", {
              name: countData.categories[0].name,
              product_count: countData.categories[0].product_count,
              id: countData.categories[0].id
            });
          }

          alert('Teste completo! Verifique o console para detalhes.');
        } catch (error) {
          console.error('‚ùå Erro no teste da API:', error);
          alert('Erro ao testar API: ' + error.message);
        }
      }

      // Atualizar select de categorias pai
      function updateParentCategorySelect() {
        parentCategorySelect.innerHTML = '<option value="">Nenhuma (Categoria Principal)</option>';

        // Adicionar apenas categorias principais (sem parent_id)
        const mainCategories = allCategories.filter(cat => !cat.parent_id);

        mainCategories.forEach(category => {
          // N√£o permitir que uma categoria seja pai dela mesma (quando editar)
          const option = document.createElement('option');
          option.value = category.id;
          option.textContent = category.name;
          parentCategorySelect.appendChild(option);
        });
      }

      // Renderizar categorias no grid
      function renderCategories() {
        if (allCategories.length === 0) {
          categoriesGrid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
              <i class="fas fa-tags fa-3x" style="color: #7C3AED; opacity: 0.5;"></i>
              <h3 style="margin-top: 20px; color: #aaa;">Nenhuma categoria encontrada</h3>
              <p style="color: #888; margin-top: 10px;">Crie sua primeira categoria para organizar os produtos</p>
              <button onclick="showCategoryForm()" style="margin-top: 20px; padding: 10px 20px; background: #7C3AED; color: white; border: none; border-radius: 8px; cursor: pointer;">
                <i class="fas fa-plus"></i> Criar Primeira Categoria
              </button>
            </div>
          `;
          return;
        }

        let gridHTML = '';

        // Separar categorias principais e subcategorias
        const mainCategories = allCategories.filter(cat => !cat.parent_id);
        const subCategories = allCategories.filter(cat => cat.parent_id);

        // Renderizar categorias principais
        mainCategories.forEach(category => {
          gridHTML += createCategoryCard(category);

          // Renderizar subcategorias desta categoria
          const categorySubCategories = subCategories.filter(sub => sub.parent_id == category.id);
          if (categorySubCategories.length > 0) {
            gridHTML += `<div style="grid-column: 1 / -1; margin: 20px 0 10px 0; padding-left: 20px;">
                          <h4 style="color: #aaa; font-size: 14px; border-left: 3px solid ${getCategoryColor(category)}; padding-left: 10px;">
                            <i class="fas fa-sitemap"></i> Subcategorias de ${category.name}
                          </h4>
                        </div>`;

            categorySubCategories.forEach(subCategory => {
              gridHTML += createCategoryCard(subCategory, true);
            });
          }
        });

        categoriesGrid.innerHTML = gridHTML;
      }

      window.viewCategoryProducts = async function (categoryId, event = null) {
        if (event) event.stopPropagation();

        try {
          const category = allCategories.find(c => c.id == categoryId);
          if (!category) {
            showNotification('Categoria n√£o encontrada', 'error');
            return;
          }

          console.log(`üì¶ Carregando produtos da categoria "${category.name}"...`);

          // Mostrar loading
          showNotification(`Carregando produtos de ${category.name}...`, 'info');

          // Buscar produtos da categoria
          const response = await ProductAPI.getProductsByCategory(categoryId);

          if (response.products && response.products.length > 0) {
            // Abrir modal com os produtos
            showCategoryProductsModal(category, response.products);
          } else {
            showNotification(`Nenhum produto encontrado na categoria "${category.name}"`, 'warning');
          }

        } catch (error) {
          console.error('‚ùå Erro ao carregar produtos da categoria:', error);
          showNotification('Erro ao carregar produtos', 'error');
        }
      };

      // Fun√ß√£o para mostrar modal com produtos da categoria
      function showCategoryProductsModal(category, products) {
        // Criar modal
        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.innerHTML = `
    <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
      <button class="modal-close" onclick="this.parentElement.parentElement.remove()">
        <i class="fas fa-times"></i>
      </button>
      <h2 class="modal-title">
        <i class="fas fa-tags" style="color: ${category.color || '#7C3AED'}"></i>
        Produtos: ${category.name}
      </h2>
      <p style="color: #aaa; margin-bottom: 20px;">
        ${category.description || ''}
        <br>
        <small>Total: ${products.length} produto(s)</small>
      </p>
      
      <div style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: rgba(124, 58, 237, 0.1);">
              <th style="padding: 10px; text-align: left; border-bottom: 1px solid rgba(124, 58, 237, 0.3);">Produto</th>
              <th style="padding: 10px; text-align: left; border-bottom: 1px solid rgba(124, 58, 237, 0.3);">Pre√ßo</th>
              <th style="padding: 10px; text-align: left; border-bottom: 1px solid rgba(124, 58, 237, 0.3);">Estoque</th>
              <th style="padding: 10px; text-align: left; border-bottom: 1px solid rgba(124, 58, 237, 0.3);">Status</th>
              <th style="padding: 10px; text-align: left; border-bottom: 1px solid rgba(124, 58, 237, 0.3);">A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            ${products.map(product => `
              <tr>
                <td style="padding: 10px; border-bottom: 1px solid rgba(124, 58, 237, 0.1);">
                  <div style="display: flex; align-items: center; gap: 10px;">
                    ${product.image_url ?
            `<img src="${product.image_url}" alt="${product.name}" style="width: 40px; height: 40px; border-radius: 5px; object-fit: cover;">` :
            `<div style="width: 40px; height: 40px; background: rgba(124, 58, 237, 0.2); border-radius: 5px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-cube"></i>
                      </div>`
          }
                    <div>
                      <strong>${product.name}</strong><br>
                      <small style="color: #aaa;">${product.sku || `ID: ${product.id}`}</small>
                    </div>
                  </div>
                </td>
                <td style="padding: 10px; border-bottom: 1px solid rgba(124, 58, 237, 0.1);">
                  R$ ${parseFloat(product.price).toFixed(2)}
                </td>
                <td style="padding: 10px; border-bottom: 1px solid rgba(124, 58, 237, 0.1);">
                  ${product.stock} un.
                </td>
                <td style="padding: 10px; border-bottom: 1px solid rgba(124, 58, 237, 0.1);">
                  <span style="padding: 3px 8px; border-radius: 4px; font-size: 12px; background: ${product.status === 'active' ? 'rgba(76, 175, 80, 0.2)' : 'rgba(244, 67, 54, 0.2)'}; color: ${product.status === 'active' ? '#4CAF50' : '#f44336'}">
                    ${product.status === 'active' ? 'Ativo' : 'Inativo'}
                  </span>
                </td>
                <td style="padding: 10px; border-bottom: 1px solid rgba(124, 58, 237, 0.1);">
                  <button onclick="window.location.href='product-form.html?edit=${product.id}'" 
                          style="padding: 5px 10px; background: rgba(124, 58, 237, 0.1); border: 1px solid rgba(124, 58, 237, 0.3); color: #C084FC; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-edit"></i>
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
      
      <div class="modal-actions">
        <button class="btn-modal cancel" onclick="this.parentElement.parentElement.remove()">
          Fechar
        </button>
        <button class="btn-modal" style="background: linear-gradient(135deg, #DF38FF, #7C3AED);" 
                onclick="window.location.href='products.html?category=${encodeURIComponent(category.name)}'">
          <i class="fas fa-external-link-alt"></i> Ver todos na p√°gina de produtos
        </button>
      </div>
    </div>
  `;

        document.body.appendChild(modal);
      }

      function createCategoryCard(category, isSubcategory = false) {
        const parentCategory = category.parent_id ?
          allCategories.find(cat => cat.id == category.parent_id) : null;

        // USAR A CONTAGEM REAL DA API - ESSA √â A MUDAN√áA PRINCIPAL!
        const productCount = category.product_count || 0; // ‚Üê MUDE ESTA LINHA
        const salesCount = 0;   // Voc√™ pode implementar contagem de vendas depois

        // Cor da categoria (se tiver, sen√£o padr√£o)
        const color = getCategoryColor(category);

        // √çcone da categoria
        let iconHTML = 'üè∫';
        if (category.icon) {
          if (category.icon.includes('fa-')) {
            // Se for um √≠cone FontAwesome
            iconHTML = `<i class="fas ${category.icon}"></i>`;
          } else {
            // Se for emoji ou texto
            iconHTML = category.icon;
          }
        }

        // Status
        const isActive = category.status !== 'inactive';
        const statusClass = isActive ? 'status-active' : 'status-inactive';
        const statusIcon = isActive ? 'fas fa-check-circle' : 'fas fa-times-circle';
        const statusText = isActive ? 'Ativa' : 'Inativa';

        // Adicionar link para ver produtos se houver algum
        const viewProductsLink = productCount > 0 ? `
    <div style="margin-top: 10px;">
      <button onclick="viewCategoryProducts(${category.id})" 
              style="width: 100%; padding: 8px; background: rgba(124, 58, 237, 0.1); 
                     border: 1px solid rgba(124, 58, 237, 0.3); color: #C084FC; 
                     border-radius: 6px; cursor: pointer; font-size: 13px;">
        <i class="fas fa-eye"></i> Ver ${productCount} produto(s)
      </button>
    </div>
  ` : '';

        return `
<div class="category-card" data-category-id="${category.id}" style="cursor: pointer;" onclick="viewCategoryProducts(${category.id})">
  <div class="category-header">
    <div class="category-icon" style="color: ${color};">
      ${iconHTML}
    </div>
    <div class="category-actions">
      <button class="btn-action-small" onclick="editCategory(${category.id}); event.stopPropagation();">
        <i class="far fa-edit"></i>
      </button>
      <button class="btn-action-small" onclick="showDeleteModal(${category.id}, '${category.name.replace(/'/g, "\\'")}'); event.stopPropagation();">
        <i class="far fa-trash-alt"></i>
      </button>
    </div>
  </div>
  <div class="category-content">
    ${parentCategory ? `
      <div class="parent-category-badge" style="color: ${color};">
        <i class="fas fa-tags"></i> ${parentCategory.name}
      </div>
    ` : ''}
    
    <h3>${category.name}</h3>
    <p class="category-description">
      ${category.description || 'Sem descri√ß√£o'}
    </p>
    
    <div class="category-stats">
      <div class="stat-item">
        <span class="stat-number" style="color: ${productCount > 0 ? '#C084FC' : '#aaa'};">${productCount}</span>
        <span class="stat-label">Produtos</span>
      </div>
      <div class="stat-item">
        <span class="stat-number">${salesCount}</span>
        <span class="stat-label">Vendas</span>
      </div>
    </div>
    
    ${viewProductsLink}
    
    <div class="category-footer">
      <span class="category-status ${statusClass}">
        <i class="${statusIcon}"></i>
        ${statusText}
      </span>
      <span class="category-slug">
        ${category.slug}
      </span>
    </div>
  </div>
</div>
`;
      }

      // E na fun√ß√£o renderCategories, use esta l√≥gica para separar melhor:
      function renderCategories() {
        if (allCategories.length === 0) {
          categoriesGrid.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-tags fa-3x"></i>
        <h3>Nenhuma categoria encontrada</h3>
        <p>Crie sua primeira categoria para organizar os produtos</p>
        <button onclick="showCategoryForm()">
          <i class="fas fa-plus"></i> Criar Primeira Categoria
        </button>
      </div>
    `;
          return;
        }

        let gridHTML = '';

        // Separar categorias principais e subcategorias
        const mainCategories = allCategories.filter(cat => !cat.parent_id);
        const subCategories = allCategories.filter(cat => cat.parent_id);

        // Renderizar categorias principais
        mainCategories.forEach(category => {
          gridHTML += createCategoryCard(category);

          // Renderizar subcategorias desta categoria
          const categorySubCategories = subCategories.filter(sub => sub.parent_id == category.id);
          if (categorySubCategories.length > 0) {
            gridHTML += `
        <div class="subcategories-section" style="border-left-color: ${getCategoryColor(category)};">
          <h4>
            <i class="fas fa-sitemap"></i> Subcategorias de ${category.name}
          </h4>
          <div class="subcategories-grid">
      `;

            categorySubCategories.forEach(subCategory => {
              gridHTML += createCategoryCard(subCategory);
            });

            gridHTML += `
          </div>
        </div>
      `;
          }
        });

        categoriesGrid.innerHTML = gridHTML;
      }

      // Obter cor da categoria
      function getCategoryColor(category) {
        // Se a categoria tiver uma cor salva, usar
        if (category.color) return category.color;

        // Se n√£o, usar cor baseada no ID
        const colors = [
          '#C084FC', '#DF38FF', '#7C3AED', '#4CAF50',
          '#2196F3', '#FFC107', '#F44336', '#9C27B0'
        ];
        return colors[category.id % colors.length];
      }

      // === FORMUL√ÅRIO DE CATEGORIA ===

      // Mostrar formul√°rio
      window.showCategoryForm = function () {
        categoryForm.classList.add('show');
        newCategoryBtn.style.display = 'none';
        isEditing = false;
        formTitle.textContent = 'Nova Categoria';
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Categoria';
      };

      // Esconder formul√°rio
      window.hideCategoryForm = function () {
        categoryForm.classList.remove('show');
        newCategoryBtn.style.display = 'flex';
        categoryFormData.reset();
        categoryIdInput.value = '';
        iconPreview.innerHTML = 'üè∫';
        iconPreview.style.color = '#C084FC';
        selectedColorInput.value = '#C084FC';
        parentCategorySelect.value = '';
        isEditing = false;
      };

      // Editar categoria
      window.editCategory = async function (id) {
        try {
          console.log(`‚úèÔ∏è Editando categoria #${id}...`);

          const category = await ProductAPI.getCategoryById(id);
          if (!category) {
            showNotification('Categoria n√£o encontrada', 'error');
            return;
          }

          // Preencher formul√°rio
          categoryIdInput.value = category.id;
          categoryNameInput.value = category.name;
          categorySlugInput.value = category.slug;
          categoryDescription.value = category.description || '';
          parentCategorySelect.value = category.parent_id || '';
          document.getElementById('categoryImage').value = category.image_url || '';
          document.getElementById('displayOrder').value = 1; // Voc√™ pode adicionar este campo depois
          document.getElementById('isActive').checked = category.status !== 'inactive';

          // √çcone
          if (category.icon) {
            iconInput.value = category.icon;
            if (category.icon.includes('fa-')) {
              iconPreview.innerHTML = `<i class="fas ${category.icon}"></i>`;
            } else {
              iconPreview.innerHTML = category.icon;
            }
          }

          // Cor
          if (category.color) {
            iconPreview.style.color = category.color;
            selectedColorInput.value = category.color;

            // Selecionar cor no color picker
            document.querySelectorAll('.color-option').forEach(opt => {
              opt.classList.remove('selected');
              if (opt.getAttribute('data-color') === category.color) {
                opt.classList.add('selected');
              }
            });
          }

          // Mostrar formul√°rio
          categoryForm.classList.add('show');
          newCategoryBtn.style.display = 'none';
          isEditing = true;
          formTitle.textContent = 'Editar Categoria';
          submitBtn.innerHTML = '<i class="fas fa-save"></i> Atualizar Categoria';

          showNotification(`Editando categoria: ${category.name}`, 'info');

        } catch (error) {
          console.error("‚ùå Erro ao carregar categoria para edi√ß√£o:", error);
          showNotification('Erro ao carregar categoria', 'error');
        }
      };

      // Gerar slug a partir do nome
      categoryNameInput.addEventListener('input', function () {
        if (!isEditing && !categorySlugInput.value) {
          const slug = this.value
            .toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .replace(/[^\w\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .trim();
          categorySlugInput.value = slug;
        }
      });

      // Atualizar √≠cone preview
      iconInput.addEventListener('input', function () {
        const value = this.value.trim();
        if (value.includes('fa-')) {
          // Se for FontAwesome
          iconPreview.innerHTML = `<i class="fas ${value}"></i>`;
        } else if (value) {
          // Se for emoji ou texto
          iconPreview.innerHTML = value;
        }
      });

      // Seletor de cor
      document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function () {
          document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
          this.classList.add('selected');
          const color = this.getAttribute('data-color');
          selectedColorInput.value = color;
          iconPreview.style.color = color;
        });
      });

      // Submiss√£o do formul√°rio
      categoryFormData.addEventListener('submit', async function (e) {
        e.preventDefault();

        // Validar campos obrigat√≥rios
        if (!categoryNameInput.value.trim()) {
          showNotification('Nome da categoria √© obrigat√≥rio', 'error');
          return;
        }

        if (!categorySlugInput.value.trim()) {
          showNotification('Slug da categoria √© obrigat√≥rio', 'error');
          return;
        }

        // Preparar dados
        const categoryData = {
          name: categoryNameInput.value.trim(),
          slug: categorySlugInput.value.trim(),
          description: document.getElementById('categoryDescription').value.trim(),
          parent_id: parentCategorySelect.value || null,
          image_url: document.getElementById('categoryImage').value.trim() || null,
          icon: iconInput.value.trim() || 'üè∫',
          color: selectedColorInput.value,
          status: document.getElementById('isActive').checked ? 'active' : 'inactive'
          // Adicione display_order se tiver no banco
        };

        console.log(`${isEditing ? 'üì§ Atualizando' : 'üì§ Criando'} categoria:`, categoryData);

        // Mostrar loading
        const originalHTML = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
        submitBtn.disabled = true;

        try {
          let result;

          if (isEditing) {
            // Atualizar categoria existente
            const categoryId = categoryIdInput.value;
            result = await ProductAPI.updateCategory(categoryId, categoryData);
          } else {
            // Criar nova categoria
            result = await ProductAPI.createCategory(categoryData);
          }

          console.log("üì• Resposta da API:", result);

          if (result.success) {
            showNotification(
              `Categoria ${isEditing ? 'atualizada' : 'criada'} com sucesso!`,
              'success'
            );

            // Recarregar categorias
            await loadCategories();

            // Esconder formul√°rio
            hideCategoryForm();

          } else {
            showNotification(
              `Erro: ${result.error || `N√£o foi poss√≠vel ${isEditing ? 'atualizar' : 'criar'} a categoria`}`,
              'error'
            );
            submitBtn.innerHTML = originalHTML;
            submitBtn.disabled = false;
          }

        } catch (error) {
          console.error("‚ùå Erro no envio:", error);
          showNotification(`Erro: ${error.message || 'Falha na conex√£o'}`, 'error');
          submitBtn.innerHTML = originalHTML;
          submitBtn.disabled = false;
        }
      });

      // === MODAL DE EXCLUS√ÉO ===
      window.showDeleteModal = function (id, name) {
        categoryToDelete = id;
        const modal = document.getElementById('deleteModal');
        modal.classList.add('show');

        document.getElementById('deleteModalText').textContent =
          `Tem certeza que deseja excluir a categoria "${name}"? Esta a√ß√£o n√£o pode ser desfeita.`;
      };

      window.closeDeleteModal = function () {
        const modal = document.getElementById('deleteModal');
        modal.classList.remove('show');
        categoryToDelete = null;
      };

      window.confirmDelete = async function () {
        if (!categoryToDelete) return;

        try {
          console.log(`üóëÔ∏è Excluindo categoria ${categoryToDelete}...`);

          const result = await ProductAPI.deleteCategory(categoryToDelete);

          if (result.success) {
            showNotification('Categoria exclu√≠da com sucesso!', 'success');

            // Recarregar categorias
            await loadCategories();
          } else {
            showNotification(`Erro: ${result.error || 'N√£o foi poss√≠vel excluir a categoria'}`, 'error');
          }
        } catch (error) {
          console.error("‚ùå Erro ao excluir categoria:", error);
          showNotification('Erro ao excluir categoria', 'error');
        }

        closeDeleteModal();
      };

      // === EVENT LISTENERS ===
      newCategoryBtn.addEventListener('click', showCategoryForm);
      refreshBtn.addEventListener('click', () => {
        loadCategories();
        showNotification('Categorias atualizadas!', 'info');
      });

      // Carregar categorias inicialmente
      loadCategories();
    });

    // === FUN√á√ÉO DE NOTIFICA√á√ÉO ===
    function showNotification(message, type = 'info') {
      console.log(`üì¢ Notifica√ß√£o [${type}]: ${message}`);

      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #1a002b, #0b0015);
        border: 2px solid ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#7C3AED'};
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 15px;
        z-index: 10000;
        animation: slideIn 0.3s ease;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        max-width: 400px;
      `;

      const icon = type === 'success' ? 'check-circle' :
        type === 'error' ? 'exclamation-circle' :
          type === 'warning' ? 'exclamation-triangle' : 'info-circle';

      notification.innerHTML = `
        <i class="fas fa-${icon}" style="color: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#7C3AED'}; font-size: 20px;"></i>
        <span>${message}</span>
      `;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    // === ANIMA√á√ïES CSS ===
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes fadeOut {
        from { opacity: 1; transform: translateX(0); }
        to { opacity: 0; transform: translateX(100%); }
      }
      
      .label-required::after {
        content: " *";
        color: #f44336;
      }
    `;
    document.head.appendChild(style);
  </script>
</body>

</html>