<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Categorias - Admin</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/brands.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/solid.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/regular.min.css">
  <link rel="stylesheet" href="./../public/css/base.css">
  <link rel="stylesheet" href="./../admin/categories.css">
  <script src="./../public/js/api.js"></script>
  <script src="/public/js/config.js"></script>
</head>

<body>
  <div class="admin-wrapper">
    <!-- SIDEBAR COMPLETA (ATUALIZADA) -->
    <aside class="admin-sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">UNIVERSO PARALELO</div>
        <div class="admin-status">
          <span class="status-dot"></span>
          <span>Admin Online</span>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="section-title">Principal</div>
          <a href="dashboard.html" class="nav-link">
            <i class="fas fa-tachometer-alt"></i>
            <span>Dashboard</span>
          </a>
          <a href="products.html" class="nav-link">
            <i class="fas fa-cube"></i>
            <span>Produtos</span>
          </a>
          <a href="categories.html" class="nav-link active">
            <i class="fas fa-tags"></i>
            <span>Categorias</span>
          </a>
          <!-- href="orders.html" -->
          <a href="#" class="nav-link disabled">
            <i class="fas fa-shopping-cart"></i>
            <span>Pedidos</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="section-title">Conte√∫do</div>
          <a href="#" class="nav-link disabled">
            <i class="fas fa-images"></i>
            <span>Banners</span>
          </a>
          <a href="#" class="nav-link disabled">
            <i class="fas fa-star"></i>
            <span>Avalia√ß√µes</span>
          </a>
          <!-- Blog foi removido conforme solicitado -->
        </div>

        <div class="nav-section">
          <div class="section-title">Configura√ß√µes</div>
          <!-- Usu√°rios foi removido conforme solicitado -->
          <a href="#" class="nav-link disabled">
            <i class="fas fa-cog"></i>
            <span>Configura√ß√µes</span>
          </a>
          <a href="#" class="nav-link disabled">
            <i class="fas fa-chart-line"></i>
            <span>Relat√≥rios</span>
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <div class="admin-profile">
          <div class="profile-avatar">A</div>
          <div class="profile-info">
            <h4>Admin Master</h4>
            <p>Super Admin</p>
          </div>
        </div>
        <button class="btn-logout" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>
          <span>Sair</span>
        </button>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="admin-main">
      <!-- O resto do seu HTML atual (header, formul√°rio, grid, modal) -->
      <header class="categories-header">
        <div class="header-title">
          <h1><i class="fas fa-tags"></i> Gerenciar Categorias</h1>
          <p>Organize seus produtos em categorias e subcategorias</p>
        </div>
        <div class="categories-header-buttons">
          <button class="btn-new-category" id="refreshBtn">
            <i class="fas fa-sync-alt"></i>
            Atualizar
          </button>
          <button class="btn-new-category" id="newCategoryBtn">
            <i class="fas fa-plus"></i>
            Nova Categoria
          </button>
        </div>
      </header>

      <!-- Formul√°rio de Categoria (Oculto por padr√£o) -->
      <div class="category-form-container" id="categoryForm">
        <div class="form-header">
          <h2><i class="fas fa-plus-circle"></i> <span id="formTitle">Nova Categoria</span></h2>
          <button class="btn-close-form" onclick="hideCategoryForm()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <form id="categoryFormData">
          <input type="hidden" id="categoryId" value="">

          <div class="form-grid">
            <div class="form-group">
              <label class="label-required">Nome da Categoria</label>
              <input type="text" class="form-control" id="categoryName" placeholder="Ex: Esculturas 3D" required>
            </div>

            <div class="form-group">
              <label class="label-required">Slug (URL)</label>
              <input type="text" class="form-control" id="categorySlug" placeholder="ex: esculturas-3d" required>
              <small style="color: #666; font-size: 12px;">URL amig√°vel para a categoria (sem espa√ßos, use
                h√≠fens)</small>
            </div>
          </div>

          <div class="form-group">
            <label>Descri√ß√£o</label>
            <textarea class="form-control" id="categoryDescription"
              placeholder="Descreva a categoria em poucas palavras..." rows="3"></textarea>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label>√çcone (Emoji ou Texto)</label>
              <div class="icon-selector">
                <div class="icon-preview" id="iconPreview" onclick="openIconPicker()">üè∫</div>
                <input type="text" id="iconInput" class="form-control" placeholder="Clique para selecionar √≠cone"
                  style="flex: 1; margin-left: 10px; cursor: pointer;" onclick="openIconPicker()" readonly>
              </div>
              <small style="color: #666; font-size: 12px;">Digite um emoji ou nome de √≠cone FontAwesome (ex:
                fa-tag)</small>
            </div>

            <div class="form-group">
              <label>Cor do √çcone</label>
              <div class="color-picker" id="colorPicker">
                <div class="color-option selected" style="background: #C084FC;" data-color="#C084FC"></div>
                <div class="color-option" style="background: #DF38FF;" data-color="#DF38FF"></div>
                <div class="color-option" style="background: #7C3AED;" data-color="#7C3AED"></div>
                <div class="color-option" style="background: #4CAF50;" data-color="#4CAF50"></div>
                <div class="color-option" style="background: #2196F3;" data-color="#2196F3"></div>
                <div class="color-option" style="background: #FFC107;" data-color="#FFC107"></div>
                <div class="color-option" style="background: #F44336;" data-color="#F44336"></div>
                <div class="color-option" style="background: #9C27B0;" data-color="#9C27B0"></div>
              </div>
              <input type="hidden" id="selectedColor" value="#C084FC">
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label>Categoria Pai</label>
              <select class="form-control" id="parentCategory">
                <option value="">Nenhuma (Categoria Principal)</option>
                <!-- Categorias ser√£o carregadas aqui -->
              </select>
            </div>

            <div class="form-group">
              <label>Ordem de Exibi√ß√£o</label>
              <input type="number" class="form-control" id="displayOrder" placeholder="1" min="1" value="1">
            </div>
          </div>

          <div class="form-group">
            <label>Imagem da Categoria (URL)</label>
            <input type="url" class="form-control" id="categoryImage"
              placeholder="https://exemplo.com/imagem-categoria.jpg">
            <small style="color: #666; font-size: 12px;">URL de uma imagem representativa da categoria</small>
          </div>

          <div style="margin: 20px 0;">
            <label style="display: flex; align-items: center; gap: 10px;">
              <input type="checkbox" id="isActive" checked>
              <span>Categoria ativa (vis√≠vel na loja)</span>
            </label>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" onclick="hideCategoryForm()">
              Cancelar
            </button>
            <button type="submit" class="btn-submit" id="submitBtn">
              <i class="fas fa-save"></i>
              Salvar Categoria
            </button>
          </div>
        </form>
      </div>

      <!-- Loading State -->
      <div id="loadingState" style="text-align: center; padding: 40px;">
        <i class="fas fa-spinner fa-spin fa-2x" style="color: #7C3AED;"></i>
        <p style="margin-top: 10px; color: #aaa;">Carregando categorias...</p>
      </div>

      <!-- Grid de Categorias -->
      <div class="categories-grid" id="categoriesGrid" style="display: none;">
        <!-- Categorias ser√£o carregadas aqui dinamicamente -->
      </div>

      <!-- Modal de Confirma√ß√£o -->
      <div class="modal" id="deleteModal">
        <div class="modal-content">
          <button class="modal-close" onclick="closeDeleteModal()">
            <i class="fas fa-times"></i>
          </button>
          <h2 class="modal-title">Excluir Categoria</h2>
          <p class="modal-text" id="deleteModalText">
            Tem certeza que deseja excluir esta categoria? Esta a√ß√£o n√£o pode ser desfeita.
          </p>
          <div class="modal-actions">
            <button class="btn-modal cancel" onclick="closeDeleteModal()">
              Cancelar
            </button>
            <button class="btn-modal delete" onclick="confirmDelete()">
              Sim, excluir
            </button>
          </div>
        </div>
      </div>

      <!-- Modal de Sele√ß√£o de √çcones FontAwesome -->
      <div class="modal" id="iconPickerModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
          <button class="modal-close" onclick="closeIconPicker()">
            <i class="fas fa-times"></i>
          </button>
      
          <h2 class="modal-title">
            <i class="fas fa-icons"></i> Selecione um √çcone
          </h2>
      
          <div class="icon-picker-header">
            <div class="search-container">
              <i class="fas fa-search"></i>
              <input type="text" id="iconSearch" placeholder="Buscar √≠cones (ex: tag, home, user...)">
            </div>
            <div class="icon-categories" id="iconCategories">
              <button class="category-btn active" data-category="all">Todos</button>
              <button class="category-btn" data-category="solid">Solid</button>
              <button class="category-btn" data-category="regular">Regular</button>
              <button class="category-btn" data-category="brands">Brands</button>
              <button class="category-btn" data-category="emoji">Emojis</button>
            </div>
          </div>
      
          <div class="icons-grid-container">
            <div class="icons-grid" id="iconsGrid">
              <!-- √çcones ser√£o carregados aqui -->
            </div>
          </div>
      
          <div class="selected-icon-preview" id="selectedIconPreview">
            <div class="preview-box">
              <i class="fas fa-tag" id="previewIcon"></i>
              <div class="preview-info">
                <span id="previewName">fa-tag</span>
                <small id="previewCode">fas fa-tag</small>
              </div>
            </div>
            <div class="modal-actions">
              <button class="btn-modal cancel" onclick="closeIconPicker()">
                Cancelar
              </button>
              <button class="btn-modal" onclick="selectIcon()" style="background: linear-gradient(135deg, #DF38FF, #7C3AED);">
                <i class="fas fa-check"></i> Selecionar √çcone
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ============================================
    // ===== CONFIGURA√á√ÉO DA API - PRODU√á√ÉO ======
    // ============================================
    // Detecta automaticamente se est√° em localhost ou produ√ß√£o
    const IS_LOCALHOST = window.location.hostname === 'localhost' ||
      window.location.hostname === '127.0.0.1';

    // URLs corretas para cada ambiente
    const API_BASE_URL = IS_LOCALHOST
      ? 'http://localhost:5000/api'
      : 'https://upuniversestorege.onrender.com/api';  // <<< URL DO SEU RENDER

    console.log('üöÄ Ambiente detectado:', IS_LOCALHOST ? 'local' : 'produ√ß√£o (Render)');
    console.log('üåê API Base URL:', API_BASE_URL);

    // ============================================
    // ===== API CLIENT COMPLETO E OTIMIZADO =====
    // ============================================
    window.ProductAPI = {
      API_BASE_URL: API_BASE_URL,

      // Headers padr√£o para JSON
      getHeaders(includeContentType = true) {
        const headers = {
          'Accept': 'application/json'
        };
        if (includeContentType) {
          headers['Content-Type'] = 'application/json';
        }
        return headers;
      },

      // Requisi√ß√£o com timeout e tratamento de erro unificado
      async request(endpoint, options = {}, timeout = 30000) {
        const url = endpoint.startsWith('http') ? endpoint : `${API_BASE_URL}${endpoint}`;
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);

        try {
          console.log(`üì° ${options.method || 'GET'} ${url}`);

          const response = await fetch(url, {
            ...options,
            signal: controller.signal,
            headers: this.getHeaders(!(options.body instanceof FormData))
          });

          clearTimeout(timeoutId);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          // Verificar se a resposta √© JSON
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            return await response.json();
          }

          const text = await response.text();
          try {
            return JSON.parse(text);
          } catch {
            return { success: false, error: 'Resposta n√£o JSON' };
          }
        } catch (error) {
          clearTimeout(timeoutId);
          console.error(`‚ùå Erro na requisi√ß√£o ${url}:`, error);
          throw error;
        }
      },

      // ========== CATEGORIAS ==========
      async getCategoriesWithProductCount() {
        try {
          const data = await this.request('/categories/with-count');
          return data.categories || [];
        } catch (error) {
          console.error('‚ùå Erro ao buscar categorias com contagem:', error);
          // Fallback para categorias normais
          return this.getAllCategories();
        }
      },

      async getAllCategories() {
        try {
          const data = await this.request('/categories');
          return data.categories || [];
        } catch (error) {
          console.error('‚ùå Erro ao buscar categorias:', error);
          return [];
        }
      },

      async getCategoryById(id) {
        try {
          const data = await this.request(`/categories/${id}`);
          return data.category || null;
        } catch (error) {
          console.error(`‚ùå Erro ao buscar categoria ${id}:`, error);
          return null;
        }
      },

      async getProductsByCategory(categoryId) {
        try {
          // Tenta primeiro pela rota espec√≠fica de produtos por categoria
          try {
            const data = await this.request(`/categories/${categoryId}/products`);
            return data;
          } catch (error) {
            // Fallback: tenta buscar por nome da categoria
            const category = await this.getCategoryById(categoryId);
            if (category) {
              return await this.getProductsByCategoryName(category.name);
            }
            return { products: [] };
          }
        } catch (error) {
          console.error('‚ùå Erro ao buscar produtos por categoria:', error);
          return { products: [] };
        }
      },

      async getProductsByCategoryName(categoryName) {
        try {
          const data = await this.request(`/products/category/${encodeURIComponent(categoryName)}`);
          return data;
        } catch (error) {
          console.error('‚ùå Erro ao buscar produtos por nome:', error);
          return { products: [] };
        }
      },

      async createCategory(data) {
        try {
          const result = await this.request('/categories', {
            method: 'POST',
            body: JSON.stringify(data)
          });
          return result.success ? result : { success: false, error: result.error || 'Erro ao criar categoria' };
        } catch (error) {
          console.error('‚ùå Erro ao criar categoria:', error);
          return { success: false, error: error.message };
        }
      },

      async updateCategory(id, data) {
        try {
          const result = await this.request(`/categories/${id}`, {
            method: 'PUT',
            body: JSON.stringify(data)
          });
          return result.success ? result : { success: false, error: result.error || 'Erro ao atualizar categoria' };
        } catch (error) {
          console.error(`‚ùå Erro ao atualizar categoria ${id}:`, error);
          return { success: false, error: error.message };
        }
      },

      async deleteCategory(id) {
        try {
          const result = await this.request(`/categories/${id}`, {
            method: 'DELETE'
          });
          return result.success ? result : { success: false, error: result.error || 'Erro ao deletar categoria' };
        } catch (error) {
          console.error(`‚ùå Erro ao deletar categoria ${id}:`, error);
          return { success: false, error: error.message };
        }
      },

      // ========== PRODUTOS ==========
      async getAllProducts(filters = {}) {
        try {
          const params = new URLSearchParams();
          if (filters.category) params.append('category', filters.category);
          if (filters.category_id) params.append('category_id', filters.category_id);
          if (filters.status) params.append('status', filters.status);
          if (filters.featured) params.append('featured', filters.featured);
          if (filters.search) params.append('search', filters.search);
          if (filters.limit) params.append('limit', filters.limit);

          const query = params.toString() ? `?${params.toString()}` : '';
          const data = await this.request(`/products${query}`);
          return data.products || [];
        } catch (error) {
          console.error('‚ùå Erro ao buscar produtos:', error);
          return [];
        }
      }
    };

    // ============================================
    // ===== SISTEMA DE √çCONES (mantido igual) ====
    // ============================================
    const fontAwesomeIcons = {
      solid: [
        'fa-tag', 'fa-tags', 'fa-box', 'fa-cube', 'fa-cubes', 'fa-gem', 'fa-ring',
        'fa-home', 'fa-store', 'fa-shopping-cart', 'fa-shopping-bag', 'fa-gift',
        'fa-star', 'fa-heart', 'fa-thumbs-up', 'fa-fire', 'fa-bolt', 'fa-magic',
        'fa-palette', 'fa-brush', 'fa-image', 'fa-camera', 'fa-photo-film',
        'fa-toolbox', 'fa-wrench', 'fa-screwdriver', 'fa-hammer', 'fa-ruler',
        'fa-robot', 'fa-gamepad', 'fa-dice', 'fa-puzzle-piece', 'fa-chess',
        'fa-book', 'fa-graduation-cap', 'fa-microscope', 'fa-atom',
        'fa-car', 'fa-bicycle', 'fa-motorcycle', 'fa-plane', 'fa-rocket',
        'fa-utensils', 'fa-mug-hot', 'fa-pizza-slice', 'fa-cake-candles',
        'fa-shirt', 'fa-hat-cowboy', 'fa-glasses', 'fa-watch', 'fa-ring'
      ],
      regular: [
        'fa-clock', 'fa-calendar', 'fa-flag', 'fa-bookmark', 'fa-star', 'fa-heart',
        'fa-comment', 'fa-envelope', 'fa-folder', 'fa-file', 'fa-image', 'fa-user'
      ],
      brands: [
        'fa-apple', 'fa-windows', 'fa-android', 'fa-playstation', 'fa-xbox',
        'fa-steam', 'fa-spotify', 'fa-youtube', 'fa-twitch', 'fa-discord'
      ]
    };

    const popularEmojis = [
      'üè∫', 'üé®', 'üñºÔ∏è', 'üì∏', 'üîß', '‚öôÔ∏è', 'üß©', 'üéÆ', 'ü§ñ', 'üöó',
      '‚úàÔ∏è', 'üöÄ', 'üìö', 'üéì', 'üî¨', '‚öóÔ∏è', 'üçï', '‚òï', 'üéÇ', 'üëï',
      'üëí', 'üëì', '‚åö', 'üíç', 'üè†', 'üè™', 'üõí', 'üéÅ', '‚≠ê', '‚ù§Ô∏è',
      'üî•', '‚ö°', '‚ú®', 'üé≠', 'üé™', 'üèÜ', 'üéØ', 'üß∏', 'üé≤', '‚ôüÔ∏è',
      'üéß', 'üé∏', 'ü•Å', 'üé∫', 'üé¨', 'üì∫', 'üé•', 'üéôÔ∏è', 'üìª', 'üì±'
    ];

    let selectedIconType = 'fa';
    let selectedIconValue = 'fa-tag';
    let selectedIconClass = 'fas fa-tag';

    window.openIconPicker = function () {
      const modal = document.getElementById('iconPickerModal');
      if (modal) modal.classList.add('show');
      loadIcons('all');
      updateIconPreview();
    };

    window.closeIconPicker = function () {
      const modal = document.getElementById('iconPickerModal');
      if (modal) modal.classList.remove('show');
    };

    function loadIcons(category) {
      const grid = document.getElementById('iconsGrid');
      if (!grid) return;

      grid.innerHTML = '';

      const addIcon = (type, value, html, fullClass) => {
        const div = document.createElement('div');
        div.className = 'icon-item';
        div.setAttribute('data-type', type);
        div.setAttribute('data-value', value);
        div.innerHTML = html;
        div.onclick = () => selectIconInGrid(value, type, fullClass || value);
        grid.appendChild(div);
      };

      if (category === 'all' || category === 'emoji') {
        popularEmojis.forEach(emoji => {
          addIcon('emoji', emoji, `<div style="font-size: 24px;">${emoji}</div><div class="icon-name">Emoji</div>`);
        });
      }

      if (category === 'all' || category === 'solid') {
        fontAwesomeIcons.solid.forEach(icon => {
          addIcon('fa', icon, `<i class="fas ${icon}"></i><div class="icon-name">${icon}</div>`, `fas ${icon}`);
        });
      }

      if (category === 'all' || category === 'regular') {
        fontAwesomeIcons.regular.forEach(icon => {
          addIcon('fa', icon, `<i class="far ${icon}"></i><div class="icon-name">${icon}</div>`, `far ${icon}`);
        });
      }

      if (category === 'all' || category === 'brands') {
        fontAwesomeIcons.brands.forEach(icon => {
          addIcon('fa', icon, `<i class="fab ${icon}"></i><div class="icon-name">${icon}</div>`, `fab ${icon}`);
        });
      }
    }

    function selectIconInGrid(value, type, fullClass) {
      document.querySelectorAll('.icon-item.selected').forEach(item => item.classList.remove('selected'));

      document.querySelectorAll(`.icon-item[data-value="${value}"]`).forEach(item => {
        if (item.getAttribute('data-type') === type) {
          item.classList.add('selected');
        }
      });

      selectedIconType = type;
      selectedIconValue = value;
      selectedIconClass = fullClass;
      updateIconPreview();
    }

    function updateIconPreview() {
      const previewIcon = document.getElementById('previewIcon');
      const previewName = document.getElementById('previewName');
      const previewCode = document.getElementById('previewCode');

      if (!previewIcon || !previewName || !previewCode) return;

      if (selectedIconType === 'emoji') {
        previewIcon.parentElement.innerHTML = `<div style="font-size: 32px;">${selectedIconValue}</div>`;
        previewName.textContent = 'Emoji';
        previewCode.textContent = selectedIconValue;
      } else {
        previewIcon.parentElement.innerHTML = `<i class="${selectedIconClass}" style="font-size: 32px;"></i>`;
        previewName.textContent = selectedIconValue;
        previewCode.textContent = selectedIconClass;
      }
    }

    window.selectIcon = function () {
      const iconPreview = document.getElementById('iconPreview');
      const iconInput = document.getElementById('iconInput');

      if (!iconPreview || !iconInput) return;

      if (selectedIconType === 'emoji') {
        iconPreview.innerHTML = selectedIconValue;
        iconInput.value = selectedIconValue;
      } else {
        iconPreview.innerHTML = `<i class="${selectedIconClass}"></i>`;
        iconInput.value = selectedIconClass.includes(' ') ? selectedIconClass : `fas ${selectedIconClass}`;
      }

      closeIconPicker();
      showNotification('√çcone selecionado com sucesso!', 'success');
    };

    // ============================================
    // ===== NOTIFICA√á√ïES =====
    // ============================================
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              background: linear-gradient(135deg, #1a002b, #0b0015);
              border: 2px solid ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#7C3AED'};
              color: white;
              padding: 15px 25px;
              border-radius: 12px;
              display: flex;
              align-items: center;
              gap: 15px;
              z-index: 10000;
              animation: slideIn 0.3s ease;
              box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
              max-width: 400px;
          `;

      const icon = type === 'success' ? 'check-circle' :
        type === 'error' ? 'exclamation-circle' :
          type === 'warning' ? 'exclamation-triangle' : 'info-circle';

      notification.innerHTML = `
              <i class="fas fa-${icon}" style="color: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#7C3AED'}; font-size: 20px;"></i>
              <span>${message}</span>
          `;

      document.body.appendChild(notification);
      setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    // ============================================
    // ===== INICIALIZA√á√ÉO PRINCIPAL =====
    // ============================================
    document.addEventListener('DOMContentLoaded', async function () {
      console.log('üè∑Ô∏è Iniciando p√°gina de categorias...');
      console.log('üåê Conectando √† API:', API_BASE_URL);
      console.log('üîó Frontend Vercel:', window.location.href);
      console.log('üì° Backend Render:', API_BASE_URL.replace('/api', ''));
      console.log('üíæ Banco Aiven: via backend Render');

      // === VERIFICA√á√ÉO DE LOGIN ===
      const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
      if (!isLoggedIn) {
        window.location.href = 'login.html';
        return;
      }

      // === VARI√ÅVEIS GLOBAIS ===
      let allCategories = [];
      let categoryToDelete = null;
      let isEditing = false;

      // === ELEMENTOS DOM ===
      const elements = {
        newCategoryBtn: document.getElementById('newCategoryBtn'),
        refreshBtn: document.getElementById('refreshBtn'),
        categoryForm: document.getElementById('categoryForm'),
        categoryFormData: document.getElementById('categoryFormData'),
        categoriesGrid: document.getElementById('categoriesGrid'),
        loadingState: document.getElementById('loadingState'),
        parentCategorySelect: document.getElementById('parentCategory'),
        categoryName: document.getElementById('categoryName'),
        categorySlug: document.getElementById('categorySlug'),
        categoryDescription: document.getElementById('categoryDescription'),
        iconPreview: document.getElementById('iconPreview'),
        iconInput: document.getElementById('iconInput'),
        selectedColor: document.getElementById('selectedColor'),
        formTitle: document.getElementById('formTitle'),
        submitBtn: document.getElementById('submitBtn'),
        categoryId: document.getElementById('categoryId')
      };

      // === FUN√á√ïES PRINCIPAIS ===
      async function loadCategories() {
        try {
          console.log('üì• Carregando categorias via Render...');

          elements.loadingState.style.display = 'block';
          elements.categoriesGrid.style.display = 'none';

          // Usar o ProductAPI j√° configurado com a URL correta
          allCategories = await ProductAPI.getCategoriesWithProductCount();
          console.log(`‚úÖ ${allCategories.length} categorias carregadas do banco Aiven via Render`);

          // Ordenar categorias
          allCategories.sort((a, b) => {
            if (!a.parent_id && b.parent_id) return -1;
            if (a.parent_id && !b.parent_id) return 1;
            return (a.name || '').localeCompare(b.name || '');
          });

          updateParentCategorySelect();
          renderCategories();

          elements.loadingState.style.display = 'none';
          elements.categoriesGrid.style.display = 'grid';

        } catch (error) {
          console.error('‚ùå Erro ao carregar categorias:', error);

          elements.loadingState.innerHTML = `
                      <div style="color: #f44336; text-align: center; padding: 40px;">
                          <i class="fas fa-exclamation-triangle fa-2x"></i>
                          <h3 style="margin: 15px 0; color: white;">Erro de Conex√£o</h3>
                          <p style="color: #aaa; margin-bottom: 10px;">
                              N√£o foi poss√≠vel conectar ao servidor no Render.
                          </p>
                          <p style="font-size: 12px; color: #888; margin-bottom: 20px;">
                              API: ${API_BASE_URL}<br>
                              Frontend: ${window.location.href}<br>
                              Erro: ${error.message || 'Falha na conex√£o'}
                          </p>
                          <button onclick="window.location.reload()" 
                                  style="padding: 10px 20px; background: #7C3AED; color: white; 
                                         border: none; border-radius: 5px; cursor: pointer;">
                              <i class="fas fa-sync-alt"></i> Tentar Novamente
                          </button>
                      </div>
                  `;
          elements.loadingState.style.display = 'block';
          elements.categoriesGrid.style.display = 'none';
        }
      }

      function updateParentCategorySelect() {
        if (!elements.parentCategorySelect) return;

        elements.parentCategorySelect.innerHTML = '<option value="">Nenhuma (Categoria Principal)</option>';

        const mainCategories = allCategories.filter(cat => !cat.parent_id);
        mainCategories.forEach(category => {
          const option = document.createElement('option');
          option.value = category.id;
          option.textContent = category.name;
          elements.parentCategorySelect.appendChild(option);
        });
      }

      function renderCategories() {
        if (!elements.categoriesGrid) return;

        if (allCategories.length === 0) {
          elements.categoriesGrid.innerHTML = `
                      <div style="grid-column: 1 / -1; text-align: center; padding: 60px;">
                          <i class="fas fa-tags fa-3x" style="color: #7C3AED; opacity: 0.5;"></i>
                          <h3 style="margin-top: 20px; color: #aaa;">Nenhuma categoria encontrada</h3>
                          <p style="color: #888; margin-top: 10px;">Crie sua primeira categoria no banco Aiven</p>
                          <button onclick="window.showCategoryForm()" 
                                  style="margin-top: 20px; padding: 12px 24px; background: #7C3AED; 
                                         color: white; border: none; border-radius: 8px; cursor: pointer;">
                              <i class="fas fa-plus"></i> Criar Primeira Categoria
                          </button>
                      </div>
                  `;
          return;
        }

        let gridHTML = '';
        const mainCategories = allCategories.filter(cat => !cat.parent_id);
        const subCategories = allCategories.filter(cat => cat.parent_id);

        mainCategories.forEach(category => {
          gridHTML += createCategoryCard(category);

          const categorySubCategories = subCategories.filter(sub => sub.parent_id == category.id);
          if (categorySubCategories.length > 0) {
            gridHTML += `
                          <div style="grid-column: 1 / -1; margin: 20px 0 10px 0; padding-left: 20px;">
                              <h4 style="color: #aaa; font-size: 14px; border-left: 3px solid ${getCategoryColor(category)}; padding-left: 10px;">
                                  <i class="fas fa-sitemap"></i> Subcategorias de ${category.name}
                              </h4>
                          </div>
                      `;

            categorySubCategories.forEach(subCategory => {
              gridHTML += createCategoryCard(subCategory);
            });
          }
        });

        elements.categoriesGrid.innerHTML = gridHTML;
      }

      function createCategoryCard(category) {
        const parentCategory = category.parent_id ?
          allCategories.find(cat => cat.id == category.parent_id) : null;

        const productCount = category.product_count || 0;
        const color = getCategoryColor(category);

        let iconHTML = 'üè∫';
        if (category.icon) {
          iconHTML = category.icon.includes('fa-')
            ? `<i class="${category.icon}"></i>`
            : category.icon;
        }

        const isActive = category.status !== 'inactive';
        const statusClass = isActive ? 'status-active' : 'status-inactive';
        const statusIcon = isActive ? 'fas fa-check-circle' : 'fas fa-times-circle';
        const statusText = isActive ? 'Ativa' : 'Inativa';

        return `
                  <div class="category-card" data-category-id="${category.id}" style="cursor: pointer;" 
                       onclick="viewCategoryProducts(${category.id})">
                      <div class="category-header">
                          <div class="category-icon" style="color: ${color};">${iconHTML}</div>
                          <div class="category-actions">
                              <button class="btn-action-small" onclick="editCategory(${category.id}); event.stopPropagation();">
                                  <i class="far fa-edit"></i>
                              </button>
                              <button class="btn-action-small" onclick="showDeleteModal(${category.id}, '${category.name.replace(/'/g, "\\'")}'); event.stopPropagation();">
                                  <i class="far fa-trash-alt"></i>
                              </button>
                          </div>
                      </div>
                      <div class="category-content">
                          ${parentCategory ? `
                              <div class="parent-category-badge" style="color: ${color};">
                                  <i class="fas fa-tags"></i> ${parentCategory.name}
                              </div>
                          ` : ''}
                          <h3>${category.name}</h3>
                          <p class="category-description">${category.description || 'Sem descri√ß√£o'}</p>
                          <div class="category-stats">
                              <div class="stat-item">
                                  <span class="stat-number" style="color: ${productCount > 0 ? '#C084FC' : '#aaa'};">${productCount}</span>
                                  <span class="stat-label">Produtos</span>
                              </div>
                          </div>
                          ${productCount > 0 ? `
                              <div style="margin-top: 10px;">
                                  <button onclick="viewCategoryProducts(${category.id}); event.stopPropagation();" 
                                          style="width: 100%; padding: 8px; background: rgba(124, 58, 237, 0.1); 
                                                 border: 1px solid rgba(124, 58, 237, 0.3); color: #C084FC; 
                                                 border-radius: 6px; cursor: pointer; font-size: 13px;">
                                      <i class="fas fa-eye"></i> Ver ${productCount} produto(s)
                                  </button>
                              </div>
                          ` : ''}
                          <div class="category-footer">
                              <span class="category-status ${statusClass}">
                                  <i class="${statusIcon}"></i> ${statusText}
                              </span>
                              <span class="category-slug">${category.slug}</span>
                          </div>
                      </div>
                  </div>
              `;
      }

      window.viewCategoryProducts = async function (categoryId, event = null) {
        if (event) event.stopPropagation();

        const category = allCategories.find(c => c.id == categoryId);
        if (!category) {
          showNotification('Categoria n√£o encontrada', 'error');
          return;
        }

        showNotification(`Carregando produtos de ${category.name}...`, 'info');

        try {
          const response = await ProductAPI.getProductsByCategory(categoryId);

          if (response.products && response.products.length > 0) {
            showCategoryProductsModal(category, response.products);
          } else {
            showNotification(`Nenhum produto encontrado na categoria "${category.name}"`, 'warning');
          }
        } catch (error) {
          console.error('‚ùå Erro ao carregar produtos:', error);
          showNotification('Erro ao carregar produtos', 'error');
        }
      };

      function showCategoryProductsModal(category, products) {
        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.innerHTML = `
                  <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
                      <button class="modal-close" onclick="this.parentElement.parentElement.remove()">
                          <i class="fas fa-times"></i>
                      </button>
                      <h2 class="modal-title">
                          <i class="fas fa-tags" style="color: ${category.color || '#7C3AED'}"></i>
                          Produtos: ${category.name}
                      </h2>
                      <p style="color: #aaa; margin-bottom: 20px;">
                          ${category.description || ''}<br>
                          <small>Total: ${products.length} produto(s)</small>
                      </p>
                      <div style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                          <table style="width: 100%; border-collapse: collapse;">
                              <thead>
                                  <tr style="background: rgba(124, 58, 237, 0.1);">
                                      <th style="padding: 10px; text-align: left;">Produto</th>
                                      <th style="padding: 10px; text-align: left;">Pre√ßo</th>
                                      <th style="padding: 10px; text-align: left;">Estoque</th>
                                      <th style="padding: 10px; text-align: left;">Status</th>
                                      <th style="padding: 10px; text-align: left;">A√ß√µes</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  ${products.map(product => {
          const imageUrl = product.image_url || '';
          return `
                                          <tr>
                                              <td style="padding: 10px; border-bottom: 1px solid rgba(124, 58, 237, 0.1);">
                                                  <div style="display: flex; align-items: center; gap: 10px;">
                                                      ${imageUrl ?
              `<img src="${imageUrl.startsWith('http') ? imageUrl : `https://upuniversestorege.onrender.com${imageUrl}`}" 
                                                                alt="${product.name}" style="width: 40px; height: 40px; border-radius: 5px; object-fit: cover;">` :
              `<div style="width: 40px; height: 40px; background: rgba(124, 58, 237, 0.2); border-radius: 5px; display: flex; align-items: center; justify-content: center;">
                                                              <i class="fas fa-cube"></i>
                                                           </div>`
            }
                                                      <div>
                                                          <strong>${product.name}</strong><br>
                                                          <small style="color: #aaa;">${product.sku || `ID: ${product.id}`}</small>
                                                      </div>
                                                  </div>
                                              </td>
                                              <td style="padding: 10px;">R$ ${parseFloat(product.price).toFixed(2)}</td>
                                              <td style="padding: 10px;">${product.stock} un.</td>
                                              <td style="padding: 10px;">
                                                  <span style="padding: 3px 8px; border-radius: 4px; font-size: 12px; 
                                                             background: ${product.status === 'active' ? 'rgba(76, 175, 80, 0.2)' : 'rgba(244, 67, 54, 0.2)'}; 
                                                             color: ${product.status === 'active' ? '#4CAF50' : '#f44336'}">
                                                      ${product.status === 'active' ? 'Ativo' : 'Inativo'}
                                                  </span>
                                              </td>
                                              <td style="padding: 10px;">
                                                  <button onclick="window.location.href='product-form.html?edit=${product.id}'" 
                                                          style="padding: 5px 10px; background: rgba(124, 58, 237, 0.1); 
                                                                 border: 1px solid rgba(124, 58, 237, 0.3); color: #C084FC; 
                                                                 border-radius: 4px; cursor: pointer;">
                                                      <i class="fas fa-edit"></i>
                                                  </button>
                                              </td>
                                          </tr>
                                      `;
        }).join('')}
                              </tbody>
                          </table>
                      </div>
                      <div class="modal-actions">
                          <button class="btn-modal cancel" onclick="this.parentElement.parentElement.remove()">Fechar</button>
                          <button class="btn-modal" style="background: linear-gradient(135deg, #DF38FF, #7C3AED);" 
                                  onclick="window.location.href='products.html?category=${encodeURIComponent(category.name)}'">
                              <i class="fas fa-external-link-alt"></i> Ver todos
                          </button>
                      </div>
                  </div>
              `;
        document.body.appendChild(modal);
      }

      function getCategoryColor(category) {
        if (category.color) return category.color;
        const colors = ['#C084FC', '#DF38FF', '#7C3AED', '#4CAF50', '#2196F3', '#FFC107', '#F44336', '#9C27B0'];
        return colors[category.id % colors.length];
      }

      // === FORMUL√ÅRIO DE CATEGORIA ===
      window.showCategoryForm = function () {
        if (elements.categoryForm) {
          elements.categoryForm.classList.add('show');
          if (elements.newCategoryBtn) elements.newCategoryBtn.style.display = 'none';
          isEditing = false;
          elements.formTitle.textContent = 'Nova Categoria';
          elements.submitBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Categoria';
        }
      };

      window.hideCategoryForm = function () {
        if (elements.categoryForm) {
          elements.categoryForm.classList.remove('show');
          if (elements.newCategoryBtn) elements.newCategoryBtn.style.display = 'flex';
          elements.categoryFormData.reset();
          elements.categoryId.value = '';
          if (elements.iconPreview) {
            elements.iconPreview.innerHTML = 'üè∫';
            elements.iconPreview.style.color = '#C084FC';
          }
          if (elements.iconInput) elements.iconInput.value = '';
          if (elements.selectedColor) elements.selectedColor.value = '#C084FC';
          if (elements.parentCategorySelect) elements.parentCategorySelect.value = '';
          isEditing = false;
        }
      };

      window.editCategory = async function (id) {
        try {
          const category = await ProductAPI.getCategoryById(id);
          if (!category) {
            showNotification('Categoria n√£o encontrada', 'error');
            return;
          }

          elements.categoryId.value = category.id;
          elements.categoryName.value = category.name;
          elements.categorySlug.value = category.slug;
          elements.categoryDescription.value = category.description || '';
          elements.parentCategorySelect.value = category.parent_id || '';
          document.getElementById('categoryImage').value = category.image_url || '';
          document.getElementById('displayOrder').value = category.display_order || 1;
          document.getElementById('isActive').checked = category.status !== 'inactive';

          if (category.icon) {
            elements.iconInput.value = category.icon;
            elements.iconPreview.innerHTML = category.icon.includes('fa-')
              ? `<i class="${category.icon}"></i>`
              : category.icon;
          }

          if (category.color) {
            elements.iconPreview.style.color = category.color;
            elements.selectedColor.value = category.color;

            document.querySelectorAll('.color-option').forEach(opt => {
              opt.classList.remove('selected');
              if (opt.getAttribute('data-color') === category.color) {
                opt.classList.add('selected');
              }
            });
          }

          elements.categoryForm.classList.add('show');
          if (elements.newCategoryBtn) elements.newCategoryBtn.style.display = 'none';
          isEditing = true;
          elements.formTitle.textContent = 'Editar Categoria';
          elements.submitBtn.innerHTML = '<i class="fas fa-save"></i> Atualizar Categoria';

          showNotification(`Editando categoria: ${category.name}`, 'info');
        } catch (error) {
          console.error('‚ùå Erro ao editar categoria:', error);
          showNotification('Erro ao carregar categoria', 'error');
        }
      };

      // === EVENT LISTENERS DO FORMUL√ÅRIO ===
      if (elements.categoryName) {
        elements.categoryName.addEventListener('input', function () {
          if (!isEditing && elements.categorySlug && !elements.categorySlug.value) {
            elements.categorySlug.value = this.value
              .toLowerCase()
              .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
              .replace(/[^\w\s-]/g, '')
              .replace(/\s+/g, '-')
              .replace(/-+/g, '-')
              .trim();
          }
        });
      }

      if (elements.iconInput) {
        elements.iconInput.addEventListener('input', function () {
          const value = this.value.trim();
          if (elements.iconPreview) {
            if (value.includes('fa-')) {
              elements.iconPreview.innerHTML = `<i class="${value}"></i>`;
            } else if (value) {
              elements.iconPreview.innerHTML = value;
            }
          }
        });
      }

      // === SELE√á√ÉO DE COR ===
      document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function () {
          document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
          this.classList.add('selected');
          const color = this.getAttribute('data-color');
          if (elements.selectedColor) elements.selectedColor.value = color;
          if (elements.iconPreview) elements.iconPreview.style.color = color;
        });
      });

      // === SUBMISS√ÉO DO FORMUL√ÅRIO ===
      if (elements.categoryFormData) {
        elements.categoryFormData.addEventListener('submit', async function (e) {
          e.preventDefault();

          if (!elements.categoryName.value.trim()) {
            showNotification('Nome da categoria √© obrigat√≥rio', 'error');
            return;
          }

          if (!elements.categorySlug.value.trim()) {
            showNotification('Slug da categoria √© obrigat√≥rio', 'error');
            return;
          }

          const categoryData = {
            name: elements.categoryName.value.trim(),
            slug: elements.categorySlug.value.trim(),
            description: elements.categoryDescription?.value.trim() || '',
            parent_id: elements.parentCategorySelect?.value || null,
            image_url: document.getElementById('categoryImage')?.value.trim() || null,
            icon: elements.iconInput?.value.trim() || 'üè∫',
            color: elements.selectedColor?.value || '#C084FC',
            status: document.getElementById('isActive')?.checked ? 'active' : 'inactive',
            display_order: parseInt(document.getElementById('displayOrder')?.value) || 1
          };

          const originalHTML = elements.submitBtn.innerHTML;
          elements.submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
          elements.submitBtn.disabled = true;

          try {
            const result = isEditing
              ? await ProductAPI.updateCategory(elements.categoryId.value, categoryData)
              : await ProductAPI.createCategory(categoryData);

            if (result.success) {
              showNotification(`Categoria ${isEditing ? 'atualizada' : 'criada'} com sucesso!`, 'success');
              await loadCategories();
              window.hideCategoryForm();
            } else {
              showNotification(`Erro: ${result.error}`, 'error');
              elements.submitBtn.innerHTML = originalHTML;
              elements.submitBtn.disabled = false;
            }
          } catch (error) {
            console.error('‚ùå Erro no envio:', error);
            showNotification(`Erro: ${error.message}`, 'error');
            elements.submitBtn.innerHTML = originalHTML;
            elements.submitBtn.disabled = false;
          }
        });
      }

      // === MODAL DE EXCLUS√ÉO ===
      window.showDeleteModal = function (id, name) {
        categoryToDelete = id;
        const modal = document.getElementById('deleteModal');
        if (modal) {
          modal.classList.add('show');
          const deleteModalText = document.getElementById('deleteModalText');
          if (deleteModalText) {
            deleteModalText.textContent = `Tem certeza que deseja excluir a categoria "${name}"? Esta a√ß√£o n√£o pode ser desfeita.`;
          }
        }
      };

      window.closeDeleteModal = function () {
        const modal = document.getElementById('deleteModal');
        if (modal) {
          modal.classList.remove('show');
          categoryToDelete = null;
        }
      };

      window.confirmDelete = async function () {
        if (!categoryToDelete) return;

        try {
          const result = await ProductAPI.deleteCategory(categoryToDelete);

          if (result.success) {
            showNotification('Categoria exclu√≠da com sucesso!', 'success');
            await loadCategories();
          } else {
            showNotification(`Erro: ${result.error}`, 'error');
          }
        } catch (error) {
          console.error('‚ùå Erro ao excluir categoria:', error);
          showNotification('Erro ao excluir categoria', 'error');
        }

        closeDeleteModal();
      };

      // === EVENT LISTENERS PRINCIPAIS ===
      if (elements.newCategoryBtn) {
        elements.newCategoryBtn.addEventListener('click', window.showCategoryForm);
      }

      if (elements.refreshBtn) {
        elements.refreshBtn.addEventListener('click', () => {
          loadCategories();
          showNotification('Categorias atualizadas!', 'info');
        });
      }

      // === CONFIGURA√á√ÉO DO SELETOR DE √çCONES ===
      const searchInput = document.getElementById('iconSearch');
      if (searchInput) {
        searchInput.addEventListener('input', function () {
          const searchTerm = this.value.toLowerCase();
          document.querySelectorAll('.icon-item').forEach(item => {
            const iconName = item.getAttribute('data-value')?.toLowerCase() || '';
            const iconType = item.querySelector('.icon-name')?.textContent.toLowerCase() || '';
            item.style.display = (iconName.includes(searchTerm) || iconType.includes(searchTerm)) ? 'flex' : 'none';
          });
        });
      }

      const categoryBtns = document.querySelectorAll('.category-btn');
      categoryBtns.forEach(btn => {
        btn.addEventListener('click', function () {
          categoryBtns.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          loadIcons(this.getAttribute('data-category'));
        });
      });

      if (elements.iconPreview && elements.iconInput) {
        elements.iconPreview.style.cursor = 'pointer';
        elements.iconPreview.addEventListener('click', window.openIconPicker);
        elements.iconInput.readOnly = true;
        elements.iconInput.style.cursor = 'pointer';
        elements.iconInput.addEventListener('click', window.openIconPicker);
      }

      // === LOGOUT ===
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function () {
          if (confirm('Tem certeza que deseja sair?')) {
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('adminEmail');
            window.location.href = 'login.html';
          }
        });
      }

      // === ATUALIZAR INFORMA√á√ïES DO ADMIN ===
      const adminEmail = localStorage.getItem('adminEmail');
      const profileName = document.querySelector('.profile-info h4');
      if (adminEmail && profileName) {
        profileName.textContent = adminEmail.split('@')[0];
      }

      const profileAvatar = document.querySelector('.profile-avatar');
      if (adminEmail && profileAvatar) {
        profileAvatar.textContent = adminEmail.split('@')[0].charAt(0).toUpperCase();
      }

      // === INICIAR CARREGAMENTO ===
      await loadCategories();
    });

    // === ANIMA√á√ïES CSS ===
    const style = document.createElement('style');
    style.textContent = `
          @keyframes slideIn {
              from { transform: translateX(100%); opacity: 0; }
              to { transform: translateX(0); opacity: 1; }
          }
          @keyframes fadeOut {
              from { opacity: 1; transform: translateX(0); }
              to { opacity: 0; transform: translateX(100%); }
          }
          .label-required::after {
              content: " *";
              color: #f44336;
          }
      `;
    document.head.appendChild(style);
  </script>
</body>

</html>