<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Universo Paralelo Store | Cat√°logo 3D</title>
  <link rel="stylesheet" href="./catalago.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="/public/js/config.js"></script>
  <script src="/public/js/cart.js"></script>
</head>

<body>

  <!-- HEADER -->
  <header class="main-header">
    <nav class="container nav-container">
      <a href="/home.html" class="logo" aria-label="Home Universo Paralelo">UNIVERSO PARALELO</a>

      <ul class="nav-menu">
        <li><a href="/home.html">In√≠cio</a></li>
        <li><a href="/catalogo.html" class="active">Cat√°logo 3D</a></li>
        <li><a href="/servicos.html">Servi√ßos</a></li>
        <li><a href="#footer">Contato</a></li>
      </ul>

      <div class="header-actions">
        <a href="carrinho.html" class="cart-icon">
          <i class="fas fa-shopping-cart"></i>
          <span class="cart-count">0</span>
        </a>
      </div>
    </nav>
  </header>

  <!-- MAIN -->
  <main class="container">

    <!-- BREADCRUMB -->
    <nav class="breadcrumb reveal">
      <a href="home.html">In√≠cio</a>
      <i class="fas fa-chevron-right"></i>
      <span>Cat√°logo de Produtos</span>
    </nav>

    <!-- INTRO -->
    <header class="catalog-intro reveal">
      <h1>CAT√ÅLOGO DE PRODUTOS 3D</h1>
      <p class="catalog-subtitle">Explore nossa cole√ß√£o de produtos impressos em 3D com qualidade premium e designs
        exclusivos</p>

      <!-- TOOLBAR AVAN√áADA -->
      <section class="toolbar-advanced">
        <div class="toolbar-left">
          <div class="filter-section">
            <button class="filter-toggle" id="filterToggle">
              <i class="fas fa-filter"></i> Filtros Avan√ßados
              <span class="filter-count" id="filterCount">0</span>
            </button>
          </div>

          <div class="view-controls">
            <button class="view-btn active" data-view="grid">
              <i class="fas fa-th-large"></i>
            </button>
            <button class="view-btn" data-view="list">
              <i class="fas fa-list"></i>
            </button>
          </div>
        </div>

        <div class="toolbar-right">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="search" placeholder="Buscar produtos..." class="search-input" id="searchInput">
            <button class="search-clear" id="searchClear" style="display: none;">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <div class="results-info">
            <span class="product-count" id="productCount">Carregando produtos...</span>
          </div>
        </div>
      </section>
    </header>

    <!-- GRID DE PRODUTOS COM PAGINA√á√ÉO -->
    <section class="catalog-content">
      <!-- FILTROS R√ÅPIDOS -->
      <div class="quick-filters reveal" id="quickFilters">
        <button class="quick-filter active" data-category="all">Todos</button>
        <!-- Filtros r√°pidos ser√£o carregados dinamicamente aqui -->
      </div>

      <!-- PRODUTOS -->
      <div class="products-grid catalog-grid" id="productsGrid">
        <div class="loading-products">
          <i class="fas fa-spinner fa-spin fa-2x"></i>
          <p>Conectando ao cat√°logo...</p>
        </div>
      </div>

      <!-- PAGINA√á√ÉO -->
      <div class="pagination reveal" id="pagination" style="display: none;">
        <button class="page-btn prev-btn" id="prevBtn">
          <i class="fas fa-chevron-left"></i> Anterior
        </button>
        <div class="page-numbers" id="pageNumbers">
          <button class="page-number active">1</button>
        </div>
        <button class="page-btn next-btn" id="nextBtn">
          Pr√≥xima <i class="fas fa-chevron-right"></i>
        </button>
        <div class="page-info">
          <span>P√°gina <span id="currentPage">1</span> de <span id="totalPages">1</span></span>
        </div>
      </div>
    </section>

    <!-- CATEGORIAS DESTAQUE -->
    <section class="catalog-categories reveal" id="featuredCategories" style="display: none;">
      <h2 class="section-title">NAVEGUE POR CATEGORIAS</h2>
      <p class="section-subtitle">Encontre exatamente o que voc√™ precisa</p>
      <div class="categories-grid" id="categoriesGrid">
        <!-- Categorias ser√£o carregadas dinamicamente aqui -->
      </div>
    </section>

    <!-- CTA CAT√ÅLOGO -->
    <section class="catalog-cta reveal">
      <div class="cta-content">
        <i class="fas fa-lightbulb cta-icon"></i>
        <h2>N√ÉO ENCONTROU O QUE PROCURAVA?</h2>
        <p>Temos um servi√ßo de cria√ß√£o personalizada! Envie sua ideia e n√≥s a transformaremos em realidade.</p>
        <a href="servicos.html" class="btn-hero">Solicitar Or√ßamento Personalizado</a>
      </div>
    </section>

  </main>

  <!-- FOOTER -->
  <footer class="main-footer" id="footer">
    <div class="container footer-grid">
      <section class="footer-brand">
        <span class="logo">UNIVERSO PARALELO</span>
        <p>Transformando ideias em objetos atrav√©s da impress√£o 3D com qualidade e criatividade.</p>
        <div class="social-links">
          <a href="#"><i class="fab fa-instagram"></i></a>
          <a href="#"><i class="fab fa-facebook"></i></a>
          <a href="#"><i class="fab fa-whatsapp"></i></a>
          <a href="#"><i class="fab fa-tiktok"></i></a>
        </div>
      </section>
      <section>
        <h4>LINKS R√ÅPIDOS</h4>
        <ul class="footer-links">
          <li><a href="home.html">In√≠cio</a></li>
          <li><a href="catalogo.html">Cat√°logo 3D</a></li>
          <li><a href="servicos.html">Servi√ßos</a></li>
          <li><a href="sobre.html">Sobre N√≥s</a></li>
        </ul>
      </section>
      <section>
        <h4>CONTATO</h4>
        <p><i class="fas fa-phone"></i> +55 21 99999-9999</p>
        <p><i class="fas fa-envelope"></i> universoparalelostore@gmail.com</p>
        <p><i class="fas fa-map-marker-alt"></i> Rio de Janeiro, Brasil</p>
      </section>
      <section>
        <h4>NEWSLETTER</h4>
        <p>Inscreva-se para receber novidades e promo√ß√µes</p>
        <form class="newsletter-form">
          <input type="email" placeholder="Seu e-mail" required>
          <button type="submit"><i class="fas fa-paper-plane"></i></button>
        </form>
      </section>
    </div>
    <div class="footer-bottom">
      <p>Universo Paralelo Store ¬© 2023 - Todos os direitos reservados</p>
    </div>
  </footer>

  <!-- MODAL DE FILTROS -->
  <div class="filters-modal" id="filtersModal">
    <div class="filters-modal-content">
      <div class="filters-modal-header">
        <h3><i class="fas fa-sliders-h"></i> Filtros Avan√ßados</h3>
        <button class="filters-close" id="filtersClose"><i class="fas fa-times"></i></button>
      </div>
      <div class="filters-modal-body">
        <!-- Conte√∫do do modal permanece igual -->
      </div>
      <div class="filters-modal-footer">
        <button class="btn-clear-filters" id="clearAllFilters"><i class="fas fa-broom"></i> Limpar Todos</button>
        <div class="filters-actions">
          <button class="btn-cancel-filters" id="cancelFilters">Cancelar</button>
          <button class="btn-apply-filters" id="applyAllFilters"><i class="fas fa-check"></i> Aplicar Filtros</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== CONFIGURA√á√ÉO ==========
    // Usar a configura√ß√£o do config.js que j√° detecta ambiente automaticamente
    const API_BASE_URL = API_CONFIG.BASE_URL;
    const PRODUCTS_PER_PAGE = 9;

    console.log('üéØ Cat√°logo iniciado com API:', API_BASE_URL);
    console.log('üåê Ambiente:', window.location.hostname);

    // ========== VARI√ÅVEIS GLOBAIS ==========
    let allProducts = [];
    let allCategories = [];
    let filteredProducts = [];
    let currentPage = 1;
    let currentFilters = {
      categories: [],
      minPrice: 0,
      maxPrice: 1000,
      sortBy: 'newest',
      searchTerm: '',
      status: ['in_stock']
    };

    // ========== FUN√á√ïES DE API ==========
    async function fetchProducts() {
      try {
        console.log("üì• Buscando produtos da API...");

        const url = getApiUrl('/products');
        console.log("üåê URL:", url);

        const response = await fetch(url, {
          signal: AbortSignal.timeout(15000),
          headers: {
            'Accept': 'application/json',
            'Cache-Control': 'no-cache'
          }
        });

        console.log("üìä Status da API:", response.status, response.statusText);

        if (!response.ok) {
          if (response.status === 404) {
            throw new Error('API n√£o encontrada. Verifique se o backend est√° rodando.');
          }
          throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log("üì¶ Dados recebidos da API:", data);

        // IMPORTANTE: Verificar diferentes formatos de resposta
        if (data && Array.isArray(data.products)) {
          // Formato: { products: [...] }
          console.log(`‚úÖ ${data.products.length} produtos carregados (formato com products)`);
          return data.products;
        } else if (Array.isArray(data)) {
          // Formato: [...]
          console.log(`‚úÖ ${data.length} produtos carregados (formato direto)`);
          return data;
        } else if (data && data.success && Array.isArray(data.products)) {
          // Formato: { success: true, products: [...] }
          console.log(`‚úÖ ${data.products.length} produtos carregados (formato success)`);
          return data.products;
        } else {
          console.warn("‚ö†Ô∏è Formato de resposta inesperado:", data);
          return [];
        }

      } catch (error) {
        console.error("‚ùå Erro ao buscar produtos:", error);

        // Mostrar mensagem amig√°vel de erro
        showErrorUI(`N√£o foi poss√≠vel carregar os produtos: ${error.message}`);

        // Retornar array vazio para n√£o quebrar o c√≥digo
        return [];
      }
    }

    async function fetchCategories() {
      try {
        console.log("üè∑Ô∏è Buscando categorias da API...");

        const url = getApiUrl('/categories');
        console.log("üåê URL:", url);

        const response = await fetch(url, {
          signal: AbortSignal.timeout(10000)
        });

        console.log("üìä Status categorias:", response.status);

        if (!response.ok) {
          throw new Error(`Erro ${response.status}`);
        }

        const data = await response.json();
        console.log("üìä Dados categorias:", data);

        // Verificar diferentes formatos
        if (data && Array.isArray(data.categories)) {
          console.log(`‚úÖ ${data.categories.length} categorias carregadas (formato com categories)`);
          return data.categories;
        } else if (Array.isArray(data)) {
          console.log(`‚úÖ ${data.length} categorias carregadas (formato direto)`);
          return data;
        } else {
          console.warn("‚ö†Ô∏è Formato inesperado de categorias:", data);
          return [];
        }

      } catch (error) {
        console.error("‚ùå Erro ao buscar categorias:", error);
        return [];
      }
    }

    // ========== FUN√á√ïES DE INICIALIZA√á√ÉO ==========
    async function initializeCatalog() {
      console.log("üöÄ Inicializando cat√°logo...");

      try {
        // Mostrar estado de loading melhorado
        document.getElementById('productsGrid').innerHTML = `
          <div class="loading-products" style="grid-column: 1 / -1; text-align: center; padding: 60px;">
            <i class="fas fa-spinner fa-spin fa-3x" style="color: #7C3AED; margin-bottom: 20px;"></i>
            <p style="color: #666; font-size: 16px; margin-bottom: 10px;">Conectando ao cat√°logo...</p>
            <p style="color: #888; font-size: 14px;">API: ${API_BASE_URL}</p>
          </div>
        `;

        // Testar conex√£o primeiro
        console.log("üîó Testando conex√£o com a API...");
        const isConnected = await testApiConnection();

        if (!isConnected) {
          showErrorUI("N√£o foi poss√≠vel conectar √† API. Verifique se o servidor est√° online.");
          return;
        }

        console.log("‚úÖ Conex√£o estabelecida. Carregando dados...");

        // Carregar produtos e categorias em paralelo
        const [products, categories] = await Promise.all([
          fetchProducts(),
          fetchCategories()
        ]);

        console.log("üìä Dados carregados:", {
          produtos: products.length,
          categorias: categories.length
        });

        // Atribuir √†s vari√°veis globais
        allProducts = products || [];
        allCategories = categories || [];

        // Verificar se temos produtos
        if (allProducts.length === 0) {
          showNoProductsMessage();
          console.warn("‚ö†Ô∏è Nenhum produto encontrado");
          return;
        }

        console.log("‚úÖ Dados carregados com sucesso!");

        // Configurar interface
        setupQuickFilters();
        renderFeaturedCategories();
        setupEventListeners();
        setupFiltersModal();

        // Carregar todos os produtos inicialmente
        filteredProducts = [...allProducts];
        renderProducts();

        console.log(`üéâ Cat√°logo inicializado com ${allProducts.length} produtos`);

      } catch (error) {
        console.error("‚ùå Erro fatal na inicializa√ß√£o:", error);
        showErrorUI(`Erro cr√≠tico: ${error.message}`);
      }
    }

    function loadAllProducts() {
      console.log("üéØ Carregando todos os produtos");

      // Resetar filtros
      currentFilters = {
        categories: [],
        minPrice: 0,
        maxPrice: 1000,
        sortBy: 'newest',
        searchTerm: '',
        status: ['in_stock']
      };

      filteredProducts = [...allProducts];
      currentPage = 1;

      // Ativar visualmente o bot√£o "Todos"
      const allButton = document.querySelector('.quick-filter[data-category="all"]');
      if (allButton) {
        document.querySelectorAll('.quick-filter').forEach(btn => btn.classList.remove('active'));
        allButton.classList.add('active');
      }

      // Atualizar UI
      updateFiltersCount();
      renderProducts();

      console.log(`‚úÖ ${filteredProducts.length} produtos carregados`);
    }

    // ========== FUN√á√ïES DE IMAGENS ==========
    function buildImageUrl(imagePath) {
      if (!imagePath) {
        return 'https://via.placeholder.com/400x400/7C3AED/FFFFFF?text=Sem+Imagem';
      }

      console.log("üñºÔ∏è Processando imagem:", imagePath);

      // Usar a fun√ß√£o do config.js
      return getImageUrl(imagePath);
    }

    // ========== FUN√á√ïES DE RENDERIZA√á√ÉO ==========
    function setupQuickFilters() {
      const quickFilters = document.getElementById('quickFilters');

      if (!allCategories || allCategories.length === 0) {
        return;
      }

      // Configurar bot√£o "Todos"
      const allButton = document.querySelector('.quick-filter[data-category="all"]');
      if (allButton) {
        allButton.addEventListener('click', loadAllProducts);
        allButton.classList.add('active');
      }

      // Limpar bot√µes existentes (exceto "Todos")
      const existingButtons = quickFilters.querySelectorAll('.quick-filter:not([data-category="all"])');
      existingButtons.forEach(btn => btn.remove());

      // Pegar at√© 6 categorias para filtros r√°pidos
      const quickCategories = allCategories.slice(0, 6);

      // Adicionar bot√µes de filtro r√°pido
      quickCategories.forEach(category => {
        const button = document.createElement('button');
        button.className = 'quick-filter';
        button.dataset.categoryId = category.id;
        button.dataset.categoryName = category.name;
        button.innerHTML = `<i class="fas fa-tag"></i> ${category.name}`;

        button.addEventListener('click', () => {
          document.querySelectorAll('.quick-filter').forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          currentFilters.categories = [category.id.toString()];
          applyFilters();
        });

        quickFilters.appendChild(button);
      });
    }

    function renderFeaturedCategories() {
      const featuredCategories = document.getElementById('featuredCategories');
      const categoriesGrid = document.getElementById('categoriesGrid');

      if (!allCategories || allCategories.length === 0) {
        return;
      }

      // Pegar at√© 4 categorias para destaque
      const featured = allCategories.slice(0, 4);

      categoriesGrid.innerHTML = featured.map(category => {
        // Encontrar produtos desta categoria
        const productsInCategory = allProducts.filter(product =>
          (product.category_id && product.category_id.toString() === category.id.toString()) ||
          (product.category && product.category.toLowerCase() === category.name.toLowerCase())
        ).length;

        // Imagem da categoria
        let categoryImage = 'https://images.unsplash.com/photo-1571330735066-03aaa9429d89?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80';

        // Tentar pegar imagem do primeiro produto da categoria
        const firstProduct = allProducts.find(product =>
          (product.category_id && product.category_id.toString() === category.id.toString()) ||
          (product.category && product.category.toLowerCase() === category.name.toLowerCase())
        );

        if (firstProduct && firstProduct.image_url) {
          categoryImage = buildImageUrl(firstProduct.image_url);
        }

        return `
          <a href="#" class="category-card" data-category-id="${category.id}">
            <div class="category-image">
              <img src="${categoryImage}" alt="${category.name}" 
                   onerror="this.src='https://images.unsplash.com/photo-1571330735066-03aaa9429d89?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80'">
            </div>
            <div class="category-content">
              <h3>${category.name}</h3>
              <p>${productsInCategory} produto(s)</p>
            </div>
          </a>
        `;
      }).join('');

      // Mostrar se√ß√£o
      featuredCategories.style.display = 'block';

      // Adicionar event listeners
      document.querySelectorAll('.category-card').forEach(card => {
        card.addEventListener('click', (e) => {
          e.preventDefault();
          const categoryId = card.dataset.categoryId;

          // Ativar filtro r√°pido correspondente
          document.querySelectorAll('.quick-filter').forEach(btn => {
            if (btn.dataset.categoryId === categoryId) {
              btn.click();
            }
          });

          // Rolar para os produtos
          document.querySelector('.catalog-content').scrollIntoView({ behavior: 'smooth' });
        });
      });
    }

    function renderProducts() {
      const productsGrid = document.getElementById('productsGrid');
      console.log("üîÑ Renderizando produtos...");

      if (filteredProducts.length === 0) {
        productsGrid.innerHTML = `
          <div class="no-products">
            <i class="fas fa-search fa-3x"></i>
            <h3>Nenhum produto encontrado</h3>
            <p>Tente ajustar os filtros ou buscar por outro termo</p>
          </div>
        `;
        document.getElementById('pagination').style.display = 'none';
        document.getElementById('productCount').textContent = 'Nenhum produto encontrado';
        return;
      }

      // Calcular produtos para a p√°gina atual
      const startIndex = (currentPage - 1) * PRODUCTS_PER_PAGE;
      const endIndex = startIndex + PRODUCTS_PER_PAGE;
      const pageProducts = filteredProducts.slice(startIndex, endIndex);

      console.log(`üìÑ Renderizando ${pageProducts.length} produtos (p√°gina ${currentPage})`);

      // Limpar grid
      productsGrid.innerHTML = '';

      // Adicionar produtos
      pageProducts.forEach(product => {
        const card = createProductCard(product);
        if (card) {
          productsGrid.appendChild(card);
        }
      });

      // Atualizar contador e pagina√ß√£o
      updateProductCount();
      updatePagination();

      console.log("‚úÖ Renderiza√ß√£o conclu√≠da");
    }

    function createProductCard(product) {
      console.log(`üé® Criando card para: ${product.name}`);

      try {
        const article = document.createElement('article');
        article.className = 'product-card';

        // Badge
        if (product.featured) {
          const badge = document.createElement('span');
          badge.className = 'badge featured';
          badge.textContent = 'Destaque';
          article.appendChild(badge);
        }

        // Imagem
        const figure = document.createElement('figure');
        figure.className = 'product-image';

        const img = document.createElement('img');
        img.src = buildImageUrl(product.image_url);
        img.alt = product.name;
        img.onerror = function () {
          console.warn(`‚ö†Ô∏è Erro ao carregar imagem do produto ${product.id}`);
          this.src = 'https://via.placeholder.com/400x400/7C3AED/FFFFFF?text=Imagem+Indispon√≠vel';
        };

        figure.appendChild(img);
        article.appendChild(figure);

        // Detalhes
        const section = document.createElement('section');
        section.className = 'product-details';

        // Cabe√ßalho
        const headerDiv = document.createElement('div');
        headerDiv.className = 'product-header';

        const title = document.createElement('h3');
        title.className = 'product-title';
        title.textContent = product.name;

        const categoryName = getCategoryName(product);
        const categoryBadge = document.createElement('span');
        categoryBadge.className = 'product-category-badge';
        categoryBadge.textContent = categoryName;

        headerDiv.appendChild(title);
        headerDiv.appendChild(categoryBadge);
        section.appendChild(headerDiv);

        // Descri√ß√£o
        const description = document.createElement('p');
        description.className = 'product-description';
        const descText = product.description || 'Produto impresso em 3D com qualidade premium.';
        description.textContent = descText.length > 80 ? descText.substring(0, 80) + '...' : descText;
        section.appendChild(description);

        // Pre√ßo
        const priceContainer = document.createElement('div');
        priceContainer.className = 'product-price-container';

        const price = document.createElement('div');
        price.className = 'product-price';
        price.textContent = new Intl.NumberFormat('pt-BR', {
          style: 'currency',
          currency: 'BRL'
        }).format(product.price || 0);

        priceContainer.appendChild(price);
        section.appendChild(priceContainer);

        // A√ß√µes
        const footer = document.createElement('footer');
        footer.className = 'card-actions';

        const inStock = product.stock > 0 && product.status !== 'inactive';

        const buyBtn = document.createElement('button');
        buyBtn.className = inStock ? 'btn-primary' : 'btn-primary disabled';
        buyBtn.disabled = !inStock;

        const cartIcon = document.createElement('i');
        cartIcon.className = 'fas fa-shopping-cart';

        buyBtn.appendChild(cartIcon);
        buyBtn.appendChild(document.createTextNode(inStock ? ' Comprar' : ' Esgotado'));
        buyBtn.onclick = () => addToCart(product.id);

        const detailsBtn = document.createElement('button');
        detailsBtn.className = 'btn-secondary';

        const eyeIcon = document.createElement('i');
        eyeIcon.className = 'fas fa-eye';

        detailsBtn.appendChild(eyeIcon);
        detailsBtn.appendChild(document.createTextNode(' Detalhes'));
        detailsBtn.onclick = () => viewProductDetails(product.id);

        footer.appendChild(buyBtn);
        footer.appendChild(detailsBtn);
        section.appendChild(footer);

        article.appendChild(section);
        return article;

      } catch (error) {
        console.error(`‚ùå Erro ao criar card:`, error);
        return null;
      }
    }

    function getCategoryName(product) {
      if (product.category) {
        return product.category;
      }

      if (product.category_id && allCategories && allCategories.length > 0) {
        const category = allCategories.find(cat => cat.id == product.category_id);
        if (category) {
          return category.name;
        }
      }

      return 'Sem categoria';
    }

    // ========== FUN√á√ïES DE FILTRAGEM ==========
    function applyFilters() {
      console.log("üîç Aplicando filtros:", currentFilters);

      // Come√ßar com todos os produtos
      filteredProducts = [...allProducts];

      // Filtro de busca
      if (currentFilters.searchTerm) {
        const searchTerm = currentFilters.searchTerm.toLowerCase();
        filteredProducts = filteredProducts.filter(product =>
          product.name.toLowerCase().includes(searchTerm) ||
          (product.description && product.description.toLowerCase().includes(searchTerm)) ||
          (product.category && product.category.toLowerCase().includes(searchTerm))
        );
      }

      // Filtro de categorias
      if (currentFilters.categories.length > 0) {
        filteredProducts = filteredProducts.filter(product => {
          if (product.category_id) {
            return currentFilters.categories.some(catId =>
              product.category_id.toString() === catId.toString()
            );
          }
          if (product.category && allCategories && allCategories.length > 0) {
            const selectedCategoryNames = currentFilters.categories.map(catId => {
              const category = allCategories.find(c => c.id.toString() === catId.toString());
              return category ? category.name.toLowerCase() : '';
            });
            return selectedCategoryNames.includes(product.category.toLowerCase());
          }
          return false;
        });
      }

      // Filtro de pre√ßo
      filteredProducts = filteredProducts.filter(product => {
        const price = product.price || 0;
        return price >= currentFilters.minPrice && price <= currentFilters.maxPrice;
      });

      // Filtro de status
      if (currentFilters.status && currentFilters.status.length > 0) {
        filteredProducts = filteredProducts.filter(product => {
          const inStock = product.stock > 0 && product.status !== 'inactive';

          if (currentFilters.status.includes('in_stock') && currentFilters.status.includes('out_of_stock')) {
            return true;
          } else if (currentFilters.status.includes('in_stock')) {
            return inStock;
          } else if (currentFilters.status.includes('out_of_stock')) {
            return !inStock;
          }

          if (currentFilters.status.includes('featured')) {
            return product.featured === true;
          }

          return true;
        });
      }

      // Ordena√ß√£o
      filteredProducts.sort((a, b) => {
        switch (currentFilters.sortBy) {
          case 'price_asc': return (a.price || 0) - (b.price || 0);
          case 'price_desc': return (b.price || 0) - (a.price || 0);
          case 'name_asc': return a.name.localeCompare(b.name);
          case 'name_desc': return b.name.localeCompare(a.name);
          case 'featured':
            if (a.featured && !b.featured) return -1;
            if (!a.featured && b.featured) return 1;
            return new Date(b.created_at || 0) - new Date(a.created_at || 0);
          case 'stock': return (b.stock || 0) - (a.stock || 0);
          case 'newest':
          default: return new Date(b.created_at || 0) - new Date(a.created_at || 0);
        }
      });

      // Resetar para primeira p√°gina
      currentPage = 1;

      // Renderizar produtos
      renderProducts();

      console.log(`üìä ${filteredProducts.length} produtos ap√≥s filtragem`);
    }

    // ========== PAGINA√á√ÉO ==========
    function updatePagination() {
      const totalPages = Math.ceil(filteredProducts.length / PRODUCTS_PER_PAGE);

      document.getElementById('totalPages').textContent = totalPages;
      document.getElementById('currentPage').textContent = currentPage;

      const pageNumbers = document.getElementById('pageNumbers');
      pageNumbers.innerHTML = '';

      if (totalPages <= 1) {
        document.getElementById('pagination').style.display = 'none';
        return;
      }

      document.getElementById('pagination').style.display = 'flex';

      const maxVisiblePages = 5;
      let startPage, endPage;

      if (totalPages <= maxVisiblePages) {
        startPage = 1;
        endPage = totalPages;
      } else {
        if (currentPage <= Math.ceil(maxVisiblePages / 2)) {
          startPage = 1;
          endPage = maxVisiblePages;
        } else if (currentPage + Math.floor(maxVisiblePages / 2) >= totalPages) {
          startPage = totalPages - maxVisiblePages + 1;
          endPage = totalPages;
        } else {
          startPage = currentPage - Math.floor(maxVisiblePages / 2);
          endPage = currentPage + Math.floor(maxVisiblePages / 2);
        }
      }

      // Bot√µes de p√°gina
      for (let i = startPage; i <= endPage; i++) {
        const button = document.createElement('button');
        button.className = `page-number ${i === currentPage ? 'active' : ''}`;
        button.textContent = i;
        button.addEventListener('click', () => goToPage(i));
        pageNumbers.appendChild(button);
      }

      // Bot√µes anterior/pr√≥ximo
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');

      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;
    }

    function goToPage(page) {
      if (page < 1 || page > Math.ceil(filteredProducts.length / PRODUCTS_PER_PAGE)) return;

      currentPage = page;
      renderProducts();

      // Rolar suavemente
      const catalogContent = document.querySelector('.catalog-content');
      if (catalogContent) {
        catalogContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    function updateProductCount() {
      const total = filteredProducts.length;
      const totalPages = Math.ceil(total / PRODUCTS_PER_PAGE);
      const showing = Math.min(PRODUCTS_PER_PAGE, total - (currentPage - 1) * PRODUCTS_PER_PAGE);
      const start = (currentPage - 1) * PRODUCTS_PER_PAGE + 1;
      const end = start + showing - 1;

      let text = '';

      if (total === 0) {
        text = 'Nenhum produto encontrado';
      } else if (totalPages > 1) {
        text = `${total} produto(s) - P√°gina ${currentPage} de ${totalPages}`;
      } else {
        text = `${total} produto(s) encontrado(s)`;
      }

      document.getElementById('productCount').textContent = text;
    }

    // ========== FUN√á√ïES AUXILIARES ==========
    function showErrorUI(message) {
      document.getElementById('productsGrid').innerHTML = `
        <div class="error-message" style="grid-column: 1/-1; text-align: center; padding: 40px;">
          <i class="fas fa-exclamation-triangle fa-3x" style="color: #f44336; margin-bottom: 20px;"></i>
          <h3 style="color: #666; margin-bottom: 10px;">Erro ao carregar cat√°logo</h3>
          <p style="color: #888; margin-bottom: 20px;">${message}</p>
          <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: left;">
            <p><strong>Informa√ß√µes para debug:</strong></p>
            <p><small>API URL: ${API_BASE_URL}</small></p>
            <p><small>Ambiente: ${window.location.hostname}</small></p>
          </div>
          <button onclick="initializeCatalog()" style="margin-top: 10px; padding: 10px 20px; background: #7C3AED; color: white; border: none; border-radius: 8px; cursor: pointer;">
            <i class="fas fa-sync-alt"></i> Tentar novamente
          </button>
          <button onclick="testApiConnection()" style="margin-top: 10px; margin-left: 10px; padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 8px; cursor: pointer;">
            <i class="fas fa-wifi"></i> Testar conex√£o
          </button>
        </div>
      `;
    }

    function showNoProductsMessage() {
      document.getElementById('productsGrid').innerHTML = `
        <div class="no-products" style="grid-column: 1/-1; text-align: center; padding: 60px;">
          <i class="fas fa-box-open fa-3x" style="color: #ddd; margin-bottom: 20px;"></i>
          <h3 style="color: #666; margin-bottom: 10px;">Nenhum produto dispon√≠vel</h3>
          <p style="color: #888;">O cat√°logo est√° vazio no momento.</p>
          <p style="color: #aaa; font-size: 14px; margin-top: 20px;">
            <i class="fas fa-info-circle"></i>
            Adicione produtos pelo painel administrativo.
          </p>
        </div>
      `;
      document.getElementById('productCount').textContent = '0 produtos encontrados';
      document.getElementById('featuredCategories').style.display = 'none';
    }

    function viewProductDetails(productId) {
      console.log("üëÅÔ∏è Visualizando detalhes do produto:", productId);
      window.location.href = `detalhes-produto.html?id=${productId}`;
    }

    // ========== FUN√á√ïES DO MODAL DE FILTROS ==========
      function setupFiltersModal() {
        const filterToggle = document.getElementById("filterToggle");
        const filtersModal = document.getElementById("filtersModal");
        const filtersClose = document.getElementById("filtersClose");
        const cancelFilters = document.getElementById("cancelFilters");
        const applyAllFilters = document.getElementById("applyAllFilters");
        const clearAllFilters = document.getElementById("clearAllFilters");
        const priceRangeSlider = document.getElementById("priceRangeSlider");
        const priceRangeValue = document.getElementById("priceRangeValue");
        const minPriceInput = document.getElementById("minPriceInput");
        const maxPriceInput = document.getElementById("maxPriceInput");
        const filterCategoriesGrid = document.getElementById("filterCategoriesGrid");
        const filterCount = document.getElementById("filterCount");
        const searchClear = document.getElementById("searchClear");
        const searchInput = document.getElementById("searchInput");

        // Fun√ß√µes para abrir e fechar modal
        function openModal() {
          filtersModal.classList.add("active");
          document.body.classList.add("modal-open"); // Previne scroll no body
          updateFiltersCount();
        }

        function closeModal() {
          filtersModal.classList.remove("active");
          document.body.classList.remove("modal-open"); // Restaura scroll
        }

        // Abrir modal
        filterToggle.addEventListener("click", openModal);

        // Fechar modal
        filtersClose.addEventListener("click", closeModal);
        cancelFilters.addEventListener("click", closeModal);

        // Fechar modal ao clicar fora do conte√∫do
        filtersModal.addEventListener("click", function (e) {
          if (e.target === this) {
            closeModal();
          }
        });

        // Fechar modal com ESC
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape" && filtersModal.classList.contains("active")) {
            closeModal();
          }
        });

        // Aplicar filtros
        applyAllFilters.addEventListener("click", () => {
          applyAllFiltersFromModal();
          closeModal();
        });

        // Limpar todos os filtros
        clearAllFilters.addEventListener("click", () => {
          clearAllFiltersHandler();
        });

        // Atualizar slider de pre√ßo
        if (priceRangeSlider) {
          priceRangeSlider.addEventListener("input", function () {
            const value = this.value;
            priceRangeValue.textContent = `R$ ${value}`;
            if (maxPriceInput) {
              maxPriceInput.value = value;
            }
          });

          priceRangeSlider.addEventListener("change", function () {
            currentFilters.maxPrice = parseInt(this.value);
          });
        }

        // Inputs de pre√ßo
        if (minPriceInput) {
          minPriceInput.addEventListener("change", function () {
            const value = parseInt(this.value) || 0;
            currentFilters.minPrice = value;
            if (priceRangeSlider && value > parseInt(priceRangeSlider.value)) {
              priceRangeSlider.value = value;
              priceRangeValue.textContent = `R$ ${value}`;
            }
          });
        }

        if (maxPriceInput) {
          maxPriceInput.addEventListener("change", function () {
            const value = parseInt(this.value) || 1000;
            currentFilters.maxPrice = value;
            if (priceRangeSlider) {
              priceRangeSlider.value = value;
              priceRangeValue.textContent = `R$ ${value}`;
            }
          });
        }

        // Carregar categorias no modal
        if (filterCategoriesGrid && allCategories && allCategories.length > 0) {
          const sortedCategories = [...allCategories].sort((a, b) =>
            a.name.localeCompare(b.name),
          );

          filterCategoriesGrid.innerHTML = sortedCategories
            .map((category) => {
              const productsInCategory = allProducts.filter(
                (p) =>
                  (p.category_id &&
                    p.category_id.toString() === category.id.toString()) ||
                  (p.category &&
                    p.category.toLowerCase() === category.name.toLowerCase()),
              ).length;

              return `
        <div class="filter-category" data-category-id="${category.id}">
          <input type="checkbox" name="category" value="${category.id}">
          <div class="filter-category-content">
            <div class="filter-category-icon">
              ${category.icon || '<i class="fas fa-tag"></i>'}
            </div>
            <div class="filter-category-text">
              <h5>${category.name}</h5>
              <span>${productsInCategory} produto(s)</span>
            </div>
          </div>
        </div>
      `;
            })
            .join("");

          // Adicionar event listeners para categorias
          document.querySelectorAll(".filter-category").forEach((category) => {
            category.addEventListener("click", function () {
              this.classList.toggle("selected");
              updateFiltersCount();
            });
          });
        }

        // Limpar busca
        if (searchClear && searchInput) {
          searchInput.addEventListener("input", function () {
            searchClear.style.display = this.value ? "block" : "none";
          });

          searchClear.addEventListener("click", function () {
            searchInput.value = "";
            searchClear.style.display = "none";
            currentFilters.searchTerm = "";
            applyFilters();
          });
        }
      }

      function applyAllFiltersFromModal() {
        // Coletar categorias selecionadas
        const selectedCategories = [];
        document.querySelectorAll(".filter-category.selected").forEach((cat) => {
          selectedCategories.push(cat.dataset.categoryId);
        });

        // Se nenhuma categoria selecionada, mostrar todas
        currentFilters.categories =
          selectedCategories.length > 0 ? selectedCategories : [];

        // Coletar ordena√ß√£o
        const selectedSort = document.querySelector('input[name="sortBy"]:checked');
        if (selectedSort) {
          currentFilters.sortBy = selectedSort.value;
        }

        // Coletar status
        const selectedStatus = [];
        document
          .querySelectorAll('input[name="status"]:checked')
          .forEach((status) => {
            selectedStatus.push(status.value);
          });
        currentFilters.status = selectedStatus;

        // Atualizar contador de filtros
        updateFiltersCount();

        // Aplicar filtros
        applyFilters();
      }

      function clearAllFiltersHandler() {
        // Resetar categorias
        document.querySelectorAll(".filter-category").forEach((cat) => {
          cat.classList.remove("selected");
        });

        // Resetar status
        document.querySelectorAll('input[name="status"]').forEach((status) => {
          status.checked = status.value === "in_stock";
        });

        // Resetar ordena√ß√£o
        document.querySelector('input[name="sortBy"][value="newest"]').checked = true;

        // Resetar pre√ßo
        const priceSlider = document.getElementById("priceRangeSlider");
        const minInput = document.getElementById("minPriceInput");
        const maxInput = document.getElementById("maxPriceInput");

        if (priceSlider) priceSlider.value = 1000;
        if (minInput) minInput.value = "";
        if (maxInput) maxInput.value = "";

        // Resetar vari√°veis
        currentFilters = {
          categories: [],
          minPrice: 0,
          maxPrice: 1000,
          sortBy: "newest",
          searchTerm: "",
          status: ["in_stock"],
        };

        // Atualizar UI
        updateFiltersCount();
        document.getElementById("priceRangeValue").textContent = "R$ 1000";
      }

      function updateFiltersCount() {
        const count = document.querySelectorAll(".filter-category.selected").length;
        const filterCountElement = document.getElementById("filterCount");
        if (filterCountElement) {
          filterCountElement.textContent = count;
          filterCountElement.style.display = count > 0 ? "inline-block" : "none";
        }
      }

      // ========== FUN√á√ïES AUXILIARES ==========
      function showNoProductsMessage() {
        document.getElementById("productsGrid").innerHTML = `
          <div class="no-products" style="grid-column: 1 / -1; text-align: center; padding: 60px;">
            <i class="fas fa-box-open fa-3x" style="color: #ddd; margin-bottom: 20px;"></i>
            <h3 style="color: #666; margin-bottom: 10px;">Cat√°logo vazio</h3>
            <p style="color: #888;">N√£o h√° produtos dispon√≠veis no momento.</p>
          </div>
        `;

        document.getElementById("productCount").textContent =
          "0 produtos encontrados";
        document.getElementById("pagination").style.display = "none";
        document.getElementById("featuredCategories").style.display = "none";
      }

      function showError(message) {
        document.getElementById("productsGrid").innerHTML = `
          <div class="error-message" style="grid-column: 1 / -1; text-align: center; padding: 60px;">
            <i class="fas fa-exclamation-triangle fa-3x" style="color: #f44336; margin-bottom: 20px;"></i>
            <h3 style="color: #666; margin-bottom: 10px;">Ops! Algo deu errado</h3>
            <p style="color: #888;">${message}</p>
            <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #7C3AED; color: white; border: none; border-radius: 8px; cursor: pointer;">
              <i class="fas fa-sync-alt"></i> Tentar novamente
            </button>
          </div>
        `;
      }

    async function addToCart(productId) {
      console.log("üõí Adicionando ao carrinho:", productId);
      try {
        // Usar cartManager se dispon√≠vel
        if (typeof cartManager !== 'undefined' && cartManager.addToCart) {
          const result = await cartManager.addToCart(productId);
          if (result.success) {
            showNotification('Produto adicionado ao carrinho!', 'success');
            cartManager.updateCartCount();
          } else {
            showNotification('Erro ao adicionar produto', 'error');
          }
        } else {
          // Fallback simples
          showNotification('Produto adicionado ao carrinho!', 'success');
          const cartCount = document.querySelector('.cart-count');
          cartCount.textContent = parseInt(cartCount.textContent || '0') + 1;
        }
      } catch (error) {
        console.error('Erro ao adicionar ao carrinho:', error);
        showNotification('Erro ao adicionar produto', 'error');
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#4CAF50' : '#2196F3'};
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        z-index: 10000;
        animation: slideIn 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      `;

      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
        <span style="margin-left: 10px;">${message}</span>
      `;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // ========== CONFIGURA√á√ÉO DE EVENTOS ==========
    function setupEventListeners() {
      // Pagina√ß√£o
      document.getElementById('prevBtn').addEventListener('click', () => {
        if (currentPage > 1) goToPage(currentPage - 1);
      });

      document.getElementById('nextBtn').addEventListener('click', () => {
        const totalPages = Math.ceil(filteredProducts.length / PRODUCTS_PER_PAGE);
        if (currentPage < totalPages) goToPage(currentPage + 1);
      });

      // Busca
      const searchInput = document.getElementById('searchInput');
      let searchTimeout;
      searchInput.addEventListener('input', function (e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          currentFilters.searchTerm = e.target.value;
          applyFilters();
        }, 500);
      });

      // Visualiza√ß√£o
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');

          const view = this.dataset.view;
          const grid = document.getElementById('productsGrid');
          grid.className = `products-grid ${view}-view`;

          if (view === 'list') {
            document.querySelectorAll('.product-card').forEach(card => {
              card.style.height = '200px';
            });
          } else {
            document.querySelectorAll('.product-card').forEach(card => {
              card.style.height = '420px';
            });
          }
        });
      });
    }

    // ========== INICIALIZA√á√ÉO ==========
    document.addEventListener('DOMContentLoaded', function () {
      console.log("üöÄ Cat√°logo iniciado");

      // Inicializar com timeout para garantir que config.js carregou
      setTimeout(() => {
        initializeCatalog();
      }, 100);

      // Setup scroll animation
      const revealElements = document.querySelectorAll('.reveal');
      function revealOnScroll() {
        const windowHeight = window.innerHeight;
        const revealPoint = 100;

        revealElements.forEach(element => {
          const revealTop = element.getBoundingClientRect().top;
          if (revealTop < windowHeight - revealPoint) {
            element.classList.add('active');
          }
        });
      }

      window.addEventListener('scroll', revealOnScroll);
      revealOnScroll();
    });

    // ========== FUN√á√ïES DO MODAL DE FILTROS (mantenha as existentes) ==========
    // As fun√ß√µes setupFiltersModal, applyAllFiltersFromModal, etc. permanecem iguais
    // Apenas certificar-se de que usam as vari√°veis globais atualizadas

  </script>

</body>

</html>